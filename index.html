1.	<!DOCTYPE html>
2.	<html lang="ru">
3.	<head>
4.	    <meta charset="UTF-8">
5.	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
6.	    <title>Управление данными</title>
7.	    <style>
8.	        * {
9.	            margin: 0;
10.	            padding: 0;
11.	            box-sizing: border-box;
12.	            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
13.	        }
14.	
15.	        /* ПЕРЕМЕННЫЕ ДЛЯ ТЕМЫ */
16.	        :root {
17.	            --bg-primary: #2f2f2f;
18.	            --bg-secondary: #252525;
19.	            --bg-tertiary: #4a4a4a;
20.	            --bg-dark-controls: #1a1a1a;
21.	            --accent-color: #e67e22;
22.	            --accent-hover: #d35400;
23.	            --text-primary: #ecf0f1;
24.	            --text-secondary: #bdc3c7;
25.	            --border-color: #4a4a4a;
26.	            --table-bg: #3a3a3a;
27.	            --table-border: #4a4a4a;
28.	            --table-header-bg: #1a1a1a;
29.	            --table-hover: #5a5a5a;
30.	        }
31.	
32.	        body {
33.	            background-color: var(--bg-primary);
34.	            color: var(--text-primary);
35.	            transition: all 0.3s ease;
36.	        }
37.	
38.	        #login-screen {
39.	            display: flex;
40.	            justify-content: center;
41.	            align-items: center;
42.	            height: 100vh;
43.	            background: linear-gradient(135deg, rgba(47, 47, 47, 0.8) 0%, rgba(37, 37, 37, 0.8) 100%), url('fon.jpg') no-repeat center center fixed;
44.	            background-size: cover;
45.	        }
46.	
47.	        @media (max-width: 1920px) {
48.	            #login-screen {
49.	                background-attachment: scroll;
50.	            }
51.	        }
52.	
53.	        .login-container {
54.	            background: var(--bg-secondary);
55.	            padding: 2.5rem;
56.	            border-radius: 12px;
57.	            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
58.	            width: 100%;
59.	            max-width: 420px;
60.	            border: 1px solid var(--border-color);
61.	        }
62.	
63.	        .login-container h2 {
64.	            margin-bottom: 1.8rem;
65.	            text-align: center;
66.	            color: var(--text-primary);
67.	            font-size: 1.8rem;
68.	            font-weight: 600;
69.	        }
70.	
71.	        .form-group {
72.	            margin-bottom: 1.2rem;
73.	        }
74.	
75.	        .form-group label {
76.	            display: block;
77.	            margin-bottom: 0.6rem;
78.	            color: var(--text-secondary);
79.	            font-weight: 500;
80.	            font-size: 0.95rem;
81.	        }
82.	
83.	        .form-group input, .form-group select {
84.	            width: 100%;
85.	            padding: 0.9rem;
86.	            border: 1px solid var(--border-color);
87.	            border-radius: 8px;
88.	            font-size: 1rem;
89.	            background: var(--bg-primary);
90.	            color: var(--text-primary);
91.	            transition: all 0.3s ease;
92.	        }
93.	
94.	        .form-group input:focus, .form-group select:focus {
95.	            outline: none;
96.	            border-color: var(--accent-color);
97.	            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
98.	        }
99.	
100.	        button {
101.	            padding: 0.9rem 1.5rem;
102.	            background: var(--accent-color);
103.	            color: white;
104.	            border: none;
105.	            border-radius: 8px;
106.	            font-size: 1rem;
107.	            font-weight: 600;
108.	            cursor: pointer;
109.	            transition: all 0.3s ease;
110.	            height: 48px;
111.	            display: flex;
112.	            align-items: center;
113.	            justify-content: center;
114.	            text-align: center;
115.	        }
116.	
117.	        button:hover {
118.	            background: var(--accent-hover);
119.	            transform: translateY(-1px);
120.	            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
121.	        }
122.	
123.	        #main-screen {
124.	            display: none;
125.	            height: 100vh;
126.	            flex-direction: column;
127.	            background: var(--bg-primary);
128.	        }
129.	
130.	        .header {
131.	            background: var(--bg-secondary);
132.	            padding: 0.8rem 1.5rem;
133.	            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
134.	            display: flex;
135.	            justify-content: space-between;
136.	            align-items: center;
137.	            height: 70px;
138.	            border-bottom: 1px solid var(--border-color);
139.	        }
140.	
141.	        .header-content {
142.	            display: flex;
143.	            align-items: center;
144.	            gap: 20px;
145.	        }
146.	
147.	        .logo {
148.	            height: 40px;
149.	            opacity: 0.9;
150.	            cursor: pointer;
151.	            border-radius: 6px;
152.	        }
153.	
154.	        .user-info {
155.	            display: flex;
156.	            align-items: center;
157.	            gap: 15px;
158.	        }
159.	
160.	        .user-name {
161.	            color: var(--text-primary);
162.	            font-weight: 500;
163.	            font-size: 0.95rem;
164.	        }
165.	
166.	        .user-role-btn {
167.	            background: var(--bg-tertiary);
168.	            color: var(--text-primary);
169.	            border: none;
170.	            padding: 0.5rem 1rem;
171.	            border-radius: 8px;
172.	            font-size: 0.9rem;
173.	            height: 35px;
174.	            display: flex;
175.	            align-items: center;
176.	            justify-content: center;
177.	            min-width: 120px;
178.	        }
179.	
180.	        #logout-btn.user-role-btn {
181.	            cursor: pointer;
182.	            background: var(--accent-color);
183.	        }
184.	
185.	        #logout-btn.user-role-btn:hover {
186.	            background: var(--accent-hover);
187.	        }
188.	
189.	        .status-bar-header {
190.	            background: var(--bg-tertiary);
191.	            color: var(--text-primary);
192.	            border: none;
193.	            padding: 0.5rem 1rem;
194.	            border-radius: 8px;
195.	            font-size: 0.8rem;
196.	            height: 35px;
197.	            display: flex;
198.	            align-items: center;
199.	            justify-content: center;
200.	            min-width: 200px;
201.	            max-width: 300px;
202.	            white-space: nowrap;
203.	            overflow: hidden;
204.	            text-overflow: ellipsis;
205.	            cursor: pointer;
206.	            transition: all 0.3s ease;
207.	            position: relative;
208.	        }
209.	
210.	        .status-bar-header:hover::after {
211.	            content: attr(data-tooltip);
212.	            position: absolute;
213.	            bottom: 100%;
214.	            left: 50%;
215.	            transform: translateX(-50%);
216.	            background: var(--bg-secondary);
217.	            color: var(--text-primary);
218.	            padding: 8px 12px;
219.	            border-radius: 6px;
220.	            font-size: 0.8rem;
221.	            white-space: nowrap;
222.	            z-index: 1000;
223.	            border: 1px solid var(--border-color);
224.	            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
225.	        }
226.	
227.	        .status-bar-header.syncing {
228.	            background: rgba(230, 126, 34, 0.3);
229.	            color: var(--accent-color);
230.	        }
231.	
232.	        .status-bar-header.success {
233.	            background: rgba(46, 204, 113, 0.2);
234.	            color: #2ecc71;
235.	        }
236.	
237.	        .status-bar-header.error {
238.	            background: rgba(231, 76, 60, 0.2);
239.	            color: #e74c3c;
240.	        }
241.	
242.	        .status-info-header {
243.	            display: flex;
244.	            align-items: center;
245.	            gap: 8px;
246.	            width: 100%;
247.	        }
248.	
249.	        .status-sync-header {
250.	            display: flex;
251.	            align-items: center;
252.	            gap: 5px;
253.	            flex: 1;
254.	            min-width: 0;
255.	        }
256.	
257.	        .sync-icon {
258.	            font-size: 0.9rem;
259.	            flex-shrink: 0;
260.	        }
261.	
262.	        .sync-text {
263.	            flex: 1;
264.	            overflow: hidden;
265.	            text-overflow: ellipsis;
266.	            white-space: nowrap;
267.	            font-weight: 500;
268.	        }
269.	
270.	        .top-controls-panel {
271.	            background: var(--bg-secondary);
272.	            border-bottom: 1px solid var(--border-color);
273.	            padding: 12px 20px;
274.	            display: flex;
275.	            align-items: center;
276.	            gap: 15px;
277.	            flex-wrap: nowrap;
278.	            height: 65px;
279.	            min-height: 65px;
280.	        }
281.	
282.	        .tabs-wrapper {
283.	            display: flex;
284.	            align-items: center;
285.	            flex: 0 1 auto;
286.	            position: relative;
287.	            height: 40px;
288.	            max-width: 60%;
289.	            min-width: 200px;
290.	        }
291.	
292.	        .tabs-scroll-btn {
293.	            background: var(--bg-tertiary);
294.	            border: none;
295.	            color: var(--text-primary);
296.	            width: 24px;
297.	            height: 24px;
298.	            border-radius: 4px;
299.	            cursor: pointer;
300.	            display: flex;
301.	            align-items: center;
302.	            justify-content: center;
303.	            font-size: 12px;
304.	            z-index: 2;
305.	            flex-shrink: 0;
306.	            transition: all 0.2s ease;
307.	        }
308.	
309.	        .tabs-scroll-btn:hover {
310.	            background: var(--table-hover);
311.	        }
312.	
313.	        .tabs-scroll-btn.left {
314.	            margin-right: 5px;
315.	        }
316.	
317.	        .tabs-scroll-btn.right {
318.	            margin-left: 5px;
319.	        }
320.	
321.	        .tabs-container {
322.	            display: flex;
323.	            align-items: center;
324.	            gap: 8px;
325.	            height: 40px;
326.	            overflow-x: auto;
327.	            -ms-overflow-style: none;
328.	            scrollbar-width: none;
329.	            scroll-behavior: smooth;
330.	            flex: 1;
331.	        }
332.	
333.	        .tabs-container::-webkit-scrollbar {
334.	            display: none;
335.	        }
336.	
337.	        .tab {
338.	            background: var(--bg-tertiary);
339.	            padding: 8px 16px;
340.	            border-radius: 8px;
341.	            cursor: pointer;
342.	            border: 1px solid var(--table-hover);
343.	            white-space: nowrap;
344.	            display: flex;
345.	            align-items: center;
346.	            justify-content: center;
347.	            gap: 8px;
348.	            transition: all 0.3s ease;
349.	            min-width: 140px;
350.	            height: 40px;
351.	            flex-shrink: 0;
352.	            text-align: center;
353.	        }
354.	
355.	        .tab.active {
356.	            background: var(--accent-color);
357.	            color: white;
358.	            border-color: var(--accent-color);
359.	        }
360.	
361.	        .tab.editable {
362.	            cursor: text;
363.	            border: 1px dashed transparent;
364.	        }
365.	
366.	        .tab.editable:hover {
367.	            border-color: var(--accent-color);
368.	            background: var(--bg-secondary);
369.	        }
370.	
371.	        .tab.editable:focus {
372.	            outline: none;
373.	            border-color: var(--accent-color);
374.	            background: var(--bg-primary);
375.	            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
376.	        }
377.	
378.	        .tab-close {
379.	            background: none;
380.	            border: none;
381.	            color: inherit;
382.	            cursor: pointer;
383.	            padding: 4px;
384.	            border-radius: 4px;
385.	            font-size: 14px;
386.	            width: 20px;
387.	            height: 20px;
388.	            display: flex;
389.	            align-items: center;
390.	            justify-content: center;
391.	            transition: all 0.2s ease;
392.	        }
393.	
394.	        .tab-close:hover {
395.	            background: rgba(255,255,255,0.2);
396.	            transform: scale(1.1);
397.	        }
398.	
399.	        .controls-group {
400.	            display: flex;
401.	            align-items: center;
402.	            gap: 12px;
403.	            margin-left: auto;
404.	            flex-shrink: 0;
405.	            flex-wrap: nowrap;
406.	            min-width: 40%;
407.	            justify-content: flex-end;
408.	        }
409.	
410.	        .new-tab-btn {
411.	            background: var(--accent-color);
412.	            color: white;
413.	            border: none;
414.	            padding: 8px 16px;
415.	            border-radius: 8px;
416.	            cursor: pointer;
417.	            white-space: nowrap;
418.	            font-size: 0.9rem;
419.	            height: 40px;
420.	            display: flex;
421.	            align-items: center;
422.	            justify-content: center;
423.	            gap: 6px;
424.	            text-align: center;
425.	        }
426.	
427.	        .new-tab-btn:hover {
428.	            background: var(--accent-hover);
429.	        }
430.	
431.	        .search-container {
432.	            display: flex;
433.	            align-items: center;
434.	            gap: 8px;
435.	            background: var(--bg-dark-controls);
436.	            border: 1px solid var(--border-color);
437.	            border-radius: 8px;
438.	            padding: 6px 12px;
439.	            min-width: 240px;
440.	            height: 40px;
441.	            flex-shrink: 0;
442.	        }
443.	
444.	        .search-input {
445.	            border: none;
446.	            outline: none;
447.	            flex: 1;
448.	            padding: 6px;
449.	            font-size: 0.9rem;
450.	            background: transparent;
451.	            color: var(--text-primary);
452.	        }
453.	
454.	        .search-input::placeholder {
455.	            color: var(--text-secondary);
456.	        }
457.	
458.	        .search-clear {
459.	            background: none;
460.	            border: none;
461.	            cursor: pointer;
462.	            color: var(--text-secondary);
463.	            padding: 4px 6px;
464.	            font-size: 0.8rem;
465.	            border-radius: 4px;
466.	            transition: all 0.2s ease;
467.	        }
468.	
469.	        .search-clear:hover {
470.	            background: var(--bg-tertiary);
471.	            color: var(--text-primary);
472.	        }
473.	
474.	        .filter-selected-btn {
475.	            background: var(--bg-tertiary);
476.	            color: var(--text-primary);
477.	            border: none;
478.	            padding: 8px 16px;
479.	            border-radius: 8px;
480.	            cursor: pointer;
481.	            white-space: nowrap;
482.	            font-size: 0.9rem;
483.	            height: 40px;
484.	            display: flex;
485.	            align-items: center;
486.	            justify-content: center;
487.	            gap: 6px;
488.	            text-align: center;
489.	            transition: all 0.3s ease;
490.	        }
491.	
492.	        .filter-selected-btn:hover {
493.	            background: var(--table-hover);
494.	        }
495.	
496.	        .export-excel-btn {
497.	            background: var(--bg-dark-controls);
498.	            color: var(--text-primary);
499.	            border: none;
500.	            padding: 8px 16px;
501.	            border-radius: 8px;
502.	            cursor: pointer;
503.	            white-space: nowrap;
504.	            font-size: 0.9rem;
505.	            height: 40px;
506.	            display: flex;
507.	            align-items: center;
508.	            justify-content: center;
509.	            gap: 6px;
510.	            text-align: center;
511.	            transition: all 0.3s ease;
512.	        }
513.	
514.	        .export-excel-btn:hover {
515.	            background: var(--table-hover);
516.	        }
517.	
518.	        .import-excel-btn {
519.	            background: var(--bg-dark-controls);
520.	            color: var(--text-primary);
521.	            border: none;
522.	            padding: 8px 16px;
523.	            border-radius: 8px;
524.	            cursor: pointer;
525.	            white-space: nowrap;
526.	            font-size: 0.9rem;
527.	            height: 40px;
528.	            display: flex;
529.	            align-items: center;
530.	            justify-content: center;
531.	            gap: 6px;
532.	            text-align: center;
533.	            transition: all 0.3s ease;
534.	        }
535.	
536.	        .import-excel-btn:hover {
537.	            background: var(--table-hover);
538.	        }
539.	
540.	        .container {
541.	            display: flex;
542.	            height: calc(100vh - 135px);
543.	        }
544.	
545.	        .sidebar {
546.	            width: 280px;
547.	            background: var(--bg-secondary);
548.	            color: white;
549.	            padding: 1.2rem;
550.	            overflow-y: auto;
551.	            display: flex;
552.	            flex-direction: column;
553.	            border-right: 1px solid var(--border-color);
554.	        }
555.	
556.	        .sidebar-buttons {
557.	            flex: 1;
558.	            overflow-y: auto;
559.	            padding-right: 8px;
560.	        }
561.	
562.	        .sidebar-buttons::-webkit-scrollbar {
563.	            width: 6px;
564.	        }
565.	
566.	        .sidebar-buttons::-webkit-scrollbar-track {
567.	            background: var(--bg-primary);
568.	            border-radius: 3px;
569.	        }
570.	
571.	        .sidebar-buttons::-webkit-scrollbar-thumb {
572.	            background: var(--bg-tertiary);
573.	            border-radius: 3px;
574.	        }
575.	
576.	        .sidebar-buttons::-webkit-scrollbar-thumb:hover {
577.	            background: var(--table-hover);
578.	        }
579.	
580.	        .sidebar-bottom {
581.	            margin-top: auto;
582.	            border-top: 1px solid var(--border-color);
583.	            padding-top: 1.2rem;
584.	        }
585.	
586.	        .sidebar button {
587.	            margin-bottom: 4px;
588.	            background: var(--bg-tertiary);
589.	            width: 100%;
590.	            height: 40px;
591.	            display: flex;
592.	            align-items: center;
593.	            justify-content: center;
594.	            position: relative;
595.	            border-radius: 8px;
596.	            font-weight: 500;
597.	            font-size: 0.9rem;
598.	            transition: all 0.3s ease;
599.	            text-align: center;
600.	            padding: 0 15px;
601.	        }
602.	
603.	        .sidebar button:hover {
604.	            background: var(--accent-color);
605.	            transform: scale(1.05);
606.	            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
607.	        }
608.	
609.	        .custom-button-wrapper {
610.	            margin-bottom: 4px;
611.	            display: flex;
612.	            gap: 4px;
613.	            align-items: center;
614.	        }
615.	
616.	        .custom-button {
617.	            display: flex;
618.	            justify-content: space-between;
619.	            align-items: center;
620.	            padding: 0;
621.	            background: var(--bg-tertiary);
622.	            border: none;
623.	            border-radius: 8px;
624.	            color: white;
625.	            flex: 1;
626.	            height: 40px;
627.	            cursor: pointer;
628.	            transition: all 0.3s ease;
629.	            text-align: center;
630.	        }
631.	
632.	        .custom-button:hover {
633.	            background: var(--accent-color);
634.	            transform: scale(1.05);
635.	            box-shadow: 0 5px 15px rgba(230, 126, 34, 0.3);
636.	        }
637.	
638.	        .button-text {
639.	            flex: 1;
640.	            text-align: center;
641.	            padding: 0 12px;
642.	            font-weight: 500;
643.	            font-size: 0.9rem;
644.	        }
645.	
646.	        .button-actions {
647.	            display: flex;
648.	            gap: 4px;
649.	            flex-shrink: 0;
650.	        }
651.	
652.	        .btn-edit-small {
653.	            background: var(--bg-tertiary);
654.	            padding: 0.3rem 0.6rem;
655.	            font-size: 0.8rem;
656.	            border-radius: 5px;
657.	            border: none;
658.	            color: var(--text-primary);
659.	            cursor: pointer;
660.	            height: 40px;
661.	            width: 36px;
662.	            display: flex;
663.	            align-items: center;
664.	            justify-content: center;
665.	            transition: all 0.2s ease;
666.	        }
667.	
668.	        .btn-edit-small:hover {
669.	            background: var(--table-hover);
670.	        }
671.	
672.	        .btn-danger-small {
673.	            background: var(--bg-tertiary);
674.	            padding: 0.3rem 0.6rem;
675.	            font-size: 0.8rem;
676.	            border-radius: 5px;
677.	            border: none;
678.	            color: var(--text-primary);
679.	            cursor: pointer;
680.	            height: 40px;
681.	            width: 36px;
682.	            display: flex;
683.	            align-items: center;
684.	            justify-content: center;
685.	            transition: all 0.2s ease;
686.	        }
687.	
688.	        .btn-danger-small:hover {
689.	            background: var(--table-hover);
690.	        }
691.	
692.	        .content {
693.	            flex: 1;
694.	            padding: 1.2rem;
695.	            overflow: auto;
696.	            position: relative;
697.	            background: var(--bg-secondary);
698.	        }
699.	
700.	        .table-container {
701.	            position: relative;
702.	            overflow: auto;
703.	            height: 100%;
704.	            background: var(--table-bg);
705.	            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
706.	            border-radius: 12px;
707.	            border: 1px solid var(--table-border);
708.	        }
709.	
710.	        .table-container::-webkit-scrollbar {
711.	            width: 10px;
712.	            height: 10px;
713.	        }
714.	
715.	        .table-container::-webkit-scrollbar-track {
716.	            background: var(--bg-primary);
717.	            border-radius: 5px;
718.	        }
719.	
720.	        .table-container::-webkit-scrollbar-thumb {
721.	            background: var(--bg-tertiary);
722.	            border-radius: 5px;
723.	        }
724.	
725.	        .table-container::-webkit-scrollbar-thumb:hover {
726.	            background: var(--table-hover);
727.	        }
728.	
729.	        .table-container {
730.	            scrollbar-width: thin;
731.	            scrollbar-color: var(--bg-tertiary) var(--bg-primary);
732.	        }
733.	
734.	        table {
735.	            width: 100%;
736.	            border-collapse: collapse;
737.	            background: var(--table-bg);
738.	        }
739.	
740.	        th, td {
741.	            border: 1px solid var(--table-border);
742.	            padding: 0.4rem;
743.	            text-align: center;
744.	            position: relative;
745.	            color: var(--text-primary);
746.	            font-size: 0.85rem;
747.	        }
748.	
749.	        th {
750.	            background: var(--table-header-bg);
751.	            position: sticky;
752.	            top: 0;
753.	            z-index: 10;
754.	            cursor: pointer;
755.	            user-select: none;
756.	            padding: 8px 6px;
757.	            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
758.	            font-weight: 600;
759.	            font-size: 0.9rem;
760.	            color: var(--text-primary);
761.	            border: 1px solid #333 !important;
762.	        }
763.	
764.	        th:first-child {
765.	            min-width: 50px;
766.	            max-width: 60px;
767.	            width: 50px;
768.	        }
769.	
770.	        th:nth-child(2) {
771.	            min-width: 70px;
772.	            max-width: 80px;
773.	            width: 70px;
774.	        }
775.	
776.	        th:last-child {
777.	            min-width: 120px;
778.	            max-width: 200px;
779.	            width: auto;
780.	        }
781.	
782.	        th.actions-header {
783.	            background: var(--table-header-bg);
784.	            position: sticky;
785.	            top: 0;
786.	            z-index: 10;
787.	            padding: 8px 4px;
788.	            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
789.	            font-weight: 600;
790.	            font-size: 0.9rem;
791.	            color: var(--text-secondary);
792.	            border: 1px solid #333 !important;
793.	        }
794.	
795.	        th.actions-header .th-title {
796.	            color: var(--text-secondary);
797.	            font-size: 16px;
798.	            font-weight: bold;
799.	        }
800.	
801.	        th.editable-header:hover {
802.	            background: var(--table-hover);
803.	        }
804.	
805.	        tr:hover {
806.	            background: var(--table-hover);
807.	        }
808.	
809.	        .editable {
810.	            cursor: pointer;
811.	            transition: background-color 0.2s;
812.	            position: relative;
813.	        }
814.	
815.	        .editable:hover {
816.	            background-color: var(--table-hover);
817.	        }
818.	
819.	        .row-checkbox {
820.	            width: 18px;
821.	            height: 18px;
822.	            cursor: pointer;
823.	        }
824.	
825.	        .select-all-checkbox {
826.	            width: 18px;
827.	            height: 18px;
828.	            cursor: pointer;
829.	        }
830.	
831.	        .delete-row-btn {
832.	            background: var(--bg-tertiary);
833.	            color: var(--text-secondary);
834.	            border: none;
835.	            border-radius: 5px;
836.	            padding: 4px 6px;
837.	            font-size: 12px;
838.	            cursor: pointer;
839.	            transition: all 0.3s ease;
840.	            height: 24px;
841.	            display: flex;
842.	            align-items: center;
843.	            justify-content: center;
844.	            width: 24px;
845.	            text-align: center;
846.	        }
847.	
848.	        .delete-row-btn:hover {
849.	            background: var(--table-hover);
850.	            color: var(--text-primary);
851.	        }
852.	
853.	        .date-cell-warning {
854.	            background-color: rgba(230, 126, 34, 0.2) !important;
855.	            border: 1px solid var(--accent-color) !important;
856.	            color: var(--text-primary) !important;
857.	        }
858.	
859.	        .date-cell-danger {
860.	            background-color: rgba(230, 126, 34, 0.4) !important;
861.	            border: 1px solid var(--accent-hover) !important;
862.	            color: var(--text-primary) !important;
863.	        }
864.	
865.	        .date-cell-normal {
866.	            border: 1px solid var(--table-border) !important;
867.	            color: var(--text-primary) !important;
868.	        }
869.	
870.	        .date-picker {
871.	            position: fixed;
872.	            background: var(--bg-secondary);
873.	            border: 1px solid var(--border-color);
874.	            border-radius: 8px;
875.	            padding: 12px;
876.	            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
877.	            z-index: 10000;
878.	            min-width: 280px;
879.	            color: var(--text-primary);
880.	        }
881.	
882.	        .date-picker-header {
883.	            display: flex;
884.	            justify-content: space-between;
885.	            align-items: center;
886.	            margin-bottom: 12px;
887.	            padding: 6px;
888.	        }
889.	
890.	        .month-nav-btn {
891.	            background: var(--bg-tertiary);
892.	            border: none;
893.	            font-size: 16px;
894.	            cursor: pointer;
895.	            padding: 6px 12px;
896.	            border-radius: 5px;
897.	            color: var(--text-primary);
898.	            transition: all 0.2s ease;
899.	        }
900.	
901.	        .month-nav-btn:hover {
902.	            background: var(--accent-color) !important;
903.	            color: white;
904.	        }
905.	
906.	        .date-picker-grid {
907.	            display: grid;
908.	            grid-template-columns: repeat(7, 1fr);
909.	            gap: 3px;
910.	        }
911.	
912.	        .date-picker-day {
913.	            padding: 10px 6px;
914.	            text-align: center;
915.	            cursor: pointer;
916.	            border-radius: 5px;
917.	            border: none;
918.	            background: var(--bg-tertiary);
919.	            color: var(--text-primary);
920.	            transition: all 0.2s ease;
921.	        }
922.	
923.	        .date-picker-day:hover {
924.	            background: var(--accent-color) !important;
925.	            color: white;
926.	        }
927.	
928.	        .date-picker-day.selected {
929.	            background: var(--accent-color);
930.	            color: white;
931.	        }
932.	
933.	        .date-picker-day.today {
934.	            background: var(--bg-tertiary);
935.	            font-weight: bold;
936.	        }
937.	
938.	        .notification-panel {
939.	            position: fixed;
940.	            top: 20px;
941.	            right: 20px;
942.	            width: 420px;
943.	            background: var(--bg-secondary);
944.	            border: 1px solid var(--border-color);
945.	            border-radius: 10px;
946.	            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
947.	            z-index: 10000;
948.	            max-height: 80vh;
949.	            overflow-y: auto;
950.	        }
951.	
952.	        .notification-header {
953.	            background: var(--bg-tertiary);
954.	            color: var(--text-primary);
955.	            padding: 14px 18px;
956.	            border-radius: 10px 10px 0 0;
957.	            display: flex;
958.	            justify-content: space-between;
959.	            align-items: center;
960.	        }
961.	
962.	        .notification-content {
963.	            padding: 18px;
964.	        }
965.	
966.	        .notification-item {
967.	            padding: 12px;
968.	            margin-bottom: 10px;
969.	            border-radius: 6px;
970.	            border-left: 4px solid var(--bg-tertiary);
971.	            background: var(--bg-primary);
972.	        }
973.	
974.	        .notification-item.warning {
975.	            border-left-color: var(--accent-color);
976.	            background: rgba(230, 126, 34, 0.2);
977.	        }
978.	
979.	        .notification-item.danger {
980.	            border-left-color: var(--accent-hover);
981.	            background: rgba(211, 84, 0, 0.3);
982.	        }
983.	
984.	        .close-notifications {
985.	            background: none;
986.	            border: none;
987.	            color: var(--text-primary);
988.	            font-size: 20px;
989.	            cursor: pointer;
990.	            padding: 4px;
991.	            border-radius: 4px;
992.	            transition: all 0.2s ease;
993.	        }
994.	
995.	        .close-notifications:hover {
996.	            background: rgba(255,255,255,0.2);
997.	        }
998.	
999.	        .cell-content {
1000.	            display: flex;
1001.	            align-items: center;
1002.	            justify-content: space-between;
1003.	            min-height: 20px;
1004.	        }
1005.	
1006.	        .cell-text {
1007.	            flex: 1;
1008.	            overflow: hidden;
1009.	            text-overflow: ellipsis;
1010.	            white-space: nowrap;
1011.	            padding: 0 4px;
1012.	        }
1013.	
1014.	        .file-icons {
1015.	            display: flex;
1016.	            gap: 4px;
1017.	            flex-shrink: 0;
1018.	        }
1019.	
1020.	        .file-icon-small {
1021.	            width: 20px;
1022.	            height: 20px;
1023.	            font-size: 10px;
1024.	            display: flex;
1025.	            align-items: center;
1026.	            justify-content: center;
1027.	            border-radius: 4px;
1028.	            cursor: pointer;
1029.	            transition: all 0.2s ease;
1030.	            background: var(--bg-tertiary);
1031.	            border: 1px solid var(--table-border);
1032.	            color: var(--text-secondary);
1033.	            text-align: center;
1034.	        }
1035.	
1036.	        .file-icon-small:hover {
1037.	            background: var(--table-hover);
1038.	            color: var(--text-primary);
1039.	        }
1040.	
1041.	        .th-content {
1042.	            display: flex;
1043.	            flex-direction: column;
1044.	            height: 100%;
1045.	        }
1046.	
1047.	        .th-main {
1048.	            display: flex;
1049.	            justify-content: space-between;
1050.	            align-items: center;
1051.	            min-height: 20px;
1052.	        }
1053.	
1054.	        .th-title {
1055.	            flex: 1;
1056.	            overflow: hidden;
1057.	            text-overflow: ellipsis;
1058.	            white-space: nowrap;
1059.	            padding: 2px 4px;
1060.	            font-weight: 600;
1061.	            font-size: 0.85rem;
1062.	            color: var(--text-primary);
1063.	            text-align: center;
1064.	        }
1065.	
1066.	        .filter-controls {
1067.	            display: flex;
1068.	            align-items: center;
1069.	            gap: 3px;
1070.	            flex-shrink: 0;
1071.	        }
1072.	
1073.	        .sort-btn {
1074.	            background: none;
1075.	            border: none;
1076.	            cursor: pointer;
1077.	            padding: 3px;
1078.	            border-radius: 3px;
1079.	            color: var(--text-secondary);
1080.	            font-size: 13px;
1081.	            width: 18px;
1082.	            height: 18px;
1083.	            display: flex;
1084.	            align-items: center;
1085.	            justify-content: center;
1086.	            transition: all 0.2s ease;
1087.	        }
1088.	
1089.	        .sort-btn:hover {
1090.	            background: var(--table-hover);
1091.	            color: var(--text-primary);
1092.	        }
1093.	
1094.	        .filter-btn {
1095.	            background: none;
1096.	            border: none;
1097.	            cursor: pointer;
1098.	            padding: 3px;
1099.	            border-radius: 3px;
1100.	            color: var(--text-secondary);
1101.	            font-size: 13px;
1102.	            width: 18px;
1103.	            height: 18px;
1104.	            display: flex;
1105.	            align-items: center;
1106.	            justify-content: center;
1107.	            transition: all 0.2s ease;
1108.	        }
1109.	
1110.	        .filter-btn:hover {
1111.	            background: var(--table-hover);
1112.	            color: var(--text-primary);
1113.	        }
1114.	
1115.	        .filter-btn.active {
1116.	            background: var(--table-hover);
1117.	            color: var(--text-primary);
1118.	        }
1119.	
1120.	        .filter-btn.filtered {
1121.	            color: var(--accent-color);
1122.	        }
1123.	
1124.	        .filter-dropdown {
1125.	            position: fixed;
1126.	            top: 0;
1127.	            left: 0;
1128.	            background: var(--bg-secondary);
1129.	            border: 1px solid var(--border-color);
1130.	            border-radius: 6px;
1131.	            padding: 10px;
1132.	            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
1133.	            z-index: 10000;
1134.	            min-width: 240px;
1135.	            max-width: 320px;
1136.	            max-height: 420px;
1137.	            overflow: hidden;
1138.	            font-family: 'Segoe UI', sans-serif;
1139.	            font-size: 14px;
1140.	            color: var(--text-primary);
1141.	        }
1142.	
1143.	        .filter-header {
1144.	            display: flex;
1145.	            justify-content: space-between;
1146.	            align-items: center;
1147.	            margin-bottom: 10px;
1148.	            padding-bottom: 8px;
1149.	            border-bottom: 1px solid var(--border-color);
1150.	        }
1151.	
1152.	        .filter-title {
1153.	            font-weight: 600;
1154.	            color: var(--text-primary);
1155.	            font-size: 14px;
1156.	        }
1157.	
1158.	        .filter-close {
1159.	            background: none;
1160.	            border: none;
1161.	            cursor: pointer;
1162.	            font-size: 18px;
1163.	            color: var(--text-secondary);
1164.	            padding: 0;
1165.	            width: 24px;
1166.	            height: 24px;
1167.	            display: flex;
1168.	            align-items: center;
1169.	            justify-content: center;
1170.	            border-radius: 3px;
1171.	            transition: all 0.2s ease;
1172.	        }
1173.	
1174.	        .filter-close:hover {
1175.	            background: var(--bg-tertiary);
1176.	            color: var(--text-primary);
1177.	        }
1178.	
1179.	        .filter-search {
1180.	            width: 100%;
1181.	            padding: 8px 10px;
1182.	            margin-bottom: 10px;
1183.	            border: 1px solid var(--border-color);
1184.	            border-radius: 5px;
1185.	            font-size: 13px;
1186.	            outline: none;
1187.	            background: var(--bg-primary);
1188.	            color: var(--text-primary);
1189.	        }
1190.	
1191.	        .filter-search:focus {
1192.	            border-color: var(--accent-color);
1193.	            box-shadow: 0 0 0 2px rgba(230, 126, 34, 0.2);
1194.	        }
1195.	
1196.	        .filter-search::placeholder {
1197.	            color: var(--text-secondary);
1198.	        }
1199.	
1200.	        .filter-options {
1201.	            max-height: 220px;
1202.	            overflow-y: auto;
1203.	            border: 1px solid var(--border-color);
1204.	            border-radius: 5px;
1205.	            margin-bottom: 10px;
1206.	            background: var(--bg-primary);
1207.	        }
1208.	
1209.	        .filter-options::-webkit-scrollbar {
1210.	            width: 8px;
1211.	        }
1212.	
1213.	        .filter-options::-webkit-scrollbar-track {
1214.	            background: var(--bg-secondary);
1215.	            border-radius: 4px;
1216.	        }
1217.	
1218.	        .filter-options::-webkit-scrollbar-thumb {
1219.	            background: var(--bg-tertiary);
1220.	            border-radius: 4px;
1221.	        }
1222.	
1223.	        .filter-options::-webkit-scrollbar-thumb:hover {
1224.	            background: var(--table-hover);
1225.	        }
1226.	
1227.	        .filter-option {
1228.	            display: flex;
1229.	            align-items: center;
1230.	            gap: 8px;
1231.	            padding: 8px 10px;
1232.	            font-size: 13px;
1233.	            cursor: pointer;
1234.	            transition: background-color 0.1s;
1235.	            border-bottom: 1px solid var(--bg-secondary);
1236.	        }
1237.	
1238.	        .filter-option:hover {
1239.	            background-color: var(--bg-tertiary);
1240.	        }
1241.	
1242.	        .filter-option input[type="checkbox"] {
1243.	            margin: 0;
1244.	            width: 16px;
1245.	            height: 16px;
1246.	            cursor: pointer;
1247.	        }
1248.	
1249.	        .filter-option label {
1250.	            cursor: pointer;
1251.	            flex: 1;
1252.	            overflow: hidden;
1253.	            text-overflow: ellipsis;
1254.	            white-space: nowrap;
1255.	        }
1256.	
1257.	        .filter-actions {
1258.	            display: flex;
1259.	            justify-content: space-between;
1260.	            gap: 8px;
1261.	        }
1262.	
1263.	        .filter-actions button {
1264.	            flex: 1;
1265.	            padding: 8px 12px;
1266.	            font-size: 13px;
1267.	            border: 1px solid var(--border-color);
1268.	            background: var(--bg-tertiary);
1269.	            color: var(--text-primary);
1270.	            border-radius: 5px;
1271.	            cursor: pointer;
1272.	            transition: all 0.2s ease;
1273.	            height: 36px;
1274.	            text-align: center;
1275.	        }
1276.	
1277.	        .filter-actions button:hover {
1278.	            background: var(--table-hover);
1279.	            border-color: var(--table-hover);
1280.	        }
1281.	
1282.	        .filter-actions .btn-primary {
1283.	            background: var(--bg-tertiary);
1284.	            color: var(--text-primary);
1285.	            border-color: var(--border-color);
1286.	        }
1287.	
1288.	        .filter-actions .btn-primary:hover {
1289.	            background: var(--table-hover);
1290.	            border-color: var(--table-hover);
1291.	        }
1292.	
1293.	        .filter-count {
1294.	            font-size: 12px;
1295.	            color: var(--text-secondary);
1296.	            margin-bottom: 8px;
1297.	        }
1298.	
1299.	        .sort-indicator {
1300.	            margin-left: 4px;
1301.	            font-size: 11px;
1302.	        }
1303.	
1304.	        .sort-asc .sort-indicator::after {
1305.	            content: "↑";
1306.	        }
1307.	
1308.	        .sort-desc .sort-indicator::after {
1309.	            content: "↓";
1310.	        }
1311.	
1312.	        .modal {
1313.	            display: none;
1314.	            position: fixed;
1315.	            top: 0;
1316.	            left: 0;
1317.	            width: 100%;
1318.	            height: 100%;
1319.	            background: rgba(0, 0, 0, 0.7);
1320.	            justify-content: center;
1321.	            align-items: center;
1322.	            z-index: 1000;
1323.	        }
1324.	
1325.	        .modal-content {
1326.	            background: var(--bg-secondary);
1327.	            padding: 2.5rem;
1328.	            border-radius: 12px;
1329.	            width: 90%;
1330.	            max-width: 850px;
1331.	            max-height: 90vh;
1332.	            overflow-y: auto;
1333.	            border: 1px solid var(--border-color);
1334.	            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
1335.	        }
1336.	
1337.	        .modal-header {
1338.	            display: flex;
1339.	            justify-content: space-between;
1340.	            align-items: center;
1341.	            margin-bottom: 1.8rem;
1342.	            padding-bottom: 1rem;
1343.	            border-bottom: 1px solid var(--border-color);
1344.	        }
1345.	
1346.	        .modal-header h3 {
1347.	            color: var(--text-primary);
1348.	            font-size: 1.5rem;
1349.	            font-weight: 600;
1350.	        }
1351.	
1352.	        .close {
1353.	            font-size: 1.8rem;
1354.	            cursor: pointer;
1355.	            color: var(--text-secondary);
1356.	            padding: 5px;
1357.	            border-radius: 4px;
1358.	            transition: all 0.2s ease;
1359.	        }
1360.	
1361.	        .close:hover {
1362.	            color: var(--text-primary);
1363.	            background: var(--bg-tertiary);
1364.	        }
1365.	
1366.	        .form-row {
1367.	            display: flex;
1368.	            gap: 12px;
1369.	            margin-bottom: 1.2rem;
1370.	        }
1371.	
1372.	        .form-row input {
1373.	            flex: 1;
1374.	            padding: 0.9rem;
1375.	            border: 1px solid var(--border-color);
1376.	            border-radius: 8px;
1377.	            background: var(--bg-primary);
1378.	            color: var(--text-primary);
1379.	        }
1380.	
1381.	        .admin-only {
1382.	            display: none;
1383.	        }
1384.	
1385.	        .admin .admin-only {
1386.	            display: block;
1387.	        }
1388.	
1389.	        .user-only {
1390.	            display: block;
1391.	        }
1392.	
1393.	        .admin .user-only {
1394.	            display: none;
1395.	        }
1396.	
1397.	        .user-list {
1398.	            margin-top: 1.2rem;
1399.	        }
1400.	
1401.	        .user-item {
1402.	            display: flex;
1403.	            justify-content: space-between;
1404.	            align-items: center;
1405.	            padding: 1rem;
1406.	            border: 1px solid var(--border-color);
1407.	            border-radius: 8px;
1408.	            margin-bottom: 0.8rem;
1409.	            background: var(--bg-primary);
1410.	        }
1411.	
1412.	        .user-actions {
1413.	            display: flex;
1414.	            gap: 6px;
1415.	        }
1416.	
1417.	        .btn-danger {
1418.	            background: var(--bg-tertiary);
1419.	        }
1420.	
1421.	        .btn-danger:hover {
1422.	            background: var(--table-hover);
1423.	        }
1424.	
1425.	        .btn-edit {
1426.	            background: var(--bg-tertiary);
1427.	        }
1428.	
1429.	        .btn-edit:hover {
1430.	            background: var(--table-hover);
1431.	        }
1432.	
1433.	        .file-upload-area {
1434.	            border: 2px dashed var(--border-color);
1435.	            padding: 1.5rem;
1436.	            text-align: center;
1437.	            margin-bottom: 1.2rem;
1438.	            cursor: pointer;
1439.	            transition: all 0.3s ease;
1440.	            border-radius: 8px;
1441.	            background: var(--bg-primary);
1442.	        }
1443.	
1444.	        .file-upload-area:hover {
1445.	            border-color: var(--accent-color);
1446.	            background: var(--bg-secondary);
1447.	        }
1448.	
1449.	        .attached-files {
1450.	            margin-top: 1.2rem;
1451.	        }
1452.	
1453.	        .attached-file {
1454.	            display: flex;
1455.	            justify-content: space-between;
1456.	            align-items: center;
1457.	            padding: 0.8rem;
1458.	            background: var(--bg-primary);
1459.	            border-radius: 6px;
1460.	            margin-bottom: 0.6rem;
1461.	            border: 1px solid var(--border-color);
1462.	        }
1463.	
1464.	        .edit-cell-content {
1465.	            min-height: 120px;
1466.	            border: 1px solid var(--border-color);
1467.	            border-radius: 8px;
1468.	            padding: 0.9rem;
1469.	            margin-bottom: 1.2rem;
1470.	            width: 100%;
1471.	            resize: vertical;
1472.	            background: var(--bg-primary);
1473.	            color: var(--text-primary);
1474.	            font-family: inherit;
1475.	        }
1476.	
1477.	        .preview-content {
1478.	            text-align: center;
1479.	            margin: 1.2rem 0;
1480.	        }
1481.	
1482.	        .preview-image {
1483.	            max-width: 100%;
1484.	            max-height: 450px;
1485.	            border-radius: 8px;
1486.	            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
1487.	        }
1488.	
1489.	        .preview-document {
1490.	            width: 100%;
1491.	            height: 550px;
1492.	            border: 1px solid var(--border-color);
1493.	            border-radius: 8px;
1494.	        }
1495.	
1496.	        .preview-actions {
1497.	            display: flex;
1498.	            gap: 12px;
1499.	            justify-content: center;
1500.	            margin-top: 1.2rem;
1501.	        }
1502.	
1503.	        .preview-actions button {
1504.	            padding: 0.8rem 1.5rem;
1505.	        }
1506.	
1507.	        .btn-success {
1508.	            background: var(--bg-tertiary);
1509.	        }
1510.	
1511.	        .btn-success:hover {
1512.	            background: var(--table-hover);
1513.	        }
1514.	
1515.	        .btn-secondary {
1516.	            background: var(--bg-tertiary);
1517.	        }
1518.	
1519.	        .btn-secondary:hover {
1520.	            background: var(--table-hover);
1521.	        }
1522.	
1523.	        .file-info {
1524.	            text-align: center;
1525.	            margin-bottom: 1.2rem;
1526.	            padding: 1.2rem;
1527.	            background: var(--bg-primary);
1528.	            border-radius: 8px;
1529.	            border: 1px solid var(--border-color);
1530.	        }
1531.	
1532.	        #add-row-btn {
1533.	            position: fixed;
1534.	            left: 5px;
1535.	            bottom: 5px;
1536.	            width: 1px !important;
1537.	            height: 1px !important;
1538.	            min-width: 1px !important;
1539.	            min-height: 1px !important;
1540.	            padding: 0 !important;
1541.	            margin: 0 !important;
1542.	            font-size: 0 !important;
1543.	            opacity: 0.1;
1544.	            z-index: 9999;
1545.	            overflow: hidden;
1546.	            background: transparent !important;
1547.	            border: none !important;
1548.	            box-shadow: none !important;
1549.	        }
1550.	
1551.	        .admin #add-row-btn {
1552.	            position: static;
1553.	            width: 100% !important;
1554.	            height: 40px !important;
1555.	            min-width: auto !important;
1556.	            min-height: auto !important;
1557.	            padding: 0.9rem 1.5rem !important;
1558.	            margin-bottom: 4px !important;
1559.	            font-size: 1rem !important;
1560.	            opacity: 1;
1561.	            background: var(--accent-color) !important;
1562.	        }
1563.	
1564.	        .admin #add-row-btn:hover {
1565.	            background: var(--accent-hover) !important;
1566.	        }
1567.	
1568.	        .add-row-btn {
1569.	            background: var(--accent-color) !important;
1570.	        }
1571.	
1572.	        .add-row-btn:hover {
1573.	            background: var(--accent-hover) !important;
1574.	        }
1575.	
1576.	        .check-dates-btn {
1577.	            background: var(--accent-color) !important;
1578.	        }
1579.	
1580.	        .check-dates-btn:hover {
1581.	            background: var(--accent-hover) !important;
1582.	        }
1583.	
1584.	        .manage-users-btn {
1585.	            background: var(--accent-color) !important;
1586.	        }
1587.	
1588.	        .manage-users-btn:hover {
1589.	            background: var(--accent-hover) !important;
1590.	        }
1591.	
1592.	        .add-custom-button-btn {
1593.	            background: var(--accent-color) !important;
1594.	        }
1595.	
1596.	        .add-custom-button-btn:hover {
1597.	            background: var(--accent-hover) !important;
1598.	        }
1599.	
1600.	        .date-input-overlay {
1601.	            position: absolute;
1602.	            top: 0;
1603.	            left: 0;
1604.	            right: 0;
1605.	            bottom: 0;
1606.	            background: var(--bg-primary);
1607.	            display: flex;
1608.	            align-items: center;
1609.	            padding: 0 8px;
1610.	            z-index: 100;
1611.	            border-radius: 4px;
1612.	        }
1613.	
1614.	        .date-input {
1615.	            width: 100%;
1616.	            border: 2px solid var(--accent-color);
1617.	            border-radius: 5px;
1618.	            padding: 6px 8px;
1619.	            font-size: 14px;
1620.	            outline: none;
1621.	            background: var(--bg-primary);
1622.	            color: var(--text-primary);
1623.	        }
1624.	
1625.	        .header-title {
1626.	            cursor: default;
1627.	            font-size: 1.4rem;
1628.	            font-weight: 700;
1629.	            color: var(--text-primary);
1630.	        }
1631.	
1632.	        .header-title.editable {
1633.	            cursor: text;
1634.	            border: 1px dashed transparent;
1635.	            padding: 6px 12px;
1636.	            border-radius: 6px;
1637.	            transition: all 0.3s ease;
1638.	        }
1639.	
1640.	        .header-title.editable:hover {
1641.	            border-color: var(--accent-color);
1642.	            background: var(--bg-secondary);
1643.	        }
1644.	
1645.	        .header-title.editable:focus {
1646.	            outline: none;
1647.	            border-color: var(--accent-color);
1648.	            background: var(--bg-primary);
1649.	            box-shadow: 0 0 0 3px rgba(230, 126, 34, 0.2);
1650.	        }
1651.	
1652.	        .icon {
1653.	            font-size: 1.1em;
1654.	            color: var(--text-primary);
1655.	        }
1656.	
1657.	        .column-controls {
1658.	            position: fixed;
1659.	            bottom: 20px;
1660.	            right: 20px;
1661.	            display: flex;
1662.	            gap: 4px;
1663.	            z-index: 1000;
1664.	        }
1665.	
1666.	        .column-control-btn {
1667.	            background: var(--bg-secondary);
1668.	            border: 1px solid var(--border-color);
1669.	            border-radius: 4px;
1670.	            width: 28px;
1671.	            height: 28px;
1672.	            display: flex;
1673.	            align-items: center;
1674.	            justify-content: center;
1675.	            cursor: pointer;
1676.	            transition: all 0.3s ease;
1677.	            color: var(--text-primary);
1678.	            font-size: 12px;
1679.	            opacity: 0.3;
1680.	        }
1681.	
1682.	        .column-control-btn:hover {
1683.	            background: var(--bg-tertiary);
1684.	            opacity: 0.7;
1685.	        }
1686.	
1687.	        body:not(.admin) .column-controls {
1688.	            position: fixed;
1689.	            bottom: 10px;
1690.	            right: 10px;
1691.	            z-index: 1000;
1692.	        }
1693.	
1694.	        body:not(.admin) .column-control-btn {
1695.	            width: 1px;
1696.	            height: 1px;
1697.	            opacity: 0.01;
1698.	            position: absolute;
1699.	            bottom: 0;
1700.	            right: 0;
1701.	            overflow: hidden;
1702.	            pointer-events: auto;
1703.	        }
1704.	
1705.	        body:not(.admin) .column-control-btn:hover {
1706.	            background: transparent;
1707.	            opacity: 0.01;
1708.	        }
1709.	
1710.	        .fixed-columns-setting {
1711.	            position: fixed;
1712.	            bottom: 60px;
1713.	            right: 20px;
1714.	            background: var(--bg-secondary);
1715.	            border: 1px solid var(--border-color);
1716.	            border-radius: 6px;
1717.	            padding: 10px;
1718.	            z-index: 1000;
1719.	            color: var(--text-primary);
1720.	            font-size: 12px;
1721.	        }
1722.	
1723.	        .fixed-columns-setting input {
1724.	            width: 50px;
1725.	            background: var(--bg-primary);
1726.	            border: 1px solid var(--border-color);
1727.	            color: var(--text-primary);
1728.	            padding: 4px;
1729.	            border-radius: 3px;
1730.	            margin-left: 8px;
1731.	        }
1732.	
1733.	        .refresh-data-btn {
1734.	            background: var(--accent-color) !important;
1735.	        }
1736.	
1737.	        .refresh-data-btn:hover {
1738.	            background: var(--accent-hover) !important;
1739.	        }
1740.	
1741.	        .conflict-modal {
1742.	            z-index: 10001;
1743.	        }
1744.	
1745.	        .conflict-details {
1746.	            background: var(--bg-primary);
1747.	            border-radius: 6px;
1748.	            padding: 10px;
1749.	            margin: 10px 0;
1750.	            max-height: 200px;
1751.	            overflow-y: auto;
1752.	        }
1753.	
1754.	        .conflict-item {
1755.	            padding: 5px;
1756.	            border-bottom: 1px solid var(--border-color);
1757.	        }
1758.	
1759.	        .conflict-item:last-child {
1760.	            border-bottom: none;
1761.	        }
1762.	
1763.	        @media (max-width: 1200px) {
1764.	            .top-controls-panel {
1765.	                height: auto;
1766.	                padding: 15px;
1767.	            }
1768.	 
1769.	            .controls-group {
1770.	                flex-wrap: wrap;
1771.	                justify-content: flex-end;
1772.	            }
1773.	 
1774.	            .search-container {
1775.	                min-width: 200px;
1776.	            }
1777.	
1778.	            .status-bar-header {
1779.	                min-width: 180px;
1780.	                max-width: 220px;
1781.	                font-size: 0.75rem;
1782.	            }
1783.	        }
1784.	
1785.	        @media (max-width: 992px) {
1786.	            .container {
1787.	                flex-direction: column;
1788.	                height: auto;
1789.	            }
1790.	 
1791.	            .sidebar {
1792.	                width: 100%;
1793.	                height: auto;
1794.	                max-height: 300px;
1795.	                order: 2;
1796.	            }
1797.	 
1798.	            .content {
1799.	                order: 1;
1800.	                flex: none;
1801.	                height: 60vh;
1802.	            }
1803.	 
1804.	            .top-controls-panel {
1805.	                flex-direction: column;
1806.	                height: auto;
1807.	                gap: 10px;
1808.	                padding: 10px;
1809.	            }
1810.	 
1811.	            .tabs-wrapper {
1812.	                max-width: 100%;
1813.	                width: 100%;
1814.	            }
1815.	 
1816.	            .tabs-scroll-btn {
1817.	                display: none !important;
1818.	            }
1819.	 
1820.	            .controls-group {
1821.	                width: 100%;
1822.	                justify-content: space-between;
1823.	                margin-left: 0;
1824.	            }
1825.	 
1826.	            .search-container {
1827.	                min-width: 150px;
1828.	                flex: 1;
1829.	            }
1830.	 
1831.	            .header {
1832.	                flex-direction: column;
1833.	                height: auto;
1834.	                padding: 10px;
1835.	                gap: 10px;
1836.	            }
1837.	 
1838.	            .header-content {
1839.	                justify-content: center;
1840.	                width: 100%;
1841.	            }
1842.	 
1843.	            .user-info {
1844.	                justify-content: center;
1845.	                width: 100%;
1846.	            }
1847.	
1848.	            .status-bar-header {
1849.	                order: -1;
1850.	                width: 100%;
1851.	                max-width: none;
1852.	                margin-bottom: 5px;
1853.	            }
1854.	        }
1855.	
1856.	        @media (max-width: 768px) {
1857.	            .sidebar {
1858.	                max-height: 250px;
1859.	            }
1860.	 
1861.	            .content {
1862.	                height: 50vh;
1863.	            }
1864.	 
1865.	            .controls-group {
1866.	                flex-wrap: wrap;
1867.	                gap: 8px;
1868.	            }
1869.	 
1870.	            .search-container {
1871.	                order: -1;
1872.	                width: 100%;
1873.	            }
1874.	 
1875.	            .tabs-container {
1876.	                max-width: 100%;
1877.	            }
1878.	 
1879.	            .tab {
1880.	                min-width: 110px;
1881.	                padding: 6px 10px;
1882.	                font-size: 0.8rem;
1883.	            }
1884.	 
1885.	            .modal-content {
1886.	                padding: 1.5rem;
1887.	                width: 95%;
1888.	            }
1889.	 
1890.	            .notification-panel {
1891.	                width: 95%;
1892.	                right: 2.5%;
1893.	            }
1894.	        }
1895.	
1896.	        @media (max-width: 576px) {
1897.	            .login-container {
1898.	                padding: 1.5rem;
1899.	                margin: 10px;
1900.	            }
1901.	 
1902.	            .sidebar {
1903.	                padding: 1rem;
1904.	            }
1905.	 
1906.	            .content {
1907.	                padding: 0.8rem;
1908.	            }
1909.	 
1910.	            .top-controls-panel {
1911.	                padding: 8px;
1912.	            }
1913.	 
1914.	            .controls-group {
1915.	                flex-direction: column;
1916.	                gap: 5px;
1917.	            }
1918.	 
1919.	            .controls-group button {
1920.	                width: 100%;
1921.	                justify-content: center;
1922.	            }
1923.	 
1924.	            .tabs-wrapper {
1925.	                flex-direction: column;
1926.	                height: auto;
1927.	                gap: 5px;
1928.	            }
1929.	 
1930.	            .tabs-container {
1931.	                order: 2;
1932.	                height: 35px;
1933.	            }
1934.	 
1935.	            .header-title {
1936.	                font-size: 1.2rem;
1937.	            }
1938.	 
1939.	            .user-role-btn {
1940.	                min-width: 100px;
1941.	                font-size: 0.8rem;
1942.	            }
1943.	
1944.	            .status-bar-header {
1945.	                min-width: 150px;
1946.	                font-size: 0.7rem;
1947.	                padding: 0.4rem 0.8rem;
1948.	            }
1949.	 
1950.	            th, td {
1951.	                padding: 0.3rem;
1952.	                font-size: 0.8rem;
1953.	            }
1954.	 
1955.	            th {
1956.	                padding: 6px 4px;
1957.	                font-size: 0.8rem;
1958.	            }
1959.	 
1960.	            .column-controls {
1961.	                bottom: 10px;
1962.	                right: 10px;
1963.	            }
1964.	 
1965.	            .fixed-columns-setting {
1966.	                bottom: 50px;
1967.	                right: 10px;
1968.	            }
1969.	        }
1970.	
1971.	        @media (max-width: 400px) {
1972.	            .sidebar button {
1973.	                font-size: 0.8rem;
1974.	                padding: 0 10px;
1975.	            }
1976.	 
1977.	            .button-text {
1978.	                font-size: 0.8rem;
1979.	            }
1980.	 
1981.	            .custom-button-wrapper {
1982.	                flex-direction: column;
1983.	                gap: 2px;
1984.	            }
1985.	 
1986.	            .button-actions {
1987.	                width: 100%;
1988.	                justify-content: flex-end;
1989.	            }
1990.	
1991.	            .status-bar-header {
1992.	                min-width: 120px;
1993.	                font-size: 0.65rem;
1994.	            }
1995.	        }
1996.	
1997.	        #show-all {
1998.	            margin-bottom: 10px !important;
1999.	        }
2000.	
2001.	        .editable-cell {
2002.	            cursor: text;
2003.	            outline: none;
2004.	        }
2005.	
2006.	        .editable-cell:focus {
2007.	            background-color: var(--table-hover);
2008.	            box-shadow: inset 0 0 0 2px var(--accent-color);
2009.	        }
2010.	
2011.	        .file-management-modal .form-group:nth-child(2) {
2012.	            display: none;
2013.	        }
2014.	
2015.	        .file-management-modal #save-cell-btn {
2016.	            display: none;
2017.	        }
2018.	
2019.	        .file-management-modal #close-file-modal {
2020.	            display: block;
2021.	        }
2022.	
2023.	        #close-file-modal {
2024.	            display: none;
2025.	        }
2026.	
2027.	        .cell-editing {
2028.	            position: relative;
2029.	            z-index: 100;
2030.	        }
2031.	
2032.	        .cell-input {
2033.	            width: 100%;
2034.	            height: 100%;
2035.	            border: 2px solid var(--accent-color);
2036.	            background: var(--bg-primary);
2037.	            color: var(--text-primary);
2038.	            padding: 4px 8px;
2039.	            font-size: inherit;
2040.	            border-radius: 4px;
2041.	            outline: none;
2042.	        }
2043.	
2044.	        .text-cell-editing {
2045.	            cursor: text;
2046.	            background-color: var(--table-hover);
2047.	            box-shadow: inset 0 0 0 2px var(--accent-color);
2048.	        }
2049.	    </style>
2050.	</head>
2051.	<body class="theme-orange">
2052.	    <!-- Экран входа -->
2053.	    <div id="login-screen">
2054.	        <div class="login-container">
2055.	            <h2>Вход в систему</h2>
2056.	            <form id="login-form">
2057.	                <div class="form-group">
2058.	                    <label for="username">Имя пользователя</label>
2059.	                    <input type="text" id="username" required>
2060.	                </div>
2061.	                <div class="form-group">
2062.	                    <label for="password">Пароль</label>
2063.	                    <input type="password" id="password" required>
2064.	                </div>
2065.	                <button type="submit">Войти</button>
2066.	            </form>
2067.	        </div>
2068.	    </div>
2069.	
2070.	    <!-- Основной экран -->
2071.	    <div id="main-screen">
2072.	        <div class="header">
2073.	            <div class="header-content">
2074.	                <img id="header-logo" class="logo" src="" alt="Logo" style="display: none;">
2075.	                <h1 id="header-title" class="header-title">Основное окно</h1>
2076.	            </div>
2077.	            <div class="user-info">
2078.	                <span class="user-name" id="user-name-display"></span>
2079.	                <div class="status-bar-header" id="status-bar-header" data-tooltip="">
2080.	                    <div class="status-info-header">
2081.	                        <div class="status-sync-header">
2082.	                            <span class="sync-icon">🔄</span>
2083.	                            <span class="sync-text" id="sync-status-text">Готов к синхронизации</span>
2084.	                        </div>
2085.	                    </div>
2086.	                </div>
2087.	                <button class="user-role-btn" id="user-role">Пользователь</button>
2088.	                <button id="logout-btn" class="user-role-btn">Выйти</button>
2089.	            </div>
2090.	        </div>
2091.	
2092.	        <!-- Новая панель управления -->
2093.	        <div class="top-controls-panel">
2094.	            <div class="tabs-wrapper">
2095.	                <button class="tabs-scroll-btn left">‹</button>
2096.	                <div class="tabs-container" id="tabs-container">
2097.	                    <!-- Вкладки будут добавляться здесь динамически -->
2098.	                </div>
2099.	                <button class="tabs-scroll-btn right">›</button>
2100.	            </div>
2101.	
2102.	            <div class="controls-group">
2103.	                <button class="new-tab-btn admin-only" id="new-tab-btn" title="Создать новую вкладку с таблицей">
2104.	                    <span class="icon">+</span> Новое окно
2105.	                </button>
2106.	 
2107.	                <div class="search-container">
2108.	                    <input type="text" class="search-input" id="table-search" placeholder="Поиск по таблице..." title="Поиск по всем данным таблицы">
2109.	                    <button class="search-clear" id="search-clear" title="Очистить поиск">×</button>
2110.	                </div>
2111.	
2112.	                <button class="filter-selected-btn" id="filter-selected-btn" title="Показать только выделенные строки">
2113.	                    <span class="icon">⌕</span> Фильтр выделенного
2114.	                </button>
2115.	 
2116.	                <button class="import-excel-btn admin-only" id="import-excel-btn" title="Импорт данных из Excel файла">
2117.	                    <span class="icon">↓</span> Импорт Excel
2118.	                </button>
2119.	 
2120.	                <button class="export-excel-btn" id="export-excel-btn" title="Экспорт данных в Excel файл">
2121.	                    <span class="icon">↑</span> Экспорт в Excel
2122.	                </button>
2123.	            </div>
2124.	        </div>
2125.	
2126.	        <div class="container">
2127.	            <div class="sidebar">
2128.	                <div class="sidebar-buttons">
2129.	                    <button id="show-all" title="Показать все столбцы">Отобразить все</button>
2130.	                    <div id="custom-buttons"></div>
2131.	                </div>
2132.	                <div class="sidebar-bottom">
2133.	                    <div class="admin-only">
2134.	                        <button id="add-button" class="add-custom-button-btn" title="Добавить пользовательскую кнопку для отображения столбцов">
2135.	                            <span class="icon">+</span> Добавить кнопку
2136.	                        </button>
2137.	                    </div>
2138.	                    <button id="refresh-data-btn" class="refresh-data-btn user-only" title="Загрузить обновленные данные с GitHub">
2139.	                        <span class="icon">↻</span> Обновить данные
2140.	                    </button>
2141.	                    <button id="add-row-btn" class="add-row-btn" title="Добавить новую строку в таблицу">
2142.	                        <span class="icon">+</span> Добавить строку
2143.	                    </button>
2144.	                    <button id="check-dates-btn" class="check-dates-btn" title="Проверить все даты на истечение срока">
2145.	                        <span class="icon">📅</span> Проверка дат
2146.	                    </button>
2147.	                    <div class="admin-only">
2148.	                        <button id="manage-users" class="manage-users-btn" title="Управление пользователями системы">
2149.	                            <span class="icon">👥</span> Управление пользователями
2150.	                        </button>
2151.	                        <button id="github-sync-btn" class="manage-users-btn" title="Настройки синхронизации с GitHub">
2152.	                            <span class="icon">🔗</span> GitHub Синхронизация
2153.	                        </button>
2154.	                        <button id="save-changes-btn" class="manage-users-btn" title="Сохранить изменения на GitHub">
2155.	                            <span class="icon">💾</span> Сохранить изменения
2156.	                        </button>
2157.	                    </div>
2158.	                </div>
2159.	            </div>
2160.	            <div class="content">
2161.	                <div class="table-container">
2162.	                    <table id="data-table">
2163.	                        <thead>
2164.	                            <tr>
2165.	                                <th><input type="checkbox" class="select-all-checkbox" id="select-all-checkbox" title="Показать все строки"></th>
2166.	                                <th>№ п/п</th>
2167.	                                <th>Название</th>
2168.	                                <th>Дата создания</th>
2169.	                                <th>Статус</th>
2170.	                                <th class="admin-only actions-header">
2171.	                                    <div class="th-content">
2172.	                                        <div class="th-main">
2173.	                                            <div class="th-title">×</div>
2174.	                                            <div class="filter-controls">
2175.	                                                <!-- Пусто - для выравнивания с другими заголовками -->
2176.	                                            </div>
2177.	                                        </div>
2178.	                                    </div>
2179.	                                </th>
2180.	                            </tr>
2181.	                        </thead>
2182.	                        <tbody>
2183.	                            <!-- Данные будут загружаться динамически -->
2184.	                        </tbody>
2185.	                    </table>
2186.	                </div>
2187.	            </div>
2188.	        </div>
2189.	
2190.	        <!-- Кнопки управления столбцами -->
2191.	        <div class="column-controls">
2192.	            <button class="column-control-btn" id="add-column-btn" title="Добавить столбец">+</button>
2193.	            <button class="column-control-btn" id="remove-column-btn" title="Удалить столбец">-</button>
2194.	            <button class="column-control-btn" id="move-column-left-btn" title="Переместить столбец влево">←</button>
2195.	            <button class="column-control-btn" id="move-column-right-btn" title="Переместить столбец вправо">→</button>
2196.	        </div>
2197.	
2198.	        <!-- Настройки фиксированных столбцов -->
2199.	        <div class="fixed-columns-setting admin-only">
2200.	            <label>Фикс. столбцов: <input type="number" id="fixed-columns-count" min="1" max="10" value="3" title="Количество фиксированных столбцов слева"></label>
2201.	        </div>
2202.	    </div>
2203.	
2204.	    <!-- Модальное окно для добавления кнопки -->
2205.	    <div id="add-button-modal" class="modal">
2206.	        <div class="modal-content">
2207.	            <div class="modal-header">
2208.	                <h3>Добавить новую кнопку</h3>
2209.	                <span class="close">&times;</span>
2210.	            </div>
2211.	            <form id="add-button-form">
2212.	                <div class="form-group">
2213.	                    <label for="button-name">Название кнопки</label>
2214.	                    <input type="text" id="button-name" required title="Название кнопки, которое будет отображаться в боковой панели">
2215.	                </div>
2216.	                <div class="form-group">
2217.	                    <label for="column-count">Количество столбцов</label>
2218.	                    <input type="number" id="column-count" min="1" max="10" value="1" required title="Количество столбцов, которые будут отображаться при нажатии на кнопку">
2219.	                </div>
2220.	                <div id="columns-container">
2221.	                    <!-- Динамически добавляемые поля для названий столбцов -->
2222.	                </div>
2223.	                <div class="form-group">
2224.	                    <label>Проверка дат для столбцов:</label>
2225.	                    <div id="date-validation-columns">
2226.	                        <!-- Динамически добавляемые checkbox для каждого столбца -->
2227.	                    </div>
2228.	                </div>
2229.	                <button type="submit">Добавить кнопку</button>
2230.	            </form>
2231.	        </div>
2232.	    </div>
2233.	
2234.	    <!-- Модальное окно управления пользователями -->
2235.	    <div id="users-modal" class="modal">
2236.	        <div class="modal-content">
2237.	            <div class="modal-header">
2238.	                <h3>Управление пользователями</h3>
2239.	                <span class="close">&times;</span>
2240.	            </div>
2241.	            <form id="add-user-form">
2242.	                <div class="form-group">
2243.	                    <label for="new-username">Имя пользователя</label>
2244.	                    <input type="text" id="new-username" required title="Уникальное имя пользователя для входа в систему">
2245.	                </div>
2246.	                <div class="form-group">
2247.	                    <label for="new-password">Пароль</label>
2248.	                    <input type="password" id="new-password" required title="Пароль для входа в систему">
2249.	                </div>
2250.	                <div class="form-group">
2251.	                    <label for="new-role">Роль</label>
2252.	                    <select id="new-role" required title="Роль пользователя определяет доступные функции">
2253.	                        <option value="user">Пользователь</option>
2254.	                        <option value="admin">Администратор</option>
2255.	                    </select>
2256.	                </div>
2257.	                <button type="submit">Добавить пользователя</button>
2258.	            </form>
2259.	            <div class="user-list" id="users-list">
2260.	                <!-- Список пользователей будет здесь -->
2261.	            </div>
2262.	        </div>
2263.	    </div>
2264.	
2265.	    <!-- Модальное окно для редактирования ячейки -->
2266.	    <div id="edit-cell-modal" class="modal">
2267.	        <div class="modal-content">
2268.	            <div class="modal-header">
2269.	                <h3 id="edit-cell-title">Редактирование ячейки</h3>
2270.	                <span class="close">&times;</span>
2271.	            </div>
2272.	            <div class="form-group">
2273.	                <label for="cell-value">Значение:</label>
2274.	                <textarea id="cell-value" class="edit-cell-content" title="Введите новое значение для ячейки"></textarea>
2275.	            </div>
2276.	            <div class="form-group">
2277.	                <label>Прикрепленные файлы:</label>
2278.	                <div class="file-upload-area" id="file-upload-area" title="Перетащите файлы сюда или кликните для выбора">
2279.	                    Перетащите файлы сюда или кликните для выбора<br>
2280.	                    <small>(изображения, PDF, Word, Excel)</small>
2281.	                    <input type="file" id="file-input" multiple style="display: none;"
2282.	                           accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
2283.	                </div>
2284.	                <div class="attached-files" id="attached-files">
2285.	                    <!-- Прикрепленные файлы будут здесь -->
2286.	                </div>
2287.	            </div>
2288.	            <div class="preview-actions">
2289.	                <button id="save-cell-btn" title="Сохранить изменения в ячейке">Сохранить</button>
2290.	                <button id="close-file-modal" title="Закрыть окно">Закрыть</button>
2291.	            </div>
2292.	        </div>
2293.	    </div>
2294.	
2295.	    <!-- Модальное окно предпросмотра файлов -->
2296.	    <div id="file-preview-modal" class="modal">
2297.	        <div class="modal-content">
2298.	            <div class="modal-header">
2299.	                <h3 id="preview-title">Просмотр файла</h3>
2300.	                <span class="close">&times;</span>
2301.	            </div>
2302.	            <div class="file-info">
2303.	                <strong id="preview-filename">Название файла</strong>
2304.	                <div id="preview-filetype" style="font-size: 0.9rem; color: #bdc3c7;"></div>
2305.	            </div>
2306.	            <div class="preview-content" id="preview-content">
2307.	                <!-- Контент файла будет здесь -->
2308.	            </div>
2309.	            <div class="preview-actions">
2310.	                <button id="download-preview-btn" class="btn-success" title="Скачать файл на компьютер">
2311.	                    <span class="icon">↓</span> Сохранить
2312.	                </button>
2313.	                <button id="copy-preview-btn" class="btn-secondary" title="Скопировать файл в буфер обмена (для изображений)">
2314.	                    <span class="icon">📋</span> Копировать
2315.	                </button>
2316.	                <button id="print-preview-btn" class="btn-secondary" title="Распечатать файл">
2317.	                    <span class="icon">🖨</span> Печать
2318.	                </button>
2319.	            </div>
2320.	        </div>
2321.	    </div>
2322.	
2323.	    <!-- Модальное окно импорта Excel -->
2324.	    <div id="import-excel-modal" class="modal">
2325.	        <div class="modal-content">
2326.	            <div class="modal-header">
2327.	                <h3>Импорт данных из Excel</h3>
2328.	                <span class="close">&times;</span>
2329.	            </div>
2330.	            <div class="form-group">
2331.	                <label>Выберите файл Excel (.xlsx, .xls, .csv):</label>
2332.	                <div class="file-upload-area" id="excel-upload-area" title="Перетащите файл Excel сюда или кликните для выбора">
2333.	                    Перетащите файл Excel сюда или кликните для выбора<br>
2334.	                    <small>Поддерживаемые форматы: .xlsx, .xls, .csv</small>
2335.	                    <input type="file" id="excel-file-input" style="display: none;"
2336.	                           accept=".xlsx,.xls,.csv">
2337.	                </div>
2338.	            </div>
2339.	            <div class="form-group">
2340.	                <label for="import-mode">Режим импорта:</label>
2341.	                <select id="import-mode" title="Выберите способ добавления данных">
2342.	                    <option value="replace">Заменить все данные</option>
2343.	                    <option value="append">Добавить к существующим</option>
2344.	                </select>
2345.	            </div>
2346.	            <div id="import-preview" style="display: none; margin-top: 1rem;">
2347.	                <h4>Предпросмотр данных:</h4>
2348.	                <div class="table-container" style="max-height: 300px;">
2349.	                    <table id="import-preview-table">
2350.	                        <!-- Предпросмотр данных будет здесь -->
2351.	                    </table>
2352.	                </div>
2353.	            </div>
2354.	            <div class="preview-actions">
2355.	                <button id="confirm-import-btn" class="btn-success" style="display: none;" title="Импортировать данные в таблицу">
2356.	                    <span class="icon">↓</span> Импортировать данные
2357.	                </button>
2358.	                <button id="cancel-import-btn" class="btn-secondary" title="Отменить импорт">
2359.	                    <span class="icon">×</span> Отмена
2360.	                </button>
2361.	            </div>
2362.	        </div>
2363.	    </div>
2364.	
2365.	    <!-- Модальное окно для удаления столбца -->
2366.	    <div id="remove-column-modal" class="modal">
2367.	        <div class="modal-content">
2368.	            <div class="modal-header">
2369.	                <h3>Удаление столбца</h3>
2370.	                <span class="close">&times;</span>
2371.	            </div>
2372.	            <div class="form-group">
2373.	                <label for="column-to-remove">Выберите столбец для удаления:</label>
2374.	                <select id="column-to-remove" style="width: 100%; padding: 0.5rem; border: 1px solid #4a4a4a; border-radius: 5px; background: #2f2f2f; color: #ecf0f1;">
2375.	                    <!-- Столбцы будут добавлены динамически -->
2376.	                </select>
2377.	            </div>
2378.	            <button id="confirm-remove-column">Удалить столбец</button>
2379.	        </div>
2380.	    </div>
2381.	
2382.	    <!-- Модальное окно перемещения столбца -->
2383.	    <div id="move-column-modal" class="modal">
2384.	        <div class="modal-content">
2385.	            <div class="modal-header">
2386.	                <h3>Перемещение столбца</h3>
2387.	                <span class="close">&times;</span>
2388.	            </div>
2389.	            <div class="form-group">
2390.	                <label for="column-to-move">Выберите столбец для перемещения:</label>
2391.	                <select id="column-to-move" style="width: 100%; padding: 0.5rem; border: 1px solid #4a4a4a; border-radius: 5px; background: #2f2f2f; color: #ecf0f1;">
2392.	                    <!-- Столбцы будут добавлены динамически -->
2393.	                </select>
2394.	            </div>
2395.	            <div class="form-group">
2396.	                <label for="column-position">Новая позиция (от 1 до <span id="max-position">0</span>):</label>
2397.	                <input type="number" id="column-position" min="1" value="1" style="width: 100%; padding: 0.5rem; border: 1px solid #4a4a4a; border-radius: 5px; background: #2f2f2f; color: #ecf0f1;">
2398.	            </div>
2399.	            <button id="confirm-move-column">Переместить столбец</button>
2400.	        </div>
2401.	    </div>
2402.	
2403.	    <!-- Модальное окно настроек GitHub -->
2404.	    <div id="github-sync-modal" class="modal">
2405.	        <div class="modal-content">
2406.	            <div class="modal-header">
2407.	                <h3>Настройки синхронизации с GitHub</h3>
2408.	                <span class="close">&times;</span>
2409.	            </div>
2410.	            <form id="github-sync-form">
2411.	                <div class="form-group">
2412.	                    <label for="github-token">GitHub Токен</label>
2413.	                    <input type="password" id="github-token" required title="Токен доступа GitHub с правами repo">
2414.	                </div>
2415.	                <div class="form-group">
2416.	                    <label for="github-repo">Репозиторий</label>
2417.	                    <input type="text" id="github-repo" value="viktor15081985/Transort" required title="Репозиторий в формате username/repo">
2418.	                </div>
2419.	                <div class="form-group">
2420.	                    <label for="github-branch">Ветка</label>
2421.	                    <input type="text" id="github-branch" value="main" required title="Ветка репозитория">
2422.	                </div>
2423.	                <button type="submit">Сохранить настройки</button>
2424.	            </form>
2425.	            <div class="preview-actions">
2426.	                <button id="sync-now-btn" class="btn-success">Синхронизировать сейчас</button>
2427.	                <button id="load-from-github-btn" class="btn-secondary">Загрузить из GitHub</button>
2428.	            </div>
2429.	        </div>
2430.	    </div>
2431.	
2432.	    <!-- Модальное окно для разрешения конфликтов -->
2433.	    <div id="conflict-resolution-modal" class="modal conflict-modal">
2434.	        <div class="modal-content">
2435.	            <div class="modal-header">
2436.	                <h3>Обнаружен конфликт данных</h3>
2437.	                <span class="close">&times;</span>
2438.	            </div>
2439.	            <div class="form-group">
2440.	                <p>Данные были изменены другим администратором. Выберите действие:</p>
2441.	                <div class="conflict-details" id="conflict-details">
2442.	                    <!-- Детали конфликта будут здесь -->
2443.	                </div>
2444.	            </div>
2445.	            <div class="preview-actions">
2446.	                <button id="overwrite-conflict-btn" class="btn-success">Перезаписать данные</button>
2447.	                <button id="keep-changes-btn" class="btn-secondary">Сохранить мои изменения</button>
2448.	                <button id="cancel-conflict-btn" class="btn-secondary">Отмена</button>
2449.	            </div>
2450.	        </div>
2451.	    </div>
2452.	
2453.	    <!-- Скрытый input для загрузки логотипа -->
2454.	    <input type="file" id="logo-upload" accept=".png" style="display: none;">
2455.	
2456.	    <script>
2457.	        // ========== StorageManager Class ==========
2458.	        class StorageManager {
2459.	            constructor() {
2460.	                this.GITHUB_CONFIG = {
2461.	                    token: localStorage.getItem('githubToken') || '',
2462.	                    repo: localStorage.getItem('githubRepo') || 'viktor15081985/Transort',
2463.	                    branch: localStorage.getItem('githubBranch') || 'main'
2464.	                };
2465.	 
2466.	                this.pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
2467.	                this.isSyncing = false;
2468.	                this.syncRetryCount = 0;
2469.	                this.MAX_SYNC_RETRIES = 3;
2470.	                this.syncRetryTimeout = null;
2471.	            }
2472.	
2473.	            // Получение всех данных приложения
2474.	            getAllAppData(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs, currentUser) {
2475.	                return {
2476.	                    tableData,
2477.	                    users,
2478.	                    appSettings,
2479.	                    customButtons,
2480.	                    customColumns,
2481.	                    basicColumns,
2482.	                    dateValidationColumns,
2483.	                    tabs,
2484.	                    lastSync: new Date().toISOString(),
2485.	                    lastEditor: currentUser.username
2486.	                };
2487.	            }
2488.	
2489.	            // Сохранение всех данных в localStorage
2490.	            saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs) {
2491.	                try {
2492.	                    localStorage.setItem('tableData', JSON.stringify(tableData));
2493.	                    localStorage.setItem('users', JSON.stringify(users));
2494.	                    localStorage.setItem('appSettings', JSON.stringify(appSettings));
2495.	                    localStorage.setItem('customButtons', JSON.stringify(customButtons));
2496.	                    localStorage.setItem('customColumns', JSON.stringify(customColumns));
2497.	                    localStorage.setItem('basicColumns', JSON.stringify(basicColumns));
2498.	                    localStorage.setItem('dateValidationColumns', JSON.stringify(dateValidationColumns));
2499.	                    localStorage.setItem('tabs', JSON.stringify(tabs));
2500.	 
2501.	                    const dataHash = JSON.stringify(tableData) + JSON.stringify(users) + JSON.stringify(appSettings);
2502.	                    localStorage.setItem('lastDataHash', dataHash);
2503.	 
2504.	                    return true;
2505.	                } catch (error) {
2506.	                    console.error('Ошибка сохранения в localStorage:', error);
2507.	                    return false;
2508.	                }
2509.	            }
2510.	
2511.	            // Загрузка всех данных из localStorage
2512.	            loadFromLocalStorage() {
2513.	                try {
2514.	                    const tableData = JSON.parse(localStorage.getItem('tableData')) || [];
2515.	                    const users = JSON.parse(localStorage.getItem('users')) || [];
2516.	                    const appSettings = JSON.parse(localStorage.getItem('appSettings')) || {};
2517.	                    const customButtons = JSON.parse(localStorage.getItem('customButtons')) || [];
2518.	                    const customColumns = JSON.parse(localStorage.getItem('customColumns')) || [];
2519.	                    const basicColumns = JSON.parse(localStorage.getItem('basicColumns')) || [];
2520.	                    const dateValidationColumns = JSON.parse(localStorage.getItem('dateValidationColumns')) || {};
2521.	                    const tabs = JSON.parse(localStorage.getItem('tabs')) || [];
2522.	                    const pendingChanges = JSON.parse(localStorage.getItem('pendingChanges')) || [];
2523.	 
2524.	                    return {
2525.	                        tableData,
2526.	                        users,
2527.	                        appSettings,
2528.	                        customButtons,
2529.	                        customColumns,
2530.	                        basicColumns,
2531.	                        dateValidationColumns,
2532.	                        tabs,
2533.	                        pendingChanges
2534.	                    };
2535.	                } catch (error) {
2536.	                    console.error('Ошибка загрузки из localStorage:', error);
2537.	                    return this.getDefaultData();
2538.	                }
2539.	            }
2540.	
2541.	            // Данные по умолчанию
2542.	            getDefaultData() {
2543.	                return {
2544.	                    tableData: [
2545.	                        { id: 1, name: 'Проект А', date: '01.10.2023', status: 'Активен', customData: {}, attachments: {} },
2546.	                        { id: 2, name: 'Проект Б', date: '05.10.2023', status: 'Завершен', customData: {}, attachments: {} },
2547.	                        { id: 3, name: 'Проект В', date: '10.10.2023', status: 'В процессе', customData: {}, attachments: {} }
2548.	                    ],
2549.	                    users: [
2550.	                        { username: 'admin', password: 'admin', role: 'admin' },
2551.	                        { username: 'user', password: 'user', role: 'user' }
2552.	                    ],
2553.	                    appSettings: {
2554.	                        headerTitle: 'Основное окно',
2555.	                        headerLogo: '',
2556.	                        fixedColumnsCount: 3,
2557.	                        currentTheme: 'theme-orange'
2558.	                    },
2559.	                    customButtons: [],
2560.	                    customColumns: [],
2561.	                    basicColumns: [
2562.	                        { id: 'id', name: '№ п/п', editable: false },
2563.	                        { id: 'name', name: 'Название', editable: true },
2564.	                        { id: 'date', name: 'Дата создания', editable: true },
2565.	                        { id: 'status', name: 'Статус', editable: true }
2566.	                    ],
2567.	                    dateValidationColumns: {},
2568.	                    tabs: [
2569.	                        { id: 'tab1', name: 'Основное окно', data: null }
2570.	                    ],
2571.	                    pendingChanges: []
2572.	                };
2573.	            }
2574.	
2575.	            // Сохранение в GitHub
2576.	            async saveToGitHub(data, currentUser) {
2577.	                if (!this.GITHUB_CONFIG.token) {
2578.	                    throw new Error('GitHub токен не настроен');
2579.	                }
2580.	
2581.	                console.log('🔄 Начинаем процесс синхронизации...');
2582.	
2583.	                let content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
2584.	 
2585.	                let sha = null;
2586.	                let remoteData = null;
2587.	 
2588.	                try {
2589.	                    console.log('📡 Получаем актуальную информацию о файле...');
2590.	                    const fileInfoResponse = await fetch(`https://api.github.com/repos/${this.GITHUB\_CONFIG.repo}/contents/data.json?ref=${this.GITHUB\_CONFIG.branch}`, {
2591.	                        headers: {
2592.	                            'Authorization': `token ${this.GITHUB\_CONFIG.token}`,
2593.	                            'Accept': 'application/vnd.github.v3+json'
2594.	                        }
2595.	                    });
2596.	 
2597.	                    if (fileInfoResponse.ok) {
2598.	                        const fileInfo = await fileInfoResponse.json();
2599.	                        sha = fileInfo.sha;
2600.	 
2601.	                        const remoteContent = decodeURIComponent(escape(atob(fileInfo.content)));
2602.	                        remoteData = JSON.parse(remoteContent);
2603.	 
2604.	                        console.log('✅ Текущий SHA:', sha);
2605.	
2606.	                        if (currentUser.role === 'admin' && remoteData.lastEditor &&
2607.	                            remoteData.lastEditor !== currentUser.username &&
2608.	                            remoteData.lastSync > localStorage.getItem('lastSyncTime')) {
2609.	 
2610.	                            console.log('⚠️ Обнаружен потенциальный конфликт: данные были изменены другим администратором');
2611.	 
2612.	                            return {
2613.	                                conflict: true,
2614.	                                remoteData: remoteData,
2615.	                                sha: sha
2616.	                            };
2617.	                        }
2618.	 
2619.	                        console.log('🔄 Выполняем автоматическое слияние данных...');
2620.	                        const mergedData = this.mergeData(remoteData, data);
2621.	                        content = btoa(unescape(encodeURIComponent(JSON.stringify(mergedData, null, 2))));
2622.	 
2623.	                    } else if (fileInfoResponse.status === 404) {
2624.	                        console.log('📝 Файл не существует, создаем новый');
2625.	                        sha = null;
2626.	                    } else {
2627.	                        const error = await fileInfoResponse.json();
2628.	                        throw new Error(`Ошибка получения информации о файле: ${error.message}`);
2629.	                    }
2630.	                } catch (e) {
2631.	                    console.log('⚠️ Ошибка при получении информации о файле:', e.message);
2632.	                }
2633.	
2634.	                console.log('💾 Отправляем данные на GitHub...');
2635.	                const saveResponse = await fetch(`https://api.github.com/repos/${this.GITHUB\_CONFIG.repo}/contents/data.json`, {
2636.	                    method: 'PUT',
2637.	                    headers: {
2638.	                        'Authorization': `token ${this.GITHUB\_CONFIG.token}`,
2639.	                        'Content-Type': 'application/json',
2640.	                        'Accept': 'application/vnd.github.v3+json'
2641.	                    },
2642.	                    body: JSON.stringify({
2643.	                        message: `Авто-синхронизация ${new Date().toLocaleString()} (${currentUser.username})`,
2644.	                        content: content,
2645.	                        branch: this.GITHUB_CONFIG.branch,
2646.	                        sha: sha
2647.	                    })
2648.	                });
2649.	
2650.	                if (!saveResponse.ok) {
2651.	                    const error = await saveResponse.json();
2652.	 
2653.	                    if (error.message && error.message.includes('does not match')) {
2654.	                        console.log('⚡ Обнаружен конфликт SHA, обновляем данные...');
2655.	                        return {
2656.	                            shaConflict: true,
2657.	                            error: error
2658.	                        };
2659.	                    }
2660.	 
2661.	                    throw new Error(error.message || 'Ошибка сохранения в GitHub');
2662.	                }
2663.	
2664.	                console.log('✅ Успешно сохранено в GitHub');
2665.	                localStorage.setItem('lastSyncTime', new Date().toISOString());
2666.	                return { success: true };
2667.	            }
2668.	
2669.	            // Загрузка из GitHub
2670.	            async loadFromGitHub() {
2671.	                try {
2672.	                    console.log('📥 Начинаем загрузку данных из GitHub...');
2673.	 
2674.	                    if (!this.GITHUB_CONFIG.token && !this.GITHUB_CONFIG.repo) {
2675.	                        throw new Error('Настройки GitHub не настроены');
2676.	                    }
2677.	
2678.	                    const headers = {
2679.	                        'Accept': 'application/vnd.github.v3+json'
2680.	                    };
2681.	                    if (this.GITHUB_CONFIG.token) {
2682.	                        headers['Authorization'] = `token ${this.GITHUB\_CONFIG.token}`;
2683.	                    }
2684.	
2685.	                    const response = await fetch(`https://api.github.com/repos/${this.GITHUB\_CONFIG.repo}/contents/data.json?ref=${this.GITHUB\_CONFIG.branch}`, {
2686.	                        headers: headers
2687.	                    });
2688.	
2689.	                    console.log('📡 Статус загрузки:', response.status);
2690.	
2691.	                    if (!response.ok) {
2692.	                        if (response.status === 404) {
2693.	                            console.log('📝 Файл данных не найден, будет создан при первой синхронизации');
2694.	                            return { notFound: true };
2695.	                        }
2696.	                        const error = await response.json();
2697.	                        throw new Error(error.message || `Ошибка загрузки: ${response.status}`);
2698.	                    }
2699.	
2700.	                    const fileInfo = await response.json();
2701.	                    console.log('✅ Файл найден, размер:', fileInfo.size, 'байт');
2702.	
2703.	                    if (!fileInfo.content || fileInfo.size === 0) {
2704.	                        throw new Error('Файл данных пуст');
2705.	                    }
2706.	
2707.	                    const content = decodeURIComponent(escape(atob(fileInfo.content)));
2708.	 
2709.	                    if (!content || content.trim() === '') {
2710.	                        throw new Error('Файл данных пуст');
2711.	                    }
2712.	
2713.	                    console.log('🔍 Парсим данные...');
2714.	                    let data;
2715.	                    try {
2716.	                        data = JSON.parse(content);
2717.	                    } catch (parseError) {
2718.	                        console.error('❌ Ошибка парсинга JSON:', parseError);
2719.	                        throw new Error('Файл данных поврежден');
2720.	                    }
2721.	
2722.	                    console.log('✅ Данные успешно загружены');
2723.	                    return { success: true, data: data };
2724.	
2725.	                } catch (error) {
2726.	                    console.error('❌ Ошибка загрузки:', error);
2727.	                    throw error;
2728.	                }
2729.	            }
2730.	
2731.	            // Автоматическая синхронизация изменений
2732.	            async autoSyncChanges(data, currentUser, updateSyncStatus) {
2733.	                if (currentUser && currentUser.role === 'admin') {
2734.	                    const change = {
2735.	                        timestamp: Date.now(),
2736.	                        data: data,
2737.	                        user: currentUser.username
2738.	                    };
2739.	 
2740.	                    this.pendingChanges.push(change);
2741.	                    localStorage.setItem('pendingChanges', JSON.stringify(this.pendingChanges));
2742.	 
2743.	                    await this.trySyncChanges(updateSyncStatus);
2744.	                }
2745.	            }
2746.	
2747.	            // Попытка синхронизации изменений
2748.	            async trySyncChanges(updateSyncStatus) {
2749.	                if (this.isSyncing || this.pendingChanges.length === 0) return;
2750.	 
2751.	                this.isSyncing = true;
2752.	                updateSyncStatus('Синхронизация...', 'syncing');
2753.	 
2754.	                const change = this.pendingChanges[0];
2755.	 
2756.	                try {
2757.	                    const result = await this.saveToGitHub(change.data, change.user);
2758.	 
2759.	                    if (result.conflict) {
2760.	                        updateSyncStatus('Обнаружен конфликт данных', 'error');
2761.	                        return { conflict: true, remoteData: result.remoteData };
2762.	                    }
2763.	 
2764.	                    if (result.shaConflict) {
2765.	                        // Повторная попытка после конфликта SHA
2766.	                        await this.handleShaConflict(change.data, change.user);
2767.	                    }
2768.	 
2769.	                    this.pendingChanges.shift();
2770.	                    localStorage.setItem('pendingChanges', JSON.stringify(this.pendingChanges));
2771.	                    this.syncRetryCount = 0;
2772.	 
2773.	                    updateSyncStatus('Синхронизировано: ' + new Date().toLocaleTimeString(), 'success');
2774.	 
2775.	                    if (this.pendingChanges.length > 0) {
2776.	                        setTimeout(() => this.trySyncChanges(updateSyncStatus), 1000);
2777.	                    }
2778.	 
2779.	                    return { success: true };
2780.	 
2781.	                } catch (error) {
2782.	                    console.error('Ошибка синхронизации:', error);
2783.	                    this.syncRetryCount++;
2784.	 
2785.	                    if (this.syncRetryCount <= this.MAX_SYNC_RETRIES) {
2786.	                        updateSyncStatus(`Ошибка, повтор через ${this.syncRetryCount \* 2} сек...`, 'error');
2787.	                        this.syncRetryTimeout = setTimeout(() => this.trySyncChanges(updateSyncStatus), this.syncRetryCount * 2000);
2788.	                    } else {
2789.	                        updateSyncStatus('Ошибка синхронизации', 'error');
2790.	                    }
2791.	 
2792.	                    return { error: error.message };
2793.	                } finally {
2794.	                    this.isSyncing = false;
2795.	                }
2796.	            }
2797.	
2798.	            // Обработка конфликта SHA
2799.	            async handleShaConflict(data, user) {
2800.	                // Загружаем актуальные данные и повторяем сохранение
2801.	                const loadResult = await this.loadFromGitHub();
2802.	                if (loadResult.success) {
2803.	                    const retryData = {
2804.	                        ...data,
2805.	                        tableData: loadResult.data.tableData || data.tableData,
2806.	                        lastSync: new Date().toISOString()
2807.	                    };
2808.	 
2809.	                    await this.saveToGitHub(retryData, user);
2810.	                }
2811.	            }
2812.	
2813.	            // Слияние данных
2814.	            mergeData(remoteData, localData) {
2815.	                console.log('🔄 Запуск слияния данных...');
2816.	 
2817.	                const merged = {
2818.	                    ...remoteData,
2819.	                    lastSync: new Date().toISOString(),
2820.	                    mergeOperation: true,
2821.	                    lastEditor: localData.lastEditor
2822.	                };
2823.	
2824.	                // Слияние табличных данных
2825.	                if (localData.tableData && remoteData.tableData) {
2826.	                    console.log('📊 Слияние табличных данных...');
2827.	 
2828.	                    const remoteRows = new Map(remoteData.tableData.map(row => [row.id, row]));
2829.	                    const localRows = new Map(localData.tableData.map(row => [row.id, row]));
2830.	 
2831.	                    const mergedTableData = [...remoteData.tableData];
2832.	 
2833.	                    localData.tableData.forEach(localRow => {
2834.	                        const existingIndex = mergedTableData.findIndex(row => row.id === localRow.id);
2835.	                        if (existingIndex >= 0) {
2836.	                            const existingAttachments = mergedTableData[existingIndex].attachments;
2837.	                            mergedTableData[existingIndex] = {
2838.	                                ...localRow,
2839.	                                attachments: { ...existingAttachments, ...localRow.attachments }
2840.	                            };
2841.	                            console.log(`✏️ Обновлена строка ID: ${localRow.id}`);
2842.	                        } else {
2843.	                            mergedTableData.push(localRow);
2844.	                            console.log(`➕ Добавлена новая строка ID: ${localRow.id}`);
2845.	                        }
2846.	                    });
2847.	 
2848.	                    merged.tableData = mergedTableData;
2849.	                    console.log(`✅ Табличные данные объединены: ${mergedTableData.length} строк`);
2850.	                }
2851.	
2852.	                // Слияние пользователей
2853.	                if (localData.users && remoteData.users) {
2854.	                    console.log('👥 Слияние пользователей...');
2855.	                    const userMap = new Map(remoteData.users.map(user => [user.username, user]));
2856.	 
2857.	                    localData.users.forEach(localUser => {
2858.	                        userMap.set(localUser.username, localUser);
2859.	                    });
2860.	 
2861.	                    merged.users = Array.from(userMap.values());
2862.	                    console.log(`✅ Пользователи объединены: ${merged.users.length} пользователей`);
2863.	                }
2864.	
2865.	                // Слияние настроек
2866.	                if (localData.appSettings) {
2867.	                    console.log('⚙️ Слияние настроек приложения...');
2868.	                    merged.appSettings = {
2869.	                        ...remoteData.appSettings,
2870.	                        ...localData.appSettings
2871.	                    };
2872.	                }
2873.	
2874.	                // Сохранение пользовательских данных
2875.	                if (localData.customButtons) {
2876.	                    merged.customButtons = localData.customButtons;
2877.	                }
2878.	                if (localData.customColumns) {
2879.	                    merged.customColumns = localData.customColumns;
2880.	                }
2881.	
2882.	                console.log('🎉 Слияние завершено успешно');
2883.	                return merged;
2884.	            }
2885.	
2886.	            // Обновление конфигурации GitHub
2887.	            updateGitHubConfig(token, repo, branch) {
2888.	                this.GITHUB_CONFIG.token = token;
2889.	                this.GITHUB_CONFIG.repo = repo;
2890.	                this.GITHUB_CONFIG.branch = branch;
2891.	 
2892.	                localStorage.setItem('githubToken', token);
2893.	                localStorage.setItem('githubRepo', repo);
2894.	                localStorage.setItem('githubBranch', branch);
2895.	 
2896.	                return true;
2897.	            }
2898.	
2899.	            // Получение текущей конфигурации
2900.	            getConfig() {
2901.	                return { ...this.GITHUB_CONFIG };
2902.	            }
2903.	
2904.	            // Очистка отложенных изменений
2905.	            clearPendingChanges() {
2906.	                this.pendingChanges = [];
2907.	                localStorage.setItem('pendingChanges', JSON.stringify(this.pendingChanges));
2908.	            }
2909.	
2910.	            // Получение статуса синхронизации
2911.	            getSyncStatus() {
2912.	                return {
2913.	                    isSyncing: this.isSyncing,
2914.	                    pendingChanges: this.pendingChanges.length,
2915.	                    syncRetryCount: this.syncRetryCount
2916.	                };
2917.	            }
2918.	        }
2919.	
2920.	        // ========== Основной код приложения ==========
2921.	 
2922.	        // Создаем экземпляр StorageManager
2923.	        const storageManager = new StorageManager();
2924.	
2925.	        // Данные пользователей
2926.	        let users = [];
2927.	        // Данные таблицы
2928.	        let tableData = [];
2929.	        // Настройки приложения
2930.	        let appSettings = {};
2931.	        // Данные кнопок и столбцов
2932.	        let customButtons = [];
2933.	        let customColumns = [];
2934.	        // Базовые столбцы
2935.	        let basicColumns = [];
2936.	        // Настройки проверки дат
2937.	        let dateValidationColumns = {};
2938.	        // Вкладки
2939.	        let tabs = [];
2940.	
2941.	        // Текущий пользователь и состояние
2942.	        let currentUser = null;
2943.	        let currentEditingCell = null;
2944.	        let isEditingHeader = false;
2945.	        let currentPreviewFile = null;
2946.	        let currentSort = { column: null, direction: 'asc' };
2947.	        let currentFilters = {};
2948.	        let currentDatePicker = null;
2949.	        let currentDateInput = null;
2950.	
2951.	        // Новые переменные для вкладок и поиска
2952.	        let currentTabId = 'tab1';
2953.	        let selectedRows = new Set();
2954.	        let searchTerm = '';
2955.	
2956.	        // Данные для импорта
2957.	        let currentImportData = null;
2958.	
2959.	        // Переменные для системы онлайн-пользователей и конфликтов
2960.	        let onlineUsers = JSON.parse(localStorage.getItem('onlineUsers')) || {};
2961.	        let lastDataHash = localStorage.getItem('lastDataHash') || '';
2962.	        let adminConflictData = null;
2963.	        let currentConflict = null;
2964.	
2965.	        // Глобальная переменная для управления файлами
2966.	        let currentFileManagementCell = null;
2967.	
2968.	        // ФУНКЦИЯ ОБНОВЛЕНИЯ СТРОКИ СОСТОЯНИЯ В ХЕДЕРЕ
2969.	        function updateStatusBar() {
2970.	            const adminCount = Object.values(onlineUsers).filter(user => user.role === 'admin').length;
2971.	            const userCount = Object.values(onlineUsers).filter(user => user.role === 'user').length;
2972.	 
2973.	            if (currentUser) {
2974.	                onlineUsers[currentUser.username] = {
2975.	                    username: currentUser.username,
2976.	                    role: currentUser.role,
2977.	                    lastActive: Date.now()
2978.	                };
2979.	                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
2980.	            }
2981.	 
2982.	            const now = Date.now();
2983.	            Object.keys(onlineUsers).forEach(username => {
2984.	                if (now - onlineUsers[username].lastActive > 300000) {
2985.	                    delete onlineUsers[username];
2986.	                }
2987.	            });
2988.	            localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
2989.	 
2990.	            const statusBar = document.getElementById('status-bar-header');
2991.	            statusBar.setAttribute('data-tooltip', `Администраторов: ${adminCount}, Пользователей: ${userCount}`);
2992.	        }
2993.	
2994.	        // ФУНКЦИЯ ДЛЯ ОБНОВЛЕНИЯ СТАТУСА СИНХРОНИЗАЦИИ В ХЕДЕРЕ
2995.	        function updateSyncStatus(message, type = '') {
2996.	            const statusElement = document.getElementById('sync-status-text');
2997.	            const statusBar = document.getElementById('status-bar-header');
2998.	 
2999.	            statusElement.textContent = message;
3000.	 
3001.	            statusBar.classList.remove('syncing', 'success', 'error');
3002.	 
3003.	            if (type) {
3004.	                statusBar.classList.add(type);
3005.	            }
3006.	 
3007.	            const syncIcon = statusBar.querySelector('.sync-icon');
3008.	            if (type === 'syncing') {
3009.	                syncIcon.textContent = '🔄';
3010.	            } else if (type === 'success') {
3011.	                syncIcon.textContent = '✅';
3012.	            } else if (type === 'error') {
3013.	                syncIcon.textContent = '❌';
3014.	            } else {
3015.	                syncIcon.textContent = '🔗';
3016.	            }
3017.	        }
3018.	
3019.	        // ФУНКЦИЯ ДЛЯ АВТОМАТИЧЕСКОЙ СИНХРОНИЗАЦИИ ПРИ ИЗМЕНЕНИЯХ
3020.	        function autoSyncChanges() {
3021.	            if (currentUser && currentUser.role === 'admin') {
3022.	                const appData = storageManager.getAllAppData(
3023.	                    tableData, users, appSettings, customButtons,
3024.	                    customColumns, basicColumns, dateValidationColumns,
3025.	                    tabs, currentUser
3026.	                );
3027.	 
3028.	                storageManager.autoSyncChanges(appData, currentUser, updateSyncStatus);
3029.	            }
3030.	        }
3031.	
3032.	        // ФУНКЦИЯ ДЛЯ ПРИНУДИТЕЛЬНОГО СОХРАНЕНИЯ ИЗМЕНЕНИЙ
3033.	        function forceSaveChanges() {
3034.	            if (storageManager.pendingChanges.length === 0) {
3035.	                alert('Нет изменений для сохранения');
3036.	                return;
3037.	            }
3038.	 
3039.	            storageManager.syncRetryCount = 0;
3040.	            if (storageManager.syncRetryTimeout) {
3041.	                clearTimeout(storageManager.syncRetryTimeout);
3042.	                storageManager.syncRetryTimeout = null;
3043.	            }
3044.	 
3045.	            storageManager.trySyncChanges(updateSyncStatus);
3046.	        }
3047.	
3048.	        // ФУНКЦИЯ ДЛЯ ПОКАЗА КОНФЛИКТА И РАЗРЕШЕНИЯ
3049.	        function showConflictResolution(remoteData, localData) {
3050.	            const modal = document.getElementById('conflict-resolution-modal');
3051.	            const detailsContainer = document.getElementById('conflict-details');
3052.	 
3053.	            const changes = findDataChanges(remoteData, localData);
3054.	 
3055.	            let detailsHTML = '<div><strong>Изменения другого администратора (' + remoteData.lastEditor + '):</strong></div>';
3056.	 
3057.	            changes.forEach(change => {
3058.	                detailsHTML += `<div class="conflict-item">${change}</div>`;
3059.	            });
3060.	 
3061.	            detailsHTML += '<div style="margin-top: 10px;"><strong>Ваши изменения:</strong></div>';
3062.	            detailsHTML += '<div class="conflict-item">Локальные правки данных</div>';
3063.	 
3064.	            detailsContainer.innerHTML = detailsHTML;
3065.	 
3066.	            document.getElementById('overwrite-conflict-btn').onclick = function() {
3067.	                continueSaveAfterConflict('overwrite');
3068.	                modal.style.display = 'none';
3069.	            };
3070.	 
3071.	            document.getElementById('keep-changes-btn').onclick = function() {
3072.	                continueSaveAfterConflict('merge');
3073.	                modal.style.display = 'none';
3074.	            };
3075.	 
3076.	            document.getElementById('cancel-conflict-btn').onclick = function() {
3077.	                modal.style.display = 'none';
3078.	                updateSyncStatus('Сохранение отменено из-за конфликта', 'error');
3079.	            };
3080.	 
3081.	            modal.style.display = 'flex';
3082.	        }
3083.	
3084.	        // ФУНКЦИЯ ДЛЯ ПРОДОЛЖЕНИЯ СОХРАНЕНИЯ ПОСЛЕ РАЗРЕШЕНИЯ КОНФЛИКТА
3085.	        async function continueSaveAfterConflict(resolution) {
3086.	            if (!adminConflictData) return;
3087.	 
3088.	            const { remoteData, localData, sha } = adminConflictData;
3089.	            let finalData = localData;
3090.	 
3091.	            if (resolution === 'merge') {
3092.	                finalData = storageManager.mergeData(remoteData, localData);
3093.	            }
3094.	 
3095.	            try {
3096.	                await storageManager.saveToGitHub(finalData, currentUser);
3097.	                console.log('✅ Успешно сохранено после разрешения конфликта');
3098.	                updateSyncStatus('Синхронизировано (разрешён конфликт): ' + new Date().toLocaleTimeString(), 'success');
3099.	 
3100.	                if (resolution === 'merge') {
3101.	                    updateLocalData(finalData);
3102.	                }
3103.	 
3104.	                if (storageManager.pendingChanges.length > 0) {
3105.	                    storageManager.pendingChanges.shift();
3106.	                    localStorage.setItem('pendingChanges', JSON.stringify(storageManager.pendingChanges));
3107.	                }
3108.	            } catch (error) {
3109.	                updateSyncStatus('Ошибка сохранения: ' + error.message, 'error');
3110.	            }
3111.	 
3112.	            adminConflictData = null;
3113.	        }
3114.	
3115.	        // ФУНКЦИЯ ДЛЯ ПОИСКА ИЗМЕНЕНИЙ В ДАННЫХ
3116.	        function findDataChanges(remoteData, localData) {
3117.	            const changes = [];
3118.	 
3119.	            if (remoteData.tableData && localData.tableData) {
3120.	                if (remoteData.tableData.length !== localData.tableData.length) {
3121.	                    changes.push(`Количество строк: ${remoteData.tableData.length} → ${localData.tableData.length}`);
3122.	                }
3123.	            }
3124.	 
3125.	            if (remoteData.users && localData.users) {
3126.	                if (remoteData.users.length !== localData.users.length) {
3127.	                    changes.push(`Количество пользователей: ${remoteData.users.length} → ${localData.users.length}`);
3128.	                }
3129.	            }
3130.	 
3131.	            if (remoteData.lastEditor) {
3132.	                changes.push(`Последний редактор: ${remoteData.lastEditor}`);
3133.	            }
3134.	 
3135.	            if (changes.length === 0) {
3136.	                changes.push('Незначительные изменения в данных');
3137.	            }
3138.	 
3139.	            return changes;
3140.	        }
3141.	
3142.	        // ФУНКЦИЯ ОБНОВЛЕНИЯ ЛОКАЛЬНЫХ ДАННЫХ
3143.	        function updateLocalData(mergedData) {
3144.	            console.log('🔄 Обновление локальных данных после слияния...');
3145.	 
3146.	            tableData = mergedData.tableData || tableData;
3147.	            users = mergedData.users || users;
3148.	            appSettings = mergedData.appSettings || appSettings;
3149.	            customButtons = mergedData.customButtons || customButtons;
3150.	            customColumns = mergedData.customColumns || customColumns;
3151.	            basicColumns = mergedData.basicColumns || basicColumns;
3152.	            dateValidationColumns = mergedData.dateValidationColumns || dateValidationColumns;
3153.	            tabs = mergedData.tabs || tabs;
3154.	 
3155.	            console.log('✅ Локальные данные обновлены');
3156.	 
3157.	            renderTabs();
3158.	            renderTable();
3159.	            loadCustomButtons();
3160.	        }
3161.	
3162.	        // УЛУЧШЕННАЯ ФУНКЦИЯ ЗАГРУЗКИ ИЗ GITHUB
3163.	        async function loadFromGitHub() {
3164.	            updateSyncStatus('Загрузка из GitHub...', 'syncing');
3165.	
3166.	            try {
3167.	                const result = await storageManager.loadFromGitHub();
3168.	 
3169.	                if (result.notFound) {
3170.	                    updateSyncStatus('Файл данных не найден', '');
3171.	                    return;
3172.	                }
3173.	
3174.	                console.log('✅ Данные успешно загружены');
3175.	 
3176.	                updateLocalData(result.data);
3177.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3178.	                localStorage.setItem('lastSyncTime', new Date().toISOString());
3179.	
3180.	                updateSyncStatus('Загружено из GitHub: ' + new Date().toLocaleTimeString(), 'success');
3181.	
3182.	            } catch (error) {
3183.	                console.error('❌ Ошибка загрузки:', error);
3184.	                updateSyncStatus('Ошибка загрузки: ' + error.message, 'error');
3185.	 
3186.	                loadFromLocalStorageWithNotification();
3187.	            }
3188.	        }
3189.	
3190.	        // ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ ИЗ LOCALSTORAGE С УВЕДОМЛЕНИЕМ
3191.	        function loadFromLocalStorageWithNotification() {
3192.	            const data = storageManager.loadFromLocalStorage();
3193.	 
3194.	            tableData = data.tableData;
3195.	            users = data.users;
3196.	            appSettings = data.appSettings;
3197.	            customButtons = data.customButtons;
3198.	            customColumns = data.customColumns;
3199.	            basicColumns = data.basicColumns;
3200.	            dateValidationColumns = data.dateValidationColumns;
3201.	            tabs = data.tabs;
3202.	            storageManager.pendingChanges = data.pendingChanges;
3203.	 
3204.	            renderTabs();
3205.	            renderTable();
3206.	            loadCustomButtons();
3207.	 
3208.	            updateSyncStatus('Используются локальные данные', '');
3209.	 
3210.	            console.log('📁 Загружены локальные данные из localStorage');
3211.	        }
3212.	
3213.	        // ФУНКЦИЯ ИНИЦИАЛИЗАЦИИ ПРИЛОЖЕНИЯ
3214.	        function initializeAppWithFallback() {
3215.	            setupEventListeners();
3216.	            loadAppSettings();
3217.	            updateStatusBar();
3218.	 
3219.	            onlineUsers = JSON.parse(localStorage.getItem('onlineUsers')) || {};
3220.	 
3221.	            loadFromLocalStorageWithNotification();
3222.	 
3223.	            if (currentUser && currentUser.role === 'user') {
3224.	                const config = storageManager.getConfig();
3225.	                if (config.repo && config.branch) {
3226.	                    console.log('🔄 Попытка загрузки данных из GitHub для пользователя...');
3227.	                    loadFromGitHub().then(() => {
3228.	                        console.log('✅ Загрузка из GitHub завершена');
3229.	 
3230.	                        if (storageManager.pendingChanges.length > 0) {
3231.	                            storageManager.trySyncChanges(updateSyncStatus);
3232.	                        }
3233.	                    }).catch(error => {
3234.	                        console.log('❌ Ошибка загрузки из GitHub:', error);
3235.	                        loadFromLocalStorageWithNotification();
3236.	                    });
3237.	                } else {
3238.	                    loadFromLocalStorageWithNotification();
3239.	                }
3240.	            } else {
3241.	                loadFromLocalStorageWithNotification();
3242.	            }
3243.	        }
3244.	
3245.	        // Инициализация при загрузке страницы
3246.	        document.addEventListener('DOMContentLoaded', function() {
3247.	            initializeAppWithFallback();
3248.	 
3249.	            setInterval(updateStatusBar, 30000);
3250.	 
3251.	            window.addEventListener('online', function() {
3252.	                updateSyncStatus('Восстановлено соединение', 'success');
3253.	                if (storageManager.pendingChanges.length > 0) {
3254.	                    storageManager.trySyncChanges(updateSyncStatus);
3255.	                }
3256.	            });
3257.	 
3258.	            window.addEventListener('offline', function() {
3259.	                updateSyncStatus('Отсутствует соединение', 'error');
3260.	            });
3261.	        });
3262.	
3263.	        // ОСТАВШИЕСЯ ФУНКЦИИ (без изменений)
3264.	        function setupEventListeners() {
3265.	            // Логин
3266.	            document.getElementById('login-form').addEventListener('submit', function(e) {
3267.	                e.preventDefault();
3268.	                handleLogin();
3269.	            });
3270.	 
3271.	            document.getElementById('logout-btn').addEventListener('click', handleLogout);
3272.	
3273.	            // Основные кнопки
3274.	            document.getElementById('show-all').addEventListener('click', showAllColumns);
3275.	            document.getElementById('add-button').addEventListener('click', () => showModal('add-button-modal'));
3276.	            document.getElementById('manage-users').addEventListener('click', () => showModal('users-modal'));
3277.	            document.getElementById('check-dates-btn').addEventListener('click', checkAllDates);
3278.	            document.getElementById('add-row-btn').addEventListener('click', addNewRow);
3279.	            document.getElementById('github-sync-btn').addEventListener('click', () => showModal('github-sync-modal'));
3280.	            document.getElementById('save-changes-btn').addEventListener('click', forceSaveChanges);
3281.	
3282.	            // КНОПКА ОБНОВЛЕНИЯ ДАННЫХ
3283.	            document.getElementById('refresh-data-btn').addEventListener('click', function() {
3284.	                if (currentUser && currentUser.role === 'user') {
3285.	                    loadFromGitHub();
3286.	                }
3287.	            });
3288.	
3289.	            // Новые кнопки управления
3290.	            document.getElementById('new-tab-btn').addEventListener('click', createNewTab);
3291.	            document.getElementById('filter-selected-btn').addEventListener('click', filterSelectedRows);
3292.	            document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
3293.	            document.getElementById('import-excel-btn').addEventListener('click', () => showModal('import-excel-modal'));
3294.	            document.getElementById('table-search').addEventListener('input', handleSearch);
3295.	            document.getElementById('search-clear').addEventListener('click', clearSearch);
3296.	            document.getElementById('select-all-checkbox').addEventListener('change', handleSelectAll);
3297.	
3298.	            // Кнопки прокрутки вкладок
3299.	            document.querySelector('.tabs-scroll-btn.left').addEventListener('click', scrollTabsLeft);
3300.	            document.querySelector('.tabs-scroll-btn.right').addEventListener('click', scrollTabsRight);
3301.	
3302.	            // Кнопки управления столбцами
3303.	            document.getElementById('add-column-btn').addEventListener('click', addNewColumn);
3304.	            document.getElementById('remove-column-btn').addEventListener('click', showRemoveColumnModal);
3305.	            document.getElementById('move-column-left-btn').addEventListener('click', () => moveColumn(-1));
3306.	            document.getElementById('move-column-right-btn').addEventListener('click', () => moveColumn(1));
3307.	            document.getElementById('fixed-columns-count').addEventListener('change', updateFixedColumnsCount);
3308.	
3309.	            // Удаление столбца
3310.	            document.getElementById('confirm-remove-column').addEventListener('click', removeSelectedColumn);
3311.	
3312.	            // Перемещение столбца
3313.	            document.getElementById('confirm-move-column').addEventListener('click', moveSelectedColumn);
3314.	
3315.	            // Импорт Excel
3316.	            document.getElementById('excel-upload-area').addEventListener('click', function() {
3317.	                document.getElementById('excel-file-input').click();
3318.	            });
3319.	            document.getElementById('excel-file-input').addEventListener('change', handleExcelFileSelect);
3320.	            document.getElementById('confirm-import-btn').addEventListener('click', confirmImport);
3321.	            document.getElementById('cancel-import-btn').addEventListener('click', () => {
3322.	                document.getElementById('import-excel-modal').style.display = 'none';
3323.	            });
3324.	
3325.	            // GitHub синхронизация
3326.	            document.getElementById('github-sync-form').addEventListener('submit', handleGitHubSettingsSave);
3327.	            document.getElementById('sync-now-btn').addEventListener('click', () => {
3328.	                const appData = storageManager.getAllAppData(
3329.	                    tableData, users, appSettings, customButtons,
3330.	                    customColumns, basicColumns, dateValidationColumns,
3331.	                    tabs, currentUser
3332.	                );
3333.	 
3334.	                storageManager.saveToGitHub(appData, currentUser)
3335.	                    .then(() => {
3336.	                        updateSyncStatus('Синхронизировано вручную: ' + new Date().toLocaleTimeString(), 'success');
3337.	                    })
3338.	                    .catch(error => {
3339.	                        updateSyncStatus('Ошибка синхронизации: ' + error.message, 'error');
3340.	                    });
3341.	            });
3342.	            document.getElementById('load-from-github-btn').addEventListener('click', () => loadFromGitHub());
3343.	
3344.	            // Модальные окна
3345.	            document.querySelectorAll('.close').forEach(close => {
3346.	                close.addEventListener('click', function() {
3347.	                    this.closest('.modal').style.display = 'none';
3348.	                });
3349.	            });
3350.	
3351.	            // Формы
3352.	            document.getElementById('add-button-form').addEventListener('submit', handleAddButton);
3353.	            document.getElementById('add-user-form').addEventListener('submit', handleAddUser);
3354.	            document.getElementById('column-count').addEventListener('change', generateColumnInputs);
3355.	            document.getElementById('save-cell-btn').addEventListener('click', saveCellChanges);
3356.	            document.getElementById('close-file-modal').addEventListener('click', function() {
3357.	                document.getElementById('edit-cell-modal').style.display = 'none';
3358.	                currentFileManagementCell = null;
3359.	            });
3360.	
3361.	            // Кнопки предпросмотра
3362.	            document.getElementById('download-preview-btn').addEventListener('click', downloadPreviewFile);
3363.	            document.getElementById('copy-preview-btn').addEventListener('click', copyPreviewFile);
3364.	            document.getElementById('print-preview-btn').addEventListener('click', printPreviewFile);
3365.	
3366.	            // Работа с файлами
3367.	            const fileUploadArea = document.getElementById('file-upload-area');
3368.	            const fileInput = document.getElementById('file-input');
3369.	 
3370.	            fileUploadArea.addEventListener('click', function() {
3371.	                fileInput.click();
3372.	            });
3373.	
3374.	            fileInput.addEventListener('change', function(e) {
3375.	                handleFileUpload(e.target.files);
3376.	            });
3377.	
3378.	            setupFileDropZone();
3379.	
3380.	            // Логотип
3381.	            document.getElementById('header-logo').addEventListener('click', triggerLogoUpload);
3382.	            document.getElementById('logo-upload').addEventListener('change', handleLogoUpload);
3383.	
3384.	            // Закрытие фильтров при клике вне их
3385.	            document.addEventListener('click', function(e) {
3386.	                if (!e.target.closest('.filter-dropdown') && !e.target.closest('.filter-btn')) {
3387.	                    closeAllFilterDropdowns();
3388.	                }
3389.	                if (!e.target.closest('.date-picker') && !e.target.classList.contains('date-cell')) {
3390.	                    closeDatePicker();
3391.	                }
3392.	                if (!e.target.closest('.date-input-overlay') && currentDateInput) {
3393.	                    closeDateInput();
3394.	                }
3395.	            });
3396.	
3397.	            // Исправление проблемы с прокруткой фильтра
3398.	            document.addEventListener('mousedown', function(e) {
3399.	                if (e.target.closest('.filter-options')) {
3400.	                    e.stopPropagation();
3401.	                }
3402.	            });
3403.	        }
3404.	
3405.	        function handleGitHubSettingsSave(e) {
3406.	            e.preventDefault();
3407.	 
3408.	            const token = document.getElementById('github-token').value;
3409.	            const repo = document.getElementById('github-repo').value;
3410.	            const branch = document.getElementById('github-branch').value;
3411.	 
3412.	            storageManager.updateGitHubConfig(token, repo, branch);
3413.	 
3414.	            document.getElementById('github-sync-modal').style.display = 'none';
3415.	            alert('Настройки GitHub сохранены!');
3416.	        }
3417.	
3418.	        // ОБНОВЛЕННАЯ ФУНКЦИЯ ВХОДА
3419.	        function handleLogin() {
3420.	            const username = document.getElementById('username').value;
3421.	            const password = document.getElementById('password').value;
3422.	
3423.	            const user = users.find(u => u.username === username && u.password === password);
3424.	            if (user) {
3425.	                currentUser = user;
3426.	                document.getElementById('login-screen').style.display = 'none';
3427.	                document.getElementById('main-screen').style.display = 'flex';
3428.	                document.getElementById('user-role').textContent = user.role === 'admin' ? 'Администратор' : 'Пользователь';
3429.	                document.getElementById('user-name-display').textContent = user.username;
3430.	 
3431.	                if (user.role === 'admin') {
3432.	                    document.body.classList.add('admin');
3433.	                    setupAdminFeatures();
3434.	                }
3435.	 
3436.	                onlineUsers[user.username] = {
3437.	                    username: user.username,
3438.	                    role: user.role,
3439.	                    lastActive: Date.now()
3440.	                };
3441.	                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
3442.	                updateStatusBar();
3443.	 
3444.	                initializeAppWithFallback();
3445.	 
3446.	                setTimeout(() => {
3447.	                    checkAllDates();
3448.	                }, 1000);
3449.	            } else {
3450.	                alert('Неверное имя пользователя или пароль');
3451.	            }
3452.	        }
3453.	
3454.	        // ОБНОВЛЕННАЯ ФУНКЦИЯ ВЫХОДА
3455.	        function handleLogout() {
3456.	            if (currentUser) {
3457.	                delete onlineUsers[currentUser.username];
3458.	                localStorage.setItem('onlineUsers', JSON.stringify(onlineUsers));
3459.	                updateStatusBar();
3460.	            }
3461.	 
3462.	            currentUser = null;
3463.	            document.getElementById('main-screen').style.display = 'none';
3464.	            document.getElementById('login-screen').style.display = 'flex';
3465.	            document.body.classList.remove('admin');
3466.	        }
3467.	
3468.	        function setupAdminFeatures() {
3469.	            const headerTitle = document.getElementById('header-title');
3470.	            headerTitle.classList.add('editable');
3471.	            headerTitle.contentEditable = 'true';
3472.	            headerTitle.addEventListener('blur', function() {
3473.	                appSettings.headerTitle = this.textContent;
3474.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3475.	                autoSyncChanges();
3476.	            });
3477.	 
3478.	            headerTitle.addEventListener('keydown', function(e) {
3479.	                if (e.key === 'Enter') {
3480.	                    e.preventDefault();
3481.	                    this.blur();
3482.	                }
3483.	            });
3484.	
3485.	            document.getElementById('fixed-columns-count').value = appSettings.fixedColumnsCount;
3486.	        }
3487.	
3488.	        // ОСТАВШИЕСЯ ФУНКЦИИ (без изменений в логике)
3489.	        function showAllColumns() {
3490.	            const allCells = document.querySelectorAll('#data-table th, #data-table td');
3491.	            allCells.forEach(cell => cell.style.display = '');
3492.	        }
3493.	
3494.	        function addNewRow() {
3495.	            const newId = tableData.length > 0 ? Math.max(...tableData.map(row => row.id)) + 1 : 1;
3496.	            const newRow = {
3497.	                id: newId,
3498.	                name: 'Новый проект',
3499.	                date: formatDate(new Date()),
3500.	                status: 'Активен',
3501.	                customData: {},
3502.	                attachments: {}
3503.	            };
3504.	 
3505.	            tableData.push(newRow);
3506.	 
3507.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
3508.	            if (currentTab) {
3509.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
3510.	            }
3511.	 
3512.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3513.	            autoSyncChanges();
3514.	 
3515.	            renderTable();
3516.	 
3517.	            setTimeout(() => {
3518.	                const newRowElement = document.querySelector(`tr:last-child`);
3519.	                if (newRowElement) {
3520.	                    newRowElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
3521.	                }
3522.	            }, 100);
3523.	        }
3524.	
3525.	        function showModal(modalId) {
3526.	            document.getElementById(modalId).style.display = 'flex';
3527.	 
3528.	            if (modalId === 'users-modal') {
3529.	                renderUsersList();
3530.	            } else if (modalId === 'add-button-modal') {
3531.	                generateColumnInputs();
3532.	            } else if (modalId === 'github-sync-modal') {
3533.	                const config = storageManager.getConfig();
3534.	                document.getElementById('github-token').value = config.token;
3535.	                document.getElementById('github-repo').value = config.repo;
3536.	                document.getElementById('github-branch').value = config.branch;
3537.	            } else if (modalId === 'move-column-modal') {
3538.	                showMoveColumnModal();
3539.	            }
3540.	        }
3541.	
3542.	        function generateColumnInputs() {
3543.	            const count = parseInt(document.getElementById('column-count').value);
3544.	            const container = document.getElementById('columns-container');
3545.	            const dateContainer = document.getElementById('date-validation-columns');
3546.	 
3547.	            container.innerHTML = '';
3548.	            dateContainer.innerHTML = '';
3549.	 
3550.	            for (let i = 0; i < count; i++) {
3551.	                const inputGroup = document.createElement('div');
3552.	                inputGroup.style.marginBottom = '10px';
3553.	                inputGroup.innerHTML = `
3554.	                    <input type="text" placeholder="Название столбца ${i + 1}" required
3555.	                           style="width: 100%; padding: 0.5rem; border: 1px solid #4a4a4a; border-radius: 5px; background: #2f2f2f; color: #ecf0f1;">
3556.	                `;
3557.	                container.appendChild(inputGroup);
3558.	
3559.	                const dateCheckbox = document.createElement('div');
3560.	                dateCheckbox.style.marginBottom = '5px';
3561.	                dateCheckbox.innerHTML = `
3562.	                    <label style="display: flex; align-items: center; gap: 5px; font-size: 0.9rem; color: #bdc3c7;">
3563.	                        <input type="checkbox" class="column-date-validation" data-column-index="${i}">
3564.	                        Проверять даты в столбце "${i + 1}"
3565.	                    </label>
3566.	                `;
3567.	                dateContainer.appendChild(dateCheckbox);
3568.	            }
3569.	        }
3570.	
3571.	        function handleAddButton(e) {
3572.	            e.preventDefault();
3573.	            const buttonName = document.getElementById('button-name').value;
3574.	            const columnInputs = document.getElementById('columns-container').querySelectorAll('input');
3575.	            const dateCheckboxes = document.querySelectorAll('.column-date-validation');
3576.	 
3577.	            const columns = Array.from(columnInputs)
3578.	                .map(input => input.value.trim())
3579.	                .filter(name => name !== '');
3580.	 
3581.	            const buttonId = 'btn_' + Date.now();
3582.	            const buttonData = {
3583.	                id: buttonId,
3584.	                name: buttonName,
3585.	                columns: columns
3586.	            };
3587.	 
3588.	            customButtons.push(buttonData);
3589.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3590.	            autoSyncChanges();
3591.	 
3592.	            columns.forEach((colName, index) => {
3593.	                const columnId = 'col_' + Date.now() + '_' + index;
3594.	                if (!customColumns.find(col => col.name === colName)) {
3595.	                    customColumns.push({
3596.	                        id: columnId,
3597.	                        name: colName
3598.	                    });
3599.	                }
3600.	 
3601.	                const dateCheckbox = dateCheckboxes[index];
3602.	                if (dateCheckbox && dateCheckbox.checked) {
3603.	                    dateValidationColumns[columnId] = true;
3604.	                }
3605.	            });
3606.	 
3607.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3608.	            autoSyncChanges();
3609.	 
3610.	            createCustomButton(buttonData);
3611.	            renderTable();
3612.	            document.getElementById('add-button-modal').style.display = 'none';
3613.	            document.getElementById('add-button-form').reset();
3614.	        }
3615.	
3616.	        // ИСПРАВЛЕННАЯ ФУНКЦИЯ СОЗДАНИЯ КАСТОМНОЙ КНОПКИ
3617.	        function createCustomButton(buttonData) {
3618.	            const buttonWrapper = document.createElement('div');
3619.	            buttonWrapper.className = 'custom-button-wrapper';
3620.	 
3621.	            const button = document.createElement('button');
3622.	            button.className = 'custom-button';
3623.	            button.dataset.buttonId = buttonData.id;
3624.	            button.dataset.columns = JSON.stringify(buttonData.columns);
3625.	            button.title = `Показать столбцы: ${buttonData.columns.join(', ')}`;
3626.	 
3627.	            const buttonText = document.createElement('span');
3628.	            buttonText.className = 'button-text';
3629.	            buttonText.textContent = buttonData.name;
3630.	 
3631.	            button.appendChild(buttonText);
3632.	 
3633.	            if (currentUser && currentUser.role === 'admin') {
3634.	                const actionsContainer = document.createElement('div');
3635.	                actionsContainer.className = 'button-actions';
3636.	 
3637.	                const editBtn = document.createElement('button');
3638.	                editBtn.className = 'btn-edit-small';
3639.	                editBtn.innerHTML = '✎';
3640.	                editBtn.title = 'Редактировать кнопку';
3641.	                editBtn.onclick = (e) => {
3642.	                    e.stopPropagation();
3643.	                    editButton(buttonData.id);
3644.	                };
3645.	 
3646.	                const deleteBtn = document.createElement('button');
3647.	                deleteBtn.className = 'btn-danger-small';
3648.	                deleteBtn.innerHTML = '×';
3649.	                deleteBtn.title = 'Удалить кнопку';
3650.	                deleteBtn.onclick = (e) => {
3651.	                    e.stopPropagation();
3652.	                    deleteButton(buttonData.id);
3653.	                };
3654.	 
3655.	                actionsContainer.appendChild(editBtn);
3656.	                actionsContainer.appendChild(deleteBtn);
3657.	 
3658.	                buttonWrapper.appendChild(button);
3659.	                buttonWrapper.appendChild(actionsContainer);
3660.	            } else {
3661.	                buttonWrapper.appendChild(button);
3662.	            }
3663.	 
3664.	            button.addEventListener('click', function(e) {
3665.	                if (!e.target.classList.contains('btn-edit-small') && !e.target.classList.contains('btn-danger-small')) {
3666.	                    const columns = JSON.parse(this.dataset.columns);
3667.	 
3668.	                    const allCells = document.querySelectorAll('#data-table th, #data-table td');
3669.	                    allCells.forEach(cell => cell.style.display = 'none');
3670.	 
3671.	                    for (let i = 0; i < appSettings.fixedColumnsCount; i++) {
3672.	                        const headerCells = document.querySelectorAll(`#data-table th:nth-child(${i + 1})`);
3673.	                        const dataCells = document.querySelectorAll(`#data-table td:nth-child(${i + 1})`);
3674.	 
3675.	                        headerCells.forEach(cell => cell.style.display = '');
3676.	                        dataCells.forEach(cell => cell.style.display = '');
3677.	                    }
3678.	 
3679.	                    columns.forEach(colName => {
3680.	                        const customHeaders = document.querySelectorAll(`th\[data-column-name="${colName}"]`);
3681.	                        const customCells = document.querySelectorAll(`td\[data-column-name="${colName}"]`);
3682.	 
3683.	                        customHeaders.forEach(cell => cell.style.display = '');
3684.	                        customCells.forEach(cell => cell.style.display = '');
3685.	                    });
3686.	                }
3687.	            });
3688.	 
3689.	            document.getElementById('custom-buttons').appendChild(buttonWrapper);
3690.	        }
3691.	
3692.	        function editButton(buttonId) {
3693.	            const button = customButtons.find(b => b.id === buttonId);
3694.	            if (!button) return;
3695.	 
3696.	            const newName = prompt('Введите новое название кнопки:', button.name);
3697.	            if (newName && newName.trim() !== '') {
3698.	                button.name = newName.trim();
3699.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3700.	                autoSyncChanges();
3701.	                loadCustomButtons();
3702.	            }
3703.	        }
3704.	
3705.	        function deleteButton(buttonId) {
3706.	            if (!confirm('Удалить эту кнопку и связанные с ней столбцы?')) return;
3707.	 
3708.	            const button = customButtons.find(b => b.id === buttonId);
3709.	            if (!button) return;
3710.	 
3711.	            customButtons = customButtons.filter(b => b.id !== buttonId);
3712.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3713.	            autoSyncChanges();
3714.	 
3715.	            button.columns.forEach(colName => {
3716.	                customColumns = customColumns.filter(col => col.name !== colName);
3717.	 
3718.	                tableData.forEach(row => {
3719.	                    if (row.customData && row.customData[colName]) {
3720.	                        delete row.customData[colName];
3721.	                    }
3722.	                    if (row.attachments && row.attachments[colName]) {
3723.	                        delete row.attachments[colName];
3724.	                    }
3725.	                });
3726.	            });
3727.	 
3728.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3729.	            autoSyncChanges();
3730.	 
3731.	            loadCustomButtons();
3732.	            renderTable();
3733.	        }
3734.	
3735.	        function loadCustomButtons() {
3736.	            document.getElementById('custom-buttons').innerHTML = '';
3737.	            customButtons.forEach(button => {
3738.	                createCustomButton(button);
3739.	            });
3740.	        }
3741.	
3742.	        // ФУНКЦИИ ДЛЯ РАБОТЫ С ДАТАМИ
3743.	        function isValidDate(dateString) {
3744.	            const regex = /^\d{2}\.\d{2}\.\d{4}$/;
3745.	            if (!regex.test(dateString)) return false;
3746.	 
3747.	            const parts = dateString.split('.');
3748.	            const day = parseInt(parts[0], 10);
3749.	            const month = parseInt(parts[1], 10) - 1;
3750.	            const year = parseInt(parts[2], 10);
3751.	 
3752.	            const date = new Date(year, month, day);
3753.	            return date.getDate() === day && date.getMonth() === month && date.getFullYear() === year;
3754.	        }
3755.	
3756.	        function parseDate(dateString) {
3757.	            if (!dateString) return new Date();
3758.	            const regex = /^\d{2}\.\d{2}\.\d{4}$/;
3759.	            if (!regex.test(dateString)) return new Date();
3760.	 
3761.	            const parts = dateString.split('.');
3762.	            const day = parseInt(parts[0], 10);
3763.	            const month = parseInt(parts[1], 10) - 1;
3764.	            const year = parseInt(parts[2], 10);
3765.	 
3766.	            return new Date(year, month, day);
3767.	        }
3768.	
3769.	        function formatDate(date) {
3770.	            const day = String(date.getDate()).padStart(2, '0');
3771.	            const month = String(date.getMonth() + 1).padStart(2, '0');
3772.	            const year = date.getFullYear();
3773.	            return `${day}.${month}.${year}`;
3774.	        }
3775.	
3776.	        function openDatePicker(cell, currentValue) {
3777.	            closeDatePicker();
3778.	            closeDateInput();
3779.	 
3780.	            const datePicker = document.createElement('div');
3781.	            datePicker.className = 'date-picker';
3782.	 
3783.	            const today = new Date();
3784.	            let currentDate = today;
3785.	            if (currentValue && isValidDate(currentValue)) {
3786.	                currentDate = parseDate(currentValue);
3787.	            }
3788.	 
3789.	            const cellRect = cell.getBoundingClientRect();
3790.	            datePicker.style.position = 'fixed';
3791.	            datePicker.style.left = cellRect.left + 'px';
3792.	            datePicker.style.top = (cellRect.bottom + 5) + 'px';
3793.	            datePicker.style.zIndex = '10000';
3794.	 
3795.	            renderDatePicker(datePicker, currentDate, cell);
3796.	 
3797.	            document.body.appendChild(datePicker);
3798.	            currentDatePicker = { element: datePicker, cell: cell };
3799.	        }
3800.	
3801.	        function renderDatePicker(container, date, cell) {
3802.	            const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
3803.	            const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
3804.	 
3805.	            const currentMonth = date.getMonth();
3806.	            const currentYear = date.getFullYear();
3807.	 
3808.	            const firstDay = new Date(currentYear, currentMonth, 1);
3809.	            const lastDay = new Date(currentYear, currentMonth + 1, 0);
3810.	 
3811.	            let html = `
3812.	                <div class="date-picker-header">
3813.	                    <button class="month-nav-btn" data-offset="-1">‹</button>
3814.	                    <strong>${monthNames[currentMonth]} ${currentYear}</strong>
3815.	                    <button class="month-nav-btn" data-offset="1">›</button>
3816.	                </div>
3817.	                <div class="date-picker-grid">
3818.	            `;
3819.	 
3820.	            dayNames.forEach(day => {
3821.	                html += `<div style="text-align: center; font-weight: bold; padding: 5px;">${day}</div>`;
3822.	            });
3823.	 
3824.	            for (let i = 0; i < (firstDay.getDay() + 6) % 7; i++) {
3825.	                html += '<div></div>';
3826.	            }
3827.	 
3828.	            for (let day = 1; day <= lastDay.getDate(); day++) {
3829.	                const dateStr = formatDate(new Date(currentYear, currentMonth, day));
3830.	                const isToday = day === new Date().getDate() && currentMonth === new Date().getMonth() && currentYear === new Date().getFullYear();
3831.	                const cellText = cell.querySelector('.cell-text');
3832.	                const isSelected = cellText && dateStr === cellText.textContent;
3833.	 
3834.	                html += `
3835.	                    <div class="date-picker-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}"
3836.	                         data-date="${dateStr}">
3837.	                        ${day}
3838.	                    </div>
3839.	                `;
3840.	            }
3841.	 
3842.	            html += '</div>';
3843.	            container.innerHTML = html;
3844.	 
3845.	            container.querySelectorAll('.month-nav-btn').forEach(btn => {
3846.	                btn.addEventListener('click', function(e) {
3847.	                    e.stopPropagation();
3848.	                    const offset = parseInt(this.dataset.offset);
3849.	                    const newDate = new Date(currentYear, currentMonth + offset, 1);
3850.	                    renderDatePicker(container, newDate, cell);
3851.	                });
3852.	            });
3853.	 
3854.	            container.querySelectorAll('.date-picker-day').forEach(dayEl => {
3855.	                dayEl.addEventListener('click', function(e) {
3856.	                    e.stopPropagation();
3857.	                    const dateStr = this.dataset.date;
3858.	                    selectDate(dateStr, cell);
3859.	                });
3860.	            });
3861.	        }
3862.	
3863.	        function selectDate(dateStr, cell) {
3864.	            const cellText = cell.querySelector('.cell-text');
3865.	            cellText.textContent = dateStr;
3866.	 
3867.	            const columnId = cell.dataset.columnId;
3868.	            const rowId = parseInt(cell.closest('tr').querySelector('td:nth-child(2)').textContent);
3869.	 
3870.	            const rowData = tableData.find(row => row.id === rowId);
3871.	            if (customColumns.find(col => col.id === columnId)) {
3872.	                if (!rowData.customData) rowData.customData = {};
3873.	                rowData.customData[columnId] = dateStr;
3874.	            } else {
3875.	                switch(columnId) {
3876.	                    case 'date': rowData.date = dateStr; break;
3877.	                }
3878.	            }
3879.	 
3880.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
3881.	            if (currentTab) {
3882.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
3883.	            }
3884.	 
3885.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3886.	            autoSyncChanges();
3887.	 
3888.	            closeDatePicker();
3889.	            renderTable();
3890.	            checkAllDates();
3891.	        }
3892.	
3893.	        function openDateInput(cell, currentValue) {
3894.	            closeDatePicker();
3895.	            closeDateInput();
3896.	 
3897.	            const overlay = document.createElement('div');
3898.	            overlay.className = 'date-input-overlay';
3899.	 
3900.	            const input = document.createElement('input');
3901.	            input.type = 'text';
3902.	            input.className = 'date-input';
3903.	            input.value = currentValue || '';
3904.	            input.placeholder = 'дд.мм.гггг';
3905.	 
3906.	            overlay.appendChild(input);
3907.	            cell.appendChild(overlay);
3908.	            input.focus();
3909.	            input.select();
3910.	 
3911.	            currentDateInput = { element: overlay, cell: cell, input: input };
3912.	 
3913.	            input.addEventListener('keydown', function(e) {
3914.	                if (e.key === 'Enter') {
3915.	                    saveDateInput();
3916.	                } else if (e.key === 'Escape') {
3917.	                    closeDateInput();
3918.	                }
3919.	            });
3920.	 
3921.	            input.addEventListener('blur', function() {
3922.	                setTimeout(() => {
3923.	                    if (currentDateInput && currentDateInput.input === input) {
3924.	                        saveDateInput();
3925.	                    }
3926.	                }, 100);
3927.	            });
3928.	        }
3929.	
3930.	        function saveDateInput() {
3931.	            if (!currentDateInput) return;
3932.	 
3933.	            const dateStr = currentDateInput.input.value;
3934.	            const cell = currentDateInput.cell;
3935.	 
3936.	            if (dateStr && isValidDate(dateStr)) {
3937.	                const cellText = cell.querySelector('.cell-text');
3938.	                cellText.textContent = dateStr;
3939.	 
3940.	                const columnId = cell.dataset.columnId;
3941.	                const rowId = parseInt(cell.closest('tr').querySelector('td:nth-child(2)').textContent);
3942.	 
3943.	                const rowData = tableData.find(row => row.id === rowId);
3944.	                if (customColumns.find(col => col.id === columnId)) {
3945.	                    if (!rowData.customData) rowData.customData = {};
3946.	                    rowData.customData[columnId] = dateStr;
3947.	                } else {
3948.	                    switch(columnId) {
3949.	                        case 'date': rowData.date = dateStr; break;
3950.	                    }
3951.	                }
3952.	 
3953.	                const currentTab = tabs.find(tab => tab.id === currentTabId);
3954.	                if (currentTab) {
3955.	                    currentTab.data = JSON.parse(JSON.stringify(tableData));
3956.	                }
3957.	 
3958.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
3959.	                autoSyncChanges();
3960.	 
3961.	                renderTable();
3962.	                checkAllDates();
3963.	            } else if (dateStr) {
3964.	                alert('Неверный формат даты! Используйте формат дд.мм.гггг');
3965.	            }
3966.	 
3967.	            closeDateInput();
3968.	        }
3969.	
3970.	        function closeDateInput() {
3971.	            if (currentDateInput) {
3972.	                currentDateInput.element.remove();
3973.	                currentDateInput = null;
3974.	            }
3975.	        }
3976.	
3977.	        function closeDatePicker() {
3978.	            if (currentDatePicker) {
3979.	                currentDatePicker.element.remove();
3980.	                currentDatePicker = null;
3981.	            }
3982.	        }
3983.	
3984.	        function checkAllDates() {
3985.	            const expiredDates = [];
3986.	            const upcomingDates = [];
3987.	            const today = new Date();
3988.	            today.setHours(0, 0, 0, 0);
3989.	 
3990.	            tableData.forEach(row => {
3991.	                basicColumns.forEach(column => {
3992.	                    if (dateValidationColumns[column.id] && row[column.id]) {
3993.	                        checkDateCell(row, column.id, column.name, today, expiredDates, upcomingDates);
3994.	                    }
3995.	                });
3996.	 
3997.	                customColumns.forEach(column => {
3998.	                    if (dateValidationColumns[column.id] && row.customData && row.customData[column.id]) {
3999.	                        checkDateCell(row, column.id, column.name, today, expiredDates, upcomingDates);
4000.	                    }
4001.	                });
4002.	            });
4003.	 
4004.	            showDateNotifications(expiredDates, upcomingDates);
4005.	            renderTable();
4006.	        }
4007.	
4008.	        function checkDateCell(row, columnId, columnName, today, expiredDates, upcomingDates) {
4009.	            let dateValue;
4010.	 
4011.	            if (customColumns.find(col => col.id === columnId)) {
4012.	                dateValue = row.customData[columnId];
4013.	            } else {
4014.	                dateValue = row[columnId];
4015.	            }
4016.	 
4017.	            if (isValidDate(dateValue)) {
4018.	                const cellDate = parseDate(dateValue);
4019.	                const timeDiff = cellDate.getTime() - today.getTime();
4020.	                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
4021.	 
4022.	                if (daysDiff < 0) {
4023.	                    expiredDates.push({
4024.	                        date: dateValue,
4025.	                        columnName: columnName,
4026.	                        rowName: row.name || '',
4027.	                        rowStatus: row.status || '',
4028.	                        daysOverdue: Math.abs(daysDiff)
4029.	                    });
4030.	                } else if (daysDiff <= 30) {
4031.	                    upcomingDates.push({
4032.	                        date: dateValue,
4033.	                        columnName: columnName,
4034.	                        rowName: row.name || '',
4035.	                        rowStatus: row.status || '',
4036.	                        daysLeft: daysDiff
4037.	                    });
4038.	                }
4039.	            }
4040.	        }
4041.	
4042.	        function showDateNotifications(expiredDates, upcomingDates) {
4043.	            const oldNotification = document.querySelector('.notification-panel');
4044.	            if (oldNotification) {
4045.	                oldNotification.remove();
4046.	            }
4047.	 
4048.	            if (expiredDates.length === 0 && upcomingDates.length === 0) {
4049.	                return;
4050.	            }
4051.	 
4052.	            const notificationPanel = document.createElement('div');
4053.	            notificationPanel.className = 'notification-panel';
4054.	 
4055.	            let notificationHTML = `
4056.	                <div class="notification-header">
4057.	                    <h4>🔔 Проверка дат</h4>
4058.	                    <button class="close-notifications">×</button>
4059.	                </div>
4060.	                <div class="notification-content">
4061.	            `;
4062.	 
4063.	            if (expiredDates.length > 0) {
4064.	                notificationHTML += `<h5 style="color: #e67e22; margin-bottom: 10px;">Просроченные даты (${expiredDates.length}):</h5>`;
4065.	                expiredDates.forEach(item => {
4066.	                    notificationHTML += `
4067.	                        <div class="notification-item danger">
4068.	                            <strong>${item.date}</strong> - просрочено на ${item.daysOverdue} дн.<br>
4069.	                            <small>${item.columnName} | ${item.rowName} | ${item.rowStatus}</small>
4070.	                        </div>
4071.	                    `;
4072.	                });
4073.	            }
4074.	 
4075.	            if (upcomingDates.length > 0) {
4076.	                notificationHTML += `<h5 style="color: #e67e22; margin-bottom: 10px; margin-top: 15px;">Приближающиеся даты (${upcomingDates.length}):</h5>`;
4077.	                upcomingDates.forEach(item => {
4078.	                    notificationHTML += `
4079.	                        <div class="notification-item warning">
4080.	                            <strong>${item.date}</strong> - осталось ${item.daysLeft} дн.<br>
4081.	                            <small>${item.columnName} | ${item.rowName} | ${item.rowStatus}</small>
4082.	                        </div>
4083.	                    `;
4084.	                });
4085.	            }
4086.	 
4087.	            notificationHTML += `</div>`;
4088.	            notificationPanel.innerHTML = notificationHTML;
4089.	 
4090.	            document.body.appendChild(notificationPanel);
4091.	 
4092.	            notificationPanel.querySelector('.close-notifications').addEventListener('click', function() {
4093.	                notificationPanel.remove();
4094.	            });
4095.	        }
4096.	
4097.	        // ФУНКЦИИ СОРТИРОВКИ
4098.	        function handleSort(columnId) {
4099.	            if (currentSort.column === columnId) {
4100.	                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
4101.	            } else {
4102.	                currentSort.column = columnId;
4103.	                currentSort.direction = 'asc';
4104.	            }
4105.	 
4106.	            renderTable();
4107.	        }
4108.	
4109.	        function applySorting(data) {
4110.	            if (!currentSort.column) return data;
4111.	 
4112.	            return [...data].sort((a, b) => {
4113.	                let valueA, valueB;
4114.	 
4115.	                if (customColumns.find(col => col.id === currentSort.column)) {
4116.	                    valueA = a.customData && a.customData[currentSort.column] ? a.customData[currentSort.column] : '';
4117.	                    valueB = b.customData && b.customData[currentSort.column] ? b.customData[currentSort.column] : '';
4118.	                } else {
4119.	                    switch(currentSort.column) {
4120.	                        case 'id': valueA = a.id; valueB = b.id; break;
4121.	                        case 'name': valueA = a.name || ''; valueB = b.name || ''; break;
4122.	                        case 'date': valueA = a.date || ''; valueB = b.date || ''; break;
4123.	                        case 'status': valueA = a.status || ''; valueB = b.status || ''; break;
4124.	                        default: valueA = ''; valueB = '';
4125.	                    }
4126.	                }
4127.	 
4128.	                if (currentSort.direction === 'asc') {
4129.	                    return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
4130.	                } else {
4131.	                    return valueA > valueB ? -1 : valueA < valueB ? 1 : 0;
4132.	                }
4133.	            });
4134.	        }
4135.	
4136.	        // ФУНКЦИИ ФИЛЬТРАЦИИ
4137.	        function toggleFilter(columnId, filterBtn, th) {
4138.	            closeAllFilterDropdowns();
4139.	 
4140.	            const existingFilter = document.querySelector(`.filter-dropdown\[data-column="${columnId}"]`);
4141.	            if (existingFilter) {
4142.	                existingFilter.remove();
4143.	                filterBtn.classList.remove('active');
4144.	                return;
4145.	            }
4146.	 
4147.	            const filterDropdown = document.createElement('div');
4148.	            filterDropdown.className = 'filter-dropdown';
4149.	            filterDropdown.dataset.column = columnId;
4150.	 
4151.	            const thRect = th.getBoundingClientRect();
4152.	            filterDropdown.style.position = 'fixed';
4153.	            filterDropdown.style.left = thRect.left + 'px';
4154.	            filterDropdown.style.top = thRect.bottom + 'px';
4155.	            filterDropdown.style.zIndex = '10000';
4156.	 
4157.	            const viewportWidth = window.innerWidth;
4158.	            const filterWidth = 320;
4159.	            if (thRect.left + filterWidth > viewportWidth) {
4160.	                filterDropdown.style.left = (viewportWidth - filterWidth - 10) + 'px';
4161.	            }
4162.	 
4163.	            const uniqueValues = getUniqueValuesForColumn(columnId);
4164.	            const totalCount = uniqueValues.length;
4165.	            const selectedCount = currentFilters[columnId] ? currentFilters[columnId].length : totalCount;
4166.	 
4167.	            const filterHeader = document.createElement('div');
4168.	            filterHeader.className = 'filter-header';
4169.	 
4170.	            const filterTitle = document.createElement('div');
4171.	            filterTitle.className = 'filter-title';
4172.	            filterTitle.textContent = 'Фильтр';
4173.	 
4174.	            const filterClose = document.createElement('button');
4175.	            filterClose.className = 'filter-close';
4176.	            filterClose.innerHTML = '×';
4177.	            filterClose.title = 'Закрыть';
4178.	            filterClose.onclick = closeAllFilterDropdowns;
4179.	 
4180.	            filterHeader.appendChild(filterTitle);
4181.	            filterHeader.appendChild(filterClose);
4182.	 
4183.	            const filterCount = document.createElement('div');
4184.	            filterCount.className = 'filter-count';
4185.	            filterCount.textContent = `Выбрано: ${selectedCount} из ${totalCount}`;
4186.	 
4187.	            const searchInput = document.createElement('input');
4188.	            searchInput.type = 'text';
4189.	            searchInput.className = 'filter-search';
4190.	            searchInput.placeholder = 'Поиск в фильтре...';
4191.	 
4192.	            const optionsContainer = document.createElement('div');
4193.	            optionsContainer.className = 'filter-options';
4194.	 
4195.	            const selectAllOption = document.createElement('div');
4196.	            selectAllOption.className = 'filter-option';
4197.	 
4198.	            const selectAllCheckbox = document.createElement('input');
4199.	            selectAllCheckbox.type = 'checkbox';
4200.	            selectAllCheckbox.id = 'select-all';
4201.	            selectAllCheckbox.checked = selectedCount === totalCount;
4202.	 
4203.	            const selectAllLabel = document.createElement('label');
4204.	            selectAllLabel.htmlFor = 'select-all';
4205.	            selectAllLabel.textContent = '(Выбрать все)';
4206.	 
4207.	            selectAllOption.appendChild(selectAllCheckbox);
4208.	            selectAllOption.appendChild(selectAllLabel);
4209.	            optionsContainer.appendChild(selectAllOption);
4210.	 
4211.	            const separator = document.createElement('div');
4212.	            separator.style.height = '1px';
4213.	            separator.style.background = '#4a4a4a';
4214.	            separator.style.margin = '4px 0';
4215.	            optionsContainer.appendChild(separator);
4216.	 
4217.	            uniqueValues.forEach(value => {
4218.	                const option = document.createElement('div');
4219.	                option.className = 'filter-option';
4220.	 
4221.	                const checkbox = document.createElement('input');
4222.	                checkbox.type = 'checkbox';
4223.	                checkbox.value = value;
4224.	                checkbox.id = `filter-${columnId}-${value}`;
4225.	                checkbox.checked = !currentFilters[columnId] || currentFilters[columnId].includes(value);
4226.	 
4227.	                const label = document.createElement('label');
4228.	                label.htmlFor = `filter-${columnId}-${value}`;
4229.	                label.textContent = value || '(пусто)';
4230.	                label.title = value || '(пусто)';
4231.	 
4232.	                option.appendChild(checkbox);
4233.	                option.appendChild(label);
4234.	                optionsContainer.appendChild(option);
4235.	            });
4236.	 
4237.	            const actionsContainer = document.createElement('div');
4238.	            actionsContainer.className = 'filter-actions';
4239.	 
4240.	            const okBtn = document.createElement('button');
4241.	            okBtn.textContent = 'OK';
4242.	            okBtn.className = 'btn-primary';
4243.	            okBtn.onclick = () => applyFilter(columnId, filterDropdown, filterBtn);
4244.	 
4245.	            const cancelBtn = document.createElement('button');
4246.	            cancelBtn.textContent = 'Отмена';
4247.	            cancelBtn.onclick = closeAllFilterDropdowns;
4248.	 
4249.	            actionsContainer.appendChild(okBtn);
4250.	            actionsContainer.appendChild(cancelBtn);
4251.	 
4252.	            filterDropdown.appendChild(filterHeader);
4253.	            filterDropdown.appendChild(filterCount);
4254.	            filterDropdown.appendChild(searchInput);
4255.	            filterDropdown.appendChild(optionsContainer);
4256.	            filterDropdown.appendChild(actionsContainer);
4257.	 
4258.	            document.body.appendChild(filterDropdown);
4259.	            filterBtn.classList.add('active');
4260.	 
4261.	            searchInput.addEventListener('input', function() {
4262.	                const searchTerm = this.value.toLowerCase();
4263.	                let visibleCount = 0;
4264.	 
4265.	                Array.from(optionsContainer.children).forEach((option, index) => {
4266.	                    if (index < 2) return;
4267.	 
4268.	                    const label = option.querySelector('label');
4269.	                    const text = label.textContent.toLowerCase();
4270.	                    const isVisible = text.includes(searchTerm);
4271.	                    option.style.display = isVisible ? 'flex' : 'none';
4272.	 
4273.	                    if (isVisible) visibleCount++;
4274.	                });
4275.	 
4276.	                filterCount.textContent = `Найдено: ${visibleCount} из ${totalCount}`;
4277.	            });
4278.	 
4279.	            selectAllCheckbox.addEventListener('change', function() {
4280.	                const checkboxes = optionsContainer.querySelectorAll('input[type="checkbox"]:not(#select-all)');
4281.	                checkboxes.forEach(checkbox => {
4282.	                    checkbox.checked = this.checked;
4283.	                });
4284.	                filterCount.textContent = `Выбрано: ${this.checked ? totalCount : 0} из ${totalCount}`;
4285.	            });
4286.	 
4287.	            optionsContainer.addEventListener('change', function(e) {
4288.	                if (e.target.type === 'checkbox' && e.target.id !== 'select-all') {
4289.	                    const checkedBoxes = optionsContainer.querySelectorAll('input[type="checkbox"]:not(#select-all):checked');
4290.	                    selectAllCheckbox.checked = checkedBoxes.length === (totalCount);
4291.	                    filterCount.textContent = `Выбрано: ${checkedBoxes.length} из ${totalCount}`;
4292.	                }
4293.	            });
4294.	 
4295.	            setTimeout(() => searchInput.focus(), 100);
4296.	        }
4297.	
4298.	        function getUniqueValuesForColumn(columnId) {
4299.	            const values = new Set();
4300.	 
4301.	            tableData.forEach(row => {
4302.	                let value;
4303.	 
4304.	                if (customColumns.find(col => col.id === columnId)) {
4305.	                    value = row.customData && row.customData[columnId] ? row.customData[columnId] : '';
4306.	                } else {
4307.	                    switch(columnId) {
4308.	                        case 'id': value = row.id.toString(); break;
4309.	                        case 'name': value = row.name || ''; break;
4310.	                        case 'date': value = row.date || ''; break;
4311.	                        case 'status': value = row.status || ''; break;
4312.	                        default: value = '';
4313.	                    }
4314.	                }
4315.	 
4316.	                values.add(value);
4317.	            });
4318.	 
4319.	            return Array.from(values).sort();
4320.	        }
4321.	
4322.	        function applyFilter(columnId, filterDropdown, filterBtn) {
4323.	            const checkboxes = filterDropdown.querySelectorAll('input[type="checkbox"]:not(#select-all):checked');
4324.	            const selectedValues = Array.from(checkboxes).map(cb => cb.value);
4325.	 
4326.	            if (selectedValues.length > 0) {
4327.	                currentFilters[columnId] = selectedValues;
4328.	                filterBtn.classList.add('filtered');
4329.	            } else {
4330.	                delete currentFilters[columnId];
4331.	                filterBtn.classList.remove('filtered');
4332.	            }
4333.	 
4334.	            renderTable();
4335.	            closeAllFilterDropdowns();
4336.	        }
4337.	
4338.	        function closeAllFilterDropdowns() {
4339.	            document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
4340.	                dropdown.remove();
4341.	            });
4342.	            document.querySelectorAll('.filter-btn').forEach(btn => {
4343.	                btn.classList.remove('active');
4344.	            });
4345.	        }
4346.	
4347.	        // ФУНКЦИИ РЕДАКТИРОВАНИЯ ЯЧЕЕК
4348.	        function openEditHeaderModal(headerCell) {
4349.	            if (currentUser.role !== 'admin') return;
4350.	 
4351.	            currentEditingCell = headerCell;
4352.	            isEditingHeader = true;
4353.	 
4354.	            const currentValue = headerCell.textContent;
4355.	            document.getElementById('cell-value').value = currentValue;
4356.	            document.getElementById('edit-cell-title').textContent = 'Редактирование названия столбца';
4357.	 
4358.	            document.querySelector('.form-group:nth-child(3)').style.display = 'none';
4359.	            document.getElementById('save-cell-btn').style.display = 'block';
4360.	            document.getElementById('close-file-modal').style.display = 'none';
4361.	 
4362.	            document.getElementById('edit-cell-modal').style.display = 'flex';
4363.	        }
4364.	
4365.	        // ИСПРАВЛЕННАЯ ФУНКЦИЯ ОТКРЫТИЯ МОДАЛЬНОГО ОКНА ДЛЯ ФАЙЛОВ
4366.	        function openFileManagementModal(rowId, columnId) {
4367.	            if (currentUser.role !== 'admin') return;
4368.	 
4369.	            currentEditingCell = null;
4370.	            isEditingHeader = false;
4371.	 
4372.	            // Сохраняем информацию о ячейке для загрузки файлов
4373.	            currentFileManagementCell = { rowId, columnId };
4374.	 
4375.	            document.getElementById('edit-cell-title').textContent = 'Управление файлами ячейки';
4376.	            document.querySelector('.form-group:nth-child(2)').style.display = 'none';
4377.	            document.getElementById('save-cell-btn').style.display = 'none';
4378.	            document.getElementById('close-file-modal').style.display = 'block';
4379.	 
4380.	            loadAttachedFilesForCell(rowId, columnId);
4381.	            document.getElementById('edit-cell-modal').style.display = 'flex';
4382.	        }
4383.	
4384.	        function loadAttachedFiles(cell) {
4385.	            const container = document.getElementById('attached-files');
4386.	            container.innerHTML = '';
4387.	 
4388.	            if (isEditingHeader) return;
4389.	 
4390.	            const columnId = cell.dataset.columnId;
4391.	            const rowId = parseInt(cell.closest('tr').querySelector('td:nth-child(2)').textContent);
4392.	 
4393.	            const rowData = tableData.find(row => row.id === rowId);
4394.	            if (rowData && rowData.attachments && rowData.attachments[columnId]) {
4395.	                rowData.attachments[columnId].forEach((file, index) => {
4396.	                    const fileElement = document.createElement('div');
4397.	                    fileElement.className = 'attached-file';
4398.	 
4399.	                    let fileContent = file.name;
4400.	                    if (file.type.startsWith('image/')) {
4401.	                        fileContent = `<img src="${file.data}" style="max-width: 50px; max-height: 50px; margin-right: 10px;"> ${file.name}`;
4402.	                    }
4403.	 
4404.	                    fileElement.innerHTML = `
4405.	                        <div>${fileContent}</div>
4406.	                        <button class="file-action-btn" onclick="removeAttachment(${rowId}, '${columnId}', ${index})">×</button>
4407.	                    `;
4408.	                    container.appendChild(fileElement);
4409.	                });
4410.	            }
4411.	        }
4412.	
4413.	        function loadAttachedFilesForCell(rowId, columnId) {
4414.	            const container = document.getElementById('attached-files');
4415.	            container.innerHTML = '';
4416.	 
4417.	            const rowData = tableData.find(row => row.id === rowId);
4418.	            if (rowData && rowData.attachments && rowData.attachments[columnId]) {
4419.	                rowData.attachments[columnId].forEach((file, index) => {
4420.	                    const fileElement = document.createElement('div');
4421.	                    fileElement.className = 'attached-file';
4422.	 
4423.	                    let fileContent = file.name;
4424.	                    if (file.type.startsWith('image/')) {
4425.	                        fileContent = `<img src="${file.data}" style="max-width: 50px; max-height: 50px; margin-right: 10px;"> ${file.name}`;
4426.	                    }
4427.	 
4428.	                    fileElement.innerHTML = `
4429.	                        <div>${fileContent}</div>
4430.	                        <button class="file-action-btn" onclick="removeAttachment(${rowId}, '${columnId}', ${index})">×</button>
4431.	                    `;
4432.	                    container.appendChild(fileElement);
4433.	                });
4434.	            }
4435.	        }
4436.	
4437.	        function saveCellChanges() {
4438.	            if (!currentEditingCell) return;
4439.	 
4440.	            const newValue = document.getElementById('cell-value').value;
4441.	 
4442.	            if (isEditingHeader) {
4443.	                const columnType = currentEditingCell.dataset.columnType;
4444.	                const columnIndex = parseInt(currentEditingCell.dataset.columnIndex);
4445.	 
4446.	                if (columnType === 'basic') {
4447.	                    basicColumns[columnIndex].name = newValue;
4448.	                } else if (columnType === 'custom') {
4449.	                    customColumns[columnIndex].name = newValue;
4450.	                }
4451.	 
4452.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4453.	                autoSyncChanges();
4454.	 
4455.	                currentEditingCell.textContent = newValue;
4456.	            } else {
4457.	                const columnId = currentEditingCell.dataset.columnId;
4458.	                const rowId = parseInt(currentEditingCell.closest('tr').querySelector('td:nth-child(2)').textContent);
4459.	 
4460.	                const rowData = tableData.find(row => row.id === rowId);
4461.	                if (customColumns.find(col => col.id === columnId)) {
4462.	                    if (!rowData.customData) rowData.customData = {};
4463.	                    rowData.customData[columnId] = newValue;
4464.	                } else {
4465.	                    switch(columnId) {
4466.	                        case 'name': rowData.name = newValue; break;
4467.	                        case 'date': rowData.date = newValue; break;
4468.	                        case 'status': rowData.status = newValue; break;
4469.	                    }
4470.	                }
4471.	 
4472.	                const currentTab = tabs.find(tab => tab.id === currentTabId);
4473.	                if (currentTab) {
4474.	                    currentTab.data = JSON.parse(JSON.stringify(tableData));
4475.	                }
4476.	 
4477.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4478.	                autoSyncChanges();
4479.	 
4480.	                const cellContent = currentEditingCell.querySelector('.cell-content');
4481.	                if (cellContent) {
4482.	                    const cellText = cellContent.querySelector('.cell-text');
4483.	                    if (cellText) {
4484.	                        cellText.textContent = newValue;
4485.	                    }
4486.	                }
4487.	            }
4488.	 
4489.	            renderTable();
4490.	            document.getElementById('edit-cell-modal').style.display = 'none';
4491.	        }
4492.	
4493.	        window.removeAttachment = function(rowId, columnId, fileIndex) {
4494.	            const rowData = tableData.find(row => row.id === rowId);
4495.	            if (rowData && rowData.attachments && rowData.attachments[columnId]) {
4496.	                const removedFile = rowData.attachments[columnId][fileIndex];
4497.	                rowData.attachments[columnId].splice(fileIndex, 1);
4498.	 
4499.	                const currentTab = tabs.find(tab => tab.id === currentTabId);
4500.	                if (currentTab) {
4501.	                    currentTab.data = JSON.parse(JSON.stringify(tableData));
4502.	                }
4503.	 
4504.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4505.	                autoSyncChanges();
4506.	 
4507.	                if (currentEditingCell) {
4508.	                    loadAttachedFiles(currentEditingCell);
4509.	                }
4510.	                renderTable();
4511.	                alert(`Файл "${removedFile.name}" удален!`);
4512.	            }
4513.	        };
4514.	
4515.	        // ФУНКЦИИ РАБОТЫ С ФАЙЛАМИ
4516.	        function setupFileDropZone() {
4517.	            const dropZone = document.getElementById('file-upload-area');
4518.	 
4519.	            dropZone.addEventListener('dragover', function(e) {
4520.	                e.preventDefault();
4521.	                this.style.borderColor = '#e67e22';
4522.	                this.style.background = '#3a3a3a';
4523.	            });
4524.	 
4525.	            dropZone.addEventListener('dragleave', function(e) {
4526.	                e.preventDefault();
4527.	                this.style.borderColor = '#4a4a4a';
4528.	                this.style.background = '#2f2f2f';
4529.	            });
4530.	 
4531.	            dropZone.addEventListener('drop', function(e) {
4532.	                e.preventDefault();
4533.	                this.style.borderColor = '#4a4a4a';
4534.	                this.style.background = '#2f2f2f';
4535.	                handleFileUpload(e.dataTransfer.files);
4536.	            });
4537.	        }
4538.	
4539.	        // ИСПРАВЛЕННАЯ ФУНКЦИЯ ДЛЯ ЗАГРУЗКИ ФАЙЛОВ
4540.	        function handleFileUpload(files) {
4541.	            if (!currentFileManagementCell) {
4542.	                alert('Сначала выберите ячейку для редактирования!');
4543.	                return;
4544.	            }
4545.	 
4546.	            const { rowId, columnId } = currentFileManagementCell;
4547.	 
4548.	            if (!columnId || !rowId) {
4549.	                alert('Не удалось определить ячейку для прикрепления файлов');
4550.	                return;
4551.	            }
4552.	 
4553.	            Array.from(files).forEach(file => {
4554.	                const reader = new FileReader();
4555.	                reader.onload = function(e) {
4556.	                    const rowData = tableData.find(row => row.id === rowId);
4557.	                    if (!rowData.attachments) rowData.attachments = {};
4558.	                    if (!rowData.attachments[columnId]) rowData.attachments[columnId] = [];
4559.	 
4560.	                    rowData.attachments[columnId].push({
4561.	                        name: file.name,
4562.	                        type: file.type,
4563.	                        data: e.target.result
4564.	                    });
4565.	 
4566.	                    const currentTab = tabs.find(tab => tab.id === currentTabId);
4567.	                    if (currentTab) {
4568.	                        currentTab.data = JSON.parse(JSON.stringify(tableData));
4569.	                    }
4570.	 
4571.	                    storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4572.	                    autoSyncChanges();
4573.	 
4574.	                    // Обновляем список файлов в модальном окне
4575.	                    loadAttachedFilesForCell(rowId, columnId);
4576.	                    // Перерисовываем таблицу для отображения новых иконок файлов
4577.	                    renderTable();
4578.	 
4579.	                    alert(`Файл "${file.name}" успешно добавлен!`);
4580.	                };
4581.	 
4582.	                reader.onerror = function(e) {
4583.	                    alert(`Ошибка при чтении файла "${file.name}"`);
4584.	                };
4585.	 
4586.	                reader.readAsDataURL(file);
4587.	            });
4588.	 
4589.	            // Очищаем input файлов после загрузки
4590.	            document.getElementById('file-input').value = '';
4591.	        }
4592.	
4593.	        function openFilePreview(file, rowId, columnId, fileIndex) {
4594.	            currentPreviewFile = { file, rowId, columnId, fileIndex };
4595.	 
4596.	            document.getElementById('preview-title').textContent = 'Просмотр файла';
4597.	            document.getElementById('preview-filename').textContent = file.name;
4598.	            document.getElementById('preview-filetype').textContent = getFileTypeDescription(file.type);
4599.	 
4600.	            const previewContent = document.getElementById('preview-content');
4601.	            previewContent.innerHTML = '';
4602.	 
4603.	            if (file.type.startsWith('image/')) {
4604.	                const img = document.createElement('img');
4605.	                img.src = file.data;
4606.	                img.alt = file.name;
4607.	                img.className = 'preview-image';
4608.	                previewContent.appendChild(img);
4609.	            } else if (file.type.includes('pdf')) {
4610.	                const embed = document.createElement('embed');
4611.	                embed.src = file.data;
4612.	                embed.type = 'application/pdf';
4613.	                embed.className = 'preview-document';
4614.	                previewContent.appendChild(embed);
4615.	            } else {
4616.	                const message = document.createElement('div');
4617.	                message.innerHTML = `
4618.	                    <div style="padding: 2rem; text-align: center;">
4619.	                        <div style="font-size: 3rem; margin-bottom: 1rem;">📄</div>
4620.	                        <h3>Предпросмотр недоступен</h3>
4621.	                        <p>Для данного типа файла доступно только скачивание</p>
4622.	                        <p><strong>Тип файла:</strong> ${file.type}</p>
4623.	                    </div>
4624.	                `;
4625.	                previewContent.appendChild(message);
4626.	            }
4627.	 
4628.	            document.getElementById('file-preview-modal').style.display = 'flex';
4629.	        }
4630.	
4631.	        function getFileTypeDescription(fileType) {
4632.	            const types = {
4633.	                'image/jpeg': 'Изображение JPEG',
4634.	                'image/png': 'Изображение PNG',
4635.	                'image/gif': 'Изображение GIF',
4636.	                'application/pdf': 'Документ PDF',
4637.	                'application/msword': 'Документ Word',
4638.	                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'Документ Word',
4639.	                'application/vnd.ms-excel': 'Таблица Excel',
4640.	                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'Таблица Excel',
4641.	                'text/plain': 'Текстовый файл'
4642.	            };
4643.	 
4644.	            return types[fileType] || fileType;
4645.	        }
4646.	
4647.	        function downloadPreviewFile() {
4648.	            if (!currentPreviewFile) return;
4649.	 
4650.	            const link = document.createElement('a');
4651.	            link.href = currentPreviewFile.file.data;
4652.	            link.download = currentPreviewFile.file.name;
4653.	            document.body.appendChild(link);
4654.	            link.click();
4655.	            document.body.removeChild(link);
4656.	 
4657.	            alert(`Файл "${currentPreviewFile.file.name}" сохранен!`);
4658.	        }
4659.	
4660.	        function copyPreviewFile() {
4661.	            if (!currentPreviewFile) return;
4662.	 
4663.	            if (currentPreviewFile.file.type.startsWith('image/')) {
4664.	                const img = new Image();
4665.	                img.src = currentPreviewFile.file.data;
4666.	                img.onload = function() {
4667.	                    const canvas = document.createElement('canvas');
4668.	                    canvas.width = img.width;
4669.	                    canvas.height = img.height;
4670.	                    const ctx = canvas.getContext('2d');
4671.	                    ctx.drawImage(img, 0, 0);
4672.	 
4673.	                    canvas.toBlob(function(blob) {
4674.	                        const item = new ClipboardItem({ [blob.type]: blob });
4675.	                        navigator.clipboard.write([item]).then(function() {
4676.	                            alert('Изображение скопировано в буфер обмена!');
4677.	                        }).catch(function(err) {
4678.	                            alert('Не удалось скопировать изображение: ' + err);
4679.	                        });
4680.	                    });
4681.	                };
4682.	            } else {
4683.	                alert('Копирование доступно только для изображений. Используйте функцию "Сохранить" для других типов файлов.');
4684.	            }
4685.	        }
4686.	
4687.	        function printPreviewFile() {
4688.	            if (!currentPreviewFile) return;
4689.	 
4690.	            const printWindow = window.open('', '_blank');
4691.	 
4692.	            if (currentPreviewFile.file.type.startsWith('image/')) {
4693.	                printWindow.document.write(`
4694.	                    <html>
4695.	                        <head>
4696.	                            <title>Печать ${currentPreviewFile.file.name}</title>
4697.	                            <style>
4698.	                                body {
4699.	                                    margin: 0;
4700.	                                    padding: 20px;
4701.	                                    text-align: center;
4702.	                                    font-family: Arial, sans-serif;
4703.	                                }
4704.	                                img {
4705.	                                    max-width: 100%;
4706.	                                    max-height: 90vh;
4707.	                                    border-radius: 5px;
4708.	                                }
4709.	                                .file-info {
4710.	                                    margin-bottom: 20px;
4711.	                                    padding: 10px;
4712.	                                    background: #f5f5f5;
4713.	                                    border-radius: 5px;
4714.	                                }
4715.	                            </style>
4716.	                        </head>
4717.	                        <body>
4718.	                            <div class="file-info">
4719.	                                <h2>${currentPreviewFile.file.name}</h2>
4720.	                                <p>${getFileTypeDescription(currentPreviewFile.file.type)}</p>
4721.	                            </div>
4722.	                            <img src="${currentPreviewFile.file.data}" alt="${currentPreviewFile.file.name}">
4723.	                        </body>
4724.	                    </html>
4725.	                `);
4726.	            } else if (currentPreviewFile.file.type.includes('pdf')) {
4727.	                printWindow.document.write(`
4728.	                    <html>
4729.	                        <head>
4730.	                            <title>Печать ${currentPreviewFile.file.name}</title>
4731.	                            <style>
4732.	                                body { margin: 0; padding: 0; }
4733.	                                embed { width: 100%; height: 100vh; }
4734.	                            </style>
4735.	                        </head>
4736.	                        <body>
4737.	                            <embed src="${currentPreviewFile.file.data}" type="application/pdf">
4738.	                        </body>
4739.	                    </html>
4740.	                `);
4741.	            } else {
4742.	                printWindow.document.write(`
4743.	                    <html>
4744.	                        <head>
4745.	                            <title>Печать ${currentPreviewFile.file.name}</title>
4746.	                            <style>
4747.	                                body {
4748.	                                    margin: 0;
4749.	                                    padding: 40px;
4750.	                                    font-family: Arial, sans-serif;
4751.	                                    text-align: center;
4752.	                                }
4753.	                                .file-info {
4754.	                                    margin-bottom: 30px;
4755.	                                    padding: 20px;
4756.	                                    background: #f5f5f5;
4757.	                                    border-radius: 10px;
4758.	                                }
4759.	                            </style>
4760.	                        </head>
4761.	                        <body>
4762.	                            <div class="file-info">
4763.	                                <h1>${currentPreviewFile.file.name}</h1>
4764.	                                <h3>${getFileTypeDescription(currentPreviewFile.file.type)}</h3>
4765.	                                <p>Прямая печать недоступна для этого типа файла.</p>
4766.	                                <p>Пожалуйста, сохраните файл и откройте его в соответствующей программе для печати.</p>
4767.	                            </div>
4768.	                        </body>
4769.	                    </html>
4770.	                `);
4771.	            }
4772.	 
4773.	            printWindow.document.close();
4774.	            setTimeout(() => {
4775.	                printWindow.print();
4776.	            }, 500);
4777.	        }
4778.	
4779.	        // ФУНКЦИИ УПРАВЛЕНИЯ ПОЛЬЗОВАТЕЛЯМИ
4780.	        function handleAddUser(e) {
4781.	            e.preventDefault();
4782.	            const username = document.getElementById('new-username').value;
4783.	            const password = document.getElementById('new-password').value;
4784.	            const role = document.getElementById('new-role').value;
4785.	 
4786.	            if (users.find(u => u.username === username)) {
4787.	                alert('Пользователь уже существует');
4788.	                return;
4789.	            }
4790.	 
4791.	            users.push({ username, password, role });
4792.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4793.	            autoSyncChanges();
4794.	            renderUsersList();
4795.	            document.getElementById('add-user-form').reset();
4796.	        }
4797.	
4798.	        function renderUsersList() {
4799.	            const container = document.getElementById('users-list');
4800.	            container.innerHTML = '';
4801.	 
4802.	            users.forEach((user, index) => {
4803.	                if (user.username === currentUser.username) return;
4804.	 
4805.	                const div = document.createElement('div');
4806.	                div.className = 'user-item';
4807.	                div.innerHTML = `
4808.	                    <div>
4809.	                        <strong>${user.username}</strong>
4810.	                        <span class="user-role">${user.role === 'admin' ? 'Администратор' : 'Пользователь'}</span>
4811.	                    </div>
4812.	                    <div class="user-actions">
4813.	                        <button class="btn-edit" onclick="editUser(${index})">✎</button>
4814.	                        <button class="btn-danger" onclick="deleteUser(${index})">×</button>
4815.	                    </div>
4816.	                `;
4817.	                container.appendChild(div);
4818.	            });
4819.	        }
4820.	
4821.	        window.editUser = function(index) {
4822.	            const user = users[index];
4823.	            const newUsername = prompt('Новое имя пользователя:', user.username);
4824.	            const newPassword = prompt('Новый пароль (оставьте пустым чтобы не менять):');
4825.	            const newRole = confirm('Сделать администратором?') ? 'admin' : 'user';
4826.	 
4827.	            if (newUsername) user.username = newUsername;
4828.	            if (newPassword) user.password = newPassword;
4829.	            user.role = newRole;
4830.	 
4831.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4832.	            autoSyncChanges();
4833.	            renderUsersList();
4834.	        };
4835.	
4836.	        window.deleteUser = function(index) {
4837.	            if (confirm('Удалить этого пользователя?')) {
4838.	                users.splice(index, 1);
4839.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4840.	                autoSyncChanges();
4841.	                renderUsersList();
4842.	            }
4843.	        };
4844.	
4845.	        function loadAppSettings() {
4846.	            document.getElementById('header-title').textContent = appSettings.headerTitle;
4847.	            if (appSettings.headerLogo) {
4848.	                document.getElementById('header-logo').src = appSettings.headerLogo;
4849.	                document.getElementById('header-logo').style.display = 'block';
4850.	            }
4851.	            document.getElementById('fixed-columns-count').value = appSettings.fixedColumnsCount;
4852.	        }
4853.	
4854.	        function triggerLogoUpload() {
4855.	            if (currentUser && currentUser.role === 'admin') {
4856.	                document.getElementById('logo-upload').click();
4857.	            }
4858.	        }
4859.	
4860.	        function handleLogoUpload(e) {
4861.	            const file = e.target.files[0];
4862.	            if (file && file.type === 'image/png') {
4863.	                const reader = new FileReader();
4864.	                reader.onload = function(e) {
4865.	                    document.getElementById('header-logo').src = e.target.result;
4866.	                    document.getElementById('header-logo').style.display = 'block';
4867.	                    appSettings.headerLogo = e.target.result;
4868.	                    storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4869.	                    autoSyncChanges();
4870.	                };
4871.	                reader.readAsDataURL(file);
4872.	            } else {
4873.	                alert('Пожалуйста, выберите PNG файл');
4874.	            }
4875.	        }
4876.	
4877.	        // ФУНКЦИИ ПРОКРУТКИ ВКЛАДОК
4878.	        function scrollTabsLeft() {
4879.	            const container = document.getElementById('tabs-container');
4880.	            container.scrollBy({
4881.	                left: -200,
4882.	                behavior: 'smooth'
4883.	            });
4884.	        }
4885.	
4886.	        function scrollTabsRight() {
4887.	            const container = document.getElementById('tabs-container');
4888.	            container.scrollBy({
4889.	                left: 200,
4890.	                behavior: 'smooth'
4891.	            });
4892.	        }
4893.	
4894.	        function updateFixedColumnsCount() {
4895.	            const count = parseInt(document.getElementById('fixed-columns-count').value);
4896.	            if (count >= 1 && count <= 10) {
4897.	                appSettings.fixedColumnsCount = count;
4898.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4899.	                autoSyncChanges();
4900.	            }
4901.	        }
4902.	
4903.	        // ФУНКЦИИ УПРАВЛЕНИЯ СТОЛБЦАМИ
4904.	        function addNewColumn() {
4905.	            const columnName = prompt('Введите название нового столбца:');
4906.	            if (!columnName) return;
4907.	
4908.	            const columnId = 'col_' + Date.now();
4909.	            customColumns.push({
4910.	                id: columnId,
4911.	                name: columnName
4912.	            });
4913.	
4914.	            tableData.forEach(row => {
4915.	                if (!row.customData) row.customData = {};
4916.	                row.customData[columnId] = '';
4917.	            });
4918.	
4919.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4920.	            autoSyncChanges();
4921.	 
4922.	            renderTable();
4923.	 
4924.	            if (confirm('Хотите переместить новый столбец в нужную позицию?')) {
4925.	                showMoveColumnModal();
4926.	            }
4927.	        }
4928.	
4929.	        function showRemoveColumnModal() {
4930.	            const select = document.getElementById('column-to-remove');
4931.	            select.innerHTML = '';
4932.	
4933.	            customColumns.forEach(column => {
4934.	                const option = document.createElement('option');
4935.	                option.value = column.id;
4936.	                option.textContent = column.name;
4937.	                select.appendChild(option);
4938.	            });
4939.	
4940.	            if (customColumns.length === 0) {
4941.	                const option = document.createElement('option');
4942.	                option.textContent = 'Нет пользовательских столбцов для удаления';
4943.	                option.disabled = true;
4944.	                select.appendChild(option);
4945.	                document.getElementById('confirm-remove-column').disabled = true;
4946.	            } else {
4947.	                document.getElementById('confirm-remove-column').disabled = false;
4948.	            }
4949.	
4950.	            document.getElementById('remove-column-modal').style.display = 'flex';
4951.	        }
4952.	
4953.	        function removeSelectedColumn() {
4954.	            const select = document.getElementById('column-to-remove');
4955.	            const columnId = select.value;
4956.	
4957.	            if (!columnId) return;
4958.	
4959.	            const column = customColumns.find(col => col.id === columnId);
4960.	            if (!confirm(`Удалить столбец "${column.name}"? Все данные в этом столбце будут потеряны.`)) return;
4961.	
4962.	            tableData.forEach(row => {
4963.	                if (row.customData && row.customData[columnId]) {
4964.	                    delete row.customData[columnId];
4965.	                }
4966.	            });
4967.	
4968.	            customColumns = customColumns.filter(col => col.id !== columnId);
4969.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
4970.	            autoSyncChanges();
4971.	
4972.	            renderTable();
4973.	            document.getElementById('remove-column-modal').style.display = 'none';
4974.	 
4975.	            alert(`Столбец "${column.name}" успешно удален!`);
4976.	        }
4977.	
4978.	        function showMoveColumnModal() {
4979.	            const select = document.getElementById('column-to-move');
4980.	            const maxPositionSpan = document.getElementById('max-position');
4981.	 
4982.	            select.innerHTML = '';
4983.	 
4984.	            const allColumns = [...basicColumns, ...customColumns];
4985.	            allColumns.forEach((column, index) => {
4986.	                const option = document.createElement('option');
4987.	                option.value = column.id;
4988.	                option.textContent = column.name;
4989.	                option.dataset.index = index + 1;
4990.	                select.appendChild(option);
4991.	            });
4992.	
4993.	            maxPositionSpan.textContent = allColumns.length + 1;
4994.	 
4995.	            document.getElementById('column-position').value = allColumns.length + 1;
4996.	            document.getElementById('column-position').max = allColumns.length + 1;
4997.	 
4998.	            document.getElementById('move-column-modal').style.display = 'flex';
4999.	        }
5000.	
5001.	        function moveSelectedColumn() {
5002.	            const select = document.getElementById('column-to-move');
5003.	            const positionInput = document.getElementById('column-position');
5004.	 
5005.	            const columnId = select.value;
5006.	            const newPosition = parseInt(positionInput.value);
5007.	 
5008.	            if (!columnId || !newPosition) return;
5009.	 
5010.	            const allColumns = [...basicColumns, ...customColumns];
5011.	            const columnIndex = allColumns.findIndex(col => col.id === columnId);
5012.	 
5013.	            if (columnIndex === -1) return;
5014.	 
5015.	            const columnToMove = allColumns[columnIndex];
5016.	 
5017.	            if (columnIndex < basicColumns.length) {
5018.	                basicColumns.splice(columnIndex, 1);
5019.	            } else {
5020.	                customColumns.splice(columnIndex - basicColumns.length, 1);
5021.	            }
5022.	 
5023.	            const targetPosition = newPosition - 2;
5024.	 
5025.	            if (targetPosition < basicColumns.length) {
5026.	                basicColumns.splice(targetPosition, 0, columnToMove);
5027.	            } else {
5028.	                customColumns.splice(targetPosition - basicColumns.length, 0, columnToMove);
5029.	            }
5030.	 
5031.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5032.	            autoSyncChanges();
5033.	 
5034.	            renderTable();
5035.	            document.getElementById('move-column-modal').style.display = 'none';
5036.	 
5037.	            alert(`Столбец "${columnToMove.name}" успешно перемещен на позицию ${newPosition}!`);
5038.	        }
5039.	
5040.	        function moveColumn(direction) {
5041.	            alert('Используйте модальное окно для точного перемещения столбцов');
5042.	            showMoveColumnModal();
5043.	        }
5044.	
5045.	        // ФУНКЦИЯ ИМПОРТА ИЗ EXCEL
5046.	        function handleExcelFileSelect(e) {
5047.	            const file = e.target.files[0];
5048.	            if (!file) return;
5049.	
5050.	            if (typeof XLSX === 'undefined') {
5051.	                alert('Библиотека для чтения Excel файлов загружается. Попробуйте еще раз через несколько секунд.');
5052.	                return;
5053.	            }
5054.	
5055.	            const reader = new FileReader();
5056.	            reader.onload = function(e) {
5057.	                try {
5058.	                    const data = new Uint8Array(e.target.result);
5059.	                    const workbook = XLSX.read(data, { type: 'array' });
5060.	 
5061.	                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
5062.	                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
5063.	 
5064.	                    showImportPreview(jsonData);
5065.	                } catch (error) {
5066.	                    alert('Ошибка при чтении файла: ' + error.message);
5067.	                }
5068.	            };
5069.	            reader.onerror = function() {
5070.	                alert('Ошибка при чтении файла');
5071.	            };
5072.	            reader.readAsArrayBuffer(file);
5073.	        }
5074.	
5075.	        function showImportPreview(data) {
5076.	            const previewContainer = document.getElementById('import-preview');
5077.	            const previewTable = document.getElementById('import-preview-table');
5078.	            const confirmBtn = document.getElementById('confirm-import-btn');
5079.	 
5080.	            previewTable.innerHTML = '';
5081.	 
5082.	            if (data.length === 0) {
5083.	                previewContainer.style.display = 'none';
5084.	                confirmBtn.style.display = 'none';
5085.	                return;
5086.	            }
5087.	 
5088.	            const thead = document.createElement('thead');
5089.	            const headerRow = document.createElement('tr');
5090.	 
5091.	            const headers = data[0];
5092.	            headers.forEach(header => {
5093.	                const th = document.createElement('th');
5094.	                th.textContent = header || 'Столбец';
5095.	                th.style.textAlign = 'center';
5096.	                headerRow.appendChild(th);
5097.	            });
5098.	 
5099.	            thead.appendChild(headerRow);
5100.	            previewTable.appendChild(thead);
5101.	 
5102.	            const tbody = document.createElement('tbody');
5103.	            const rowsToShow = Math.min(5, data.length - 1);
5104.	 
5105.	            for (let i = 1; i <= rowsToShow; i++) {
5106.	                const row = document.createElement('tr');
5107.	                if (data[i]) {
5108.	                    data[i].forEach(cell => {
5109.	                        const td = document.createElement('td');
5110.	                        td.textContent = cell || '';
5111.	                        td.style.textAlign = 'center';
5112.	                        row.appendChild(td);
5113.	                    });
5114.	                    tbody.appendChild(row);
5115.	                }
5116.	            }
5117.	 
5118.	            previewTable.appendChild(tbody);
5119.	            previewContainer.style.display = 'block';
5120.	            confirmBtn.style.display = 'block';
5121.	 
5122.	            currentImportData = data;
5123.	        }
5124.	
5125.	        function confirmImport() {
5126.	            if (!currentImportData || currentImportData.length < 2) {
5127.	                alert('Нет данных для импорта');
5128.	                return;
5129.	            }
5130.	 
5131.	            const importMode = document.getElementById('import-mode').value;
5132.	            const headers = currentImportData[0];
5133.	            const rows = currentImportData.slice(1);
5134.	 
5135.	            if (importMode === 'replace') {
5136.	                tableData = [];
5137.	            }
5138.	 
5139.	            let nextId = tableData.length > 0 ? Math.max(...tableData.map(row => row.id)) + 1 : 1;
5140.	 
5141.	            rows.forEach(row => {
5142.	                if (row && row.length > 0) {
5143.	                    const newRow = {
5144.	                        id: nextId++,
5145.	                        name: row[0] || 'Новый проект',
5146.	                        date: row[1] || formatDate(new Date()),
5147.	                        status: row[2] || 'Активен',
5148.	                        customData: {},
5149.	                        attachments: {}
5150.	                    };
5151.	 
5152.	                    for (let i = 3; i < headers.length; i++) {
5153.	                        if (headers[i]) {
5154.	                            const columnName = headers[i];
5155.	                            const columnId = 'imported_' + columnName.toLowerCase().replace(/\s+/g, '_');
5156.	 
5157.	                            if (!customColumns.find(col => col.name === columnName)) {
5158.	                                customColumns.push({
5159.	                                    id: columnId,
5160.	                                    name: columnName
5161.	                                });
5162.	                            }
5163.	 
5164.	                            newRow.customData[columnId] = row[i] || '';
5165.	                        }
5166.	                    }
5167.	 
5168.	                    tableData.push(newRow);
5169.	                }
5170.	            });
5171.	 
5172.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5173.	            if (currentTab) {
5174.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
5175.	            }
5176.	 
5177.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5178.	            autoSyncChanges();
5179.	 
5180.	            renderTable();
5181.	            document.getElementById('import-excel-modal').style.display = 'none';
5182.	            alert(`Успешно импортировано ${rows.length} строк`);
5183.	 
5184.	            currentImportData = null;
5185.	            document.getElementById('excel-file-input').value = '';
5186.	            document.getElementById('import-preview').style.display = 'none';
5187.	            document.getElementById('confirm-import-btn').style.display = 'none';
5188.	        }
5189.	
5190.	        // НОВЫЕ ФУНКЦИИ ДЛЯ ВКЛАДОК
5191.	        function renderTabs() {
5192.	            const container = document.getElementById('tabs-container');
5193.	            container.innerHTML = '';
5194.	 
5195.	            tabs.forEach(tab => {
5196.	                const tabElement = document.createElement('div');
5197.	                tabElement.className = `tab ${tab.id === currentTabId ? 'active' : ''}`;
5198.	                tabElement.dataset.tabId = tab.id;
5199.	 
5200.	                const tabName = document.createElement('span');
5201.	                tabName.textContent = tab.name;
5202.	                tabName.className = 'tab-name';
5203.	 
5204.	                const closeBtn = document.createElement('button');
5205.	                closeBtn.className = 'tab-close';
5206.	                closeBtn.innerHTML = '×';
5207.	                closeBtn.title = 'Закрыть вкладку';
5208.	 
5209.	                if (currentUser && currentUser.role !== 'admin') {
5210.	                    closeBtn.style.display = 'none';
5211.	                } else if (tabs.length > 1) {
5212.	                    closeBtn.addEventListener('click', (e) => {
5213.	                        e.stopPropagation();
5214.	                        closeTab(tab.id);
5215.	                    });
5216.	                } else {
5217.	                    closeBtn.style.display = 'none';
5218.	                }
5219.	 
5220.	                tabElement.appendChild(tabName);
5221.	                tabElement.appendChild(closeBtn);
5222.	 
5223.	                tabElement.addEventListener('click', (e) => {
5224.	                    if (!e.target.classList.contains('tab-close')) {
5225.	                        switchTab(tab.id);
5226.	                    }
5227.	                });
5228.	
5229.	                if (currentUser && currentUser.role === 'admin') {
5230.	                    tabName.classList.add('editable');
5231.	                    tabName.contentEditable = 'true';
5232.	 
5233.	                    tabName.addEventListener('blur', function() {
5234.	                        const newName = this.textContent.trim();
5235.	                        if (newName && newName !== tab.name) {
5236.	                            tab.name = newName;
5237.	                            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5238.	                            autoSyncChanges();
5239.	 
5240.	                            if (tab.id === currentTabId) {
5241.	                                document.getElementById('header-title').textContent = newName;
5242.	                                appSettings.headerTitle = newName;
5243.	                                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5244.	                                autoSyncChanges();
5245.	                            }
5246.	                        } else {
5247.	                            this.textContent = tab.name;
5248.	                        }
5249.	                    });
5250.	 
5251.	                    tabName.addEventListener('keydown', function(e) {
5252.	                        if (e.key === 'Enter') {
5253.	                            e.preventDefault();
5254.	                            this.blur();
5255.	                        }
5256.	                    });
5257.	                }
5258.	 
5259.	                container.appendChild(tabElement);
5260.	            });
5261.	 
5262.	            if (currentTabId && currentTabId !== 'tab1') {
5263.	                const currentTab = tabs.find(tab => tab.id === currentTabId);
5264.	                if (currentTab && currentTab.data) {
5265.	                    tableData = currentTab.data;
5266.	                    renderTable();
5267.	                }
5268.	            }
5269.	
5270.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5271.	            if (currentTab) {
5272.	                document.getElementById('header-title').textContent = currentTab.name;
5273.	            }
5274.	        }
5275.	
5276.	        function createNewTab() {
5277.	            if (currentUser.role !== 'admin') {
5278.	                alert('Только администраторы могут создавать новые вкладки');
5279.	                return;
5280.	            }
5281.	
5282.	            const tabId = 'tab_' + Date.now();
5283.	            const tabName = `Таблица ${tabs.length + 1}`;
5284.	 
5285.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5286.	            if (currentTab) {
5287.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
5288.	            }
5289.	 
5290.	            const newTab = {
5291.	                id: tabId,
5292.	                name: tabName,
5293.	                data: [
5294.	                    { id: 1, name: 'Новый проект', date: formatDate(new Date()), status: 'Активен', customData: {}, attachments: {} }
5295.	                ]
5296.	            };
5297.	 
5298.	            tabs.push(newTab);
5299.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5300.	            autoSyncChanges();
5301.	 
5302.	            currentTabId = tabId;
5303.	            tableData = JSON.parse(JSON.stringify(newTab.data));
5304.	 
5305.	            renderTabs();
5306.	            renderTable();
5307.	            resetFiltersAndSearch();
5308.	        }
5309.	
5310.	        function switchTab(tabId) {
5311.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5312.	            if (currentTab) {
5313.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
5314.	            }
5315.	 
5316.	            currentTabId = tabId;
5317.	            const newTab = tabs.find(tab => tab.id === tabId);
5318.	 
5319.	            if (newTab && newTab.data) {
5320.	                tableData = JSON.parse(JSON.stringify(newTab.data));
5321.	            } else {
5322.	                if (tabId === 'tab1') {
5323.	                    const data = storageManager.loadFromLocalStorage();
5324.	                    tableData = data.tableData;
5325.	                }
5326.	            }
5327.	 
5328.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5329.	            renderTabs();
5330.	            renderTable();
5331.	            resetFiltersAndSearch();
5332.	        }
5333.	
5334.	        function closeTab(tabId) {
5335.	            if (currentUser.role !== 'admin') {
5336.	                alert('Только администраторы могут удалять вкладки');
5337.	                return;
5338.	            }
5339.	
5340.	            if (tabs.length <= 1) return;
5341.	 
5342.	            const tabIndex = tabs.findIndex(tab => tab.id === tabId);
5343.	            if (tabIndex === -1) return;
5344.	 
5345.	            tabs.splice(tabIndex, 1);
5346.	 
5347.	            if (tabId === currentTabId) {
5348.	                currentTabId = tabs[0].id;
5349.	                const firstTab = tabs[0];
5350.	 
5351.	                if (firstTab.data) {
5352.	                    tableData = JSON.parse(JSON.stringify(firstTab.data));
5353.	                } else if (firstTab.id === 'tab1') {
5354.	                    const data = storageManager.loadFromLocalStorage();
5355.	                    tableData = data.tableData;
5356.	                }
5357.	            }
5358.	 
5359.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5360.	            autoSyncChanges();
5361.	            renderTabs();
5362.	            renderTable();
5363.	        }
5364.	
5365.	        function resetFiltersAndSearch() {
5366.	            currentFilters = {};
5367.	            searchTerm = '';
5368.	            selectedRows.clear();
5369.	            document.getElementById('table-search').value = '';
5370.	            document.getElementById('select-all-checkbox').checked = false;
5371.	            closeAllFilterDropdowns();
5372.	        }
5373.	
5374.	        // ФУНКЦИИ ДЛЯ ЧЕКБОКСОВ И ФИЛЬТРАЦИИ
5375.	        function handleSelectAll(e) {
5376.	            const isChecked = e.target.checked;
5377.	 
5378.	            if (isChecked) {
5379.	                currentFilters = {};
5380.	                searchTerm = '';
5381.	                selectedRows.clear();
5382.	                document.getElementById('table-search').value = '';
5383.	                closeAllFilterDropdowns();
5384.	                renderTable();
5385.	            }
5386.	        }
5387.	
5388.	        function handleRowCheckboxChange(rowId, isChecked) {
5389.	            if (isChecked) {
5390.	                selectedRows.add(rowId);
5391.	            } else {
5392.	                selectedRows.delete(rowId);
5393.	            }
5394.	        }
5395.	
5396.	        function filterSelectedRows() {
5397.	            if (selectedRows.size === 0) {
5398.	                alert('Выберите строки для фильтрации!');
5399.	                return;
5400.	            }
5401.	 
5402.	            currentFilters.selectedRows = Array.from(selectedRows);
5403.	            renderTable();
5404.	        }
5405.	
5406.	        // ФУНКЦИЯ ПОИСКА
5407.	        function handleSearch(e) {
5408.	            searchTerm = e.target.value.toLowerCase().trim();
5409.	            renderTable();
5410.	        }
5411.	
5412.	        function clearSearch() {
5413.	            document.getElementById('table-search').value = '';
5414.	            searchTerm = '';
5415.	            renderTable();
5416.	        }
5417.	
5418.	        function applySearch(data) {
5419.	            if (!searchTerm) return data;
5420.	 
5421.	            return data.filter(row => {
5422.	                const searchableFields = [
5423.	                    row.id.toString(),
5424.	                    row.name || '',
5425.	                    row.date || '',
5426.	                    row.status || ''
5427.	                ];
5428.	 
5429.	                if (row.customData) {
5430.	                    Object.values(row.customData).forEach(value => {
5431.	                        searchableFields.push(value.toString());
5432.	                    });
5433.	                }
5434.	 
5435.	                return searchableFields.some(field =>
5436.	                    field.toLowerCase().includes(searchTerm)
5437.	                );
5438.	            });
5439.	        }
5440.	
5441.	        // ИСПРАВЛЕННАЯ ФУНКЦИЯ ЭКСПОРТА В EXCEL
5442.	        function exportToExcel() {
5443.	            const exportData = [];
5444.	            const headers = ['№ п/п', 'Название', 'Дата создания', 'Статус'];
5445.	 
5446.	            customColumns.forEach(col => {
5447.	                headers.push(col.name);
5448.	            });
5449.	 
5450.	            exportData.push(headers);
5451.	 
5452.	            tableData.forEach(row => {
5453.	                const rowData = [
5454.	                    row.displayId || row.id,
5455.	                    row.name || '',
5456.	                    row.date || '',
5457.	                    row.status || ''
5458.	                ];
5459.	 
5460.	                customColumns.forEach(col => {
5461.	                    const value = row.customData && row.customData[col.id] ? row.customData[col.id] : '';
5462.	                    rowData.push(value);
5463.	                });
5464.	 
5465.	                exportData.push(rowData);
5466.	            });
5467.	 
5468.	            let csvContent = '\uFEFF';
5469.	            exportData.forEach(row => {
5470.	                const escapedRow = row.map(field => {
5471.	                    if (field === null || field === undefined) return '';
5472.	                    const stringField = String(field);
5473.	                    if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
5474.	                        return '"' + stringField.replace(/"/g, '""') + '"';
5475.	                    }
5476.	                    return stringField;
5477.	                });
5478.	                csvContent += escapedRow.join(';') + '\n';
5479.	            });
5480.	 
5481.	            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
5482.	            const link = document.createElement('a');
5483.	            const url = URL.createObjectURL(blob);
5484.	 
5485.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5486.	            const fileName = currentTab ? currentTab.name : 'таблица';
5487.	 
5488.	            link.setAttribute('href', url);
5489.	            link.setAttribute('download', `${fileName}\_${formatDate(new Date())}.csv`);
5490.	            link.style.visibility = 'hidden';
5491.	 
5492.	            document.body.appendChild(link);
5493.	            link.click();
5494.	            document.body.removeChild(link);
5495.	 
5496.	            alert(`Данные из "${fileName}" успешно экспортированы в CSV файл!`);
5497.	        }
5498.	
5499.	        // ОБНОВЛЕННАЯ ФУНКЦИЯ РЕНДЕРА ТАБЛИЦЫ
5500.	        function renderTable() {
5501.	            const thead = document.querySelector('#data-table thead tr');
5502.	            const tbody = document.querySelector('#data-table tbody');
5503.	 
5504.	            thead.innerHTML = '';
5505.	 
5506.	            const selectAllTh = document.createElement('th');
5507.	            selectAllTh.style.minWidth = '50px';
5508.	            selectAllTh.style.maxWidth = '60px';
5509.	            selectAllTh.style.width = '50px';
5510.	            const selectAllCheckbox = document.createElement('input');
5511.	            selectAllCheckbox.type = 'checkbox';
5512.	            selectAllCheckbox.className = 'select-all-checkbox';
5513.	            selectAllCheckbox.id = 'select-all-checkbox';
5514.	            selectAllCheckbox.title = 'Показать все строки';
5515.	            selectAllCheckbox.checked = Object.keys(currentFilters).length === 0 && searchTerm === '';
5516.	            selectAllCheckbox.addEventListener('change', handleSelectAll);
5517.	            selectAllTh.appendChild(selectAllCheckbox);
5518.	            thead.appendChild(selectAllTh);
5519.	 
5520.	            basicColumns.forEach((column, index) => {
5521.	                const th = createHeaderCell(column, index, 'basic');
5522.	                thead.appendChild(th);
5523.	            });
5524.	 
5525.	            customColumns.forEach((column, index) => {
5526.	                const th = createHeaderCell(column, index, 'custom');
5527.	                thead.appendChild(th);
5528.	            });
5529.	 
5530.	            if (currentUser && currentUser.role === 'admin') {
5531.	                const actionsTh = document.createElement('th');
5532.	                actionsTh.className = 'admin-only actions-header';
5533.	                actionsTh.innerHTML = `
5534.	                    <div class="th-content">
5535.	                        <div class="th-main">
5536.	                            <div class="th-title">×</div>
5537.	                            <div class="filter-controls">
5538.	                            </div>
5539.	                        </div>
5540.	                    </div>
5541.	                `;
5542.	                actionsTh.style.minWidth = '40px';
5543.	                actionsTh.style.maxWidth = '50px';
5544.	                actionsTh.style.width = '40px';
5545.	                actionsTh.style.zIndex = '10';
5546.	                thead.appendChild(actionsTh);
5547.	            }
5548.	 
5549.	            tbody.innerHTML = '';
5550.	 
5551.	            let filteredData = applyFilters(tableData);
5552.	            filteredData = applySearch(filteredData);
5553.	            let sortedData = applySorting(filteredData);
5554.	 
5555.	            sortedData.forEach((rowData, index) => {
5556.	                rowData.displayId = index + 1;
5557.	            });
5558.	 
5559.	            sortedData.forEach(rowData => {
5560.	                const row = document.createElement('tr');
5561.	 
5562.	                const checkboxTd = document.createElement('td');
5563.	                const checkbox = document.createElement('input');
5564.	                checkbox.type = 'checkbox';
5565.	                checkbox.className = 'row-checkbox';
5566.	                checkbox.dataset.rowId = rowData.id;
5567.	                checkbox.checked = selectedRows.has(rowData.id);
5568.	                checkbox.addEventListener('change', (e) => {
5569.	                    handleRowCheckboxChange(rowData.id, e.target.checked);
5570.	                });
5571.	                checkboxTd.appendChild(checkbox);
5572.	                row.appendChild(checkboxTd);
5573.	 
5574.	                basicColumns.forEach(column => {
5575.	                    const td = createDataCell(rowData, column, 'basic');
5576.	                    row.appendChild(td);
5577.	                });
5578.	 
5579.	                customColumns.forEach(column => {
5580.	                    const td = createDataCell(rowData, column, 'custom');
5581.	                    row.appendChild(td);
5582.	                });
5583.	 
5584.	                if (currentUser && currentUser.role === 'admin') {
5585.	                    const actionsTd = document.createElement('td');
5586.	                    actionsTd.className = 'admin-only';
5587.	                    const deleteBtn = document.createElement('button');
5588.	                    deleteBtn.className = 'delete-row-btn';
5589.	                    deleteBtn.innerHTML = '×';
5590.	                    deleteBtn.title = 'Удалить строку';
5591.	                    deleteBtn.onclick = () => deleteRow(rowData.id);
5592.	                    actionsTd.appendChild(deleteBtn);
5593.	                    row.appendChild(actionsTd);
5594.	                }
5595.	 
5596.	                tbody.appendChild(row);
5597.	            });
5598.	 
5599.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5600.	            if (currentTab) {
5601.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
5602.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5603.	            }
5604.	        }
5605.	
5606.	        function createHeaderCell(column, index, type) {
5607.	            const th = document.createElement('th');
5608.	            th.dataset.columnId = column.id;
5609.	            th.dataset.columnType = type;
5610.	            th.dataset.columnIndex = index;
5611.	 
5612.	            if (type === 'custom') {
5613.	                th.dataset.columnName = column.name;
5614.	            }
5615.	 
5616.	            const thContent = document.createElement('div');
5617.	            thContent.className = 'th-content';
5618.	 
5619.	            const thMain = document.createElement('div');
5620.	            thMain.className = 'th-main';
5621.	 
5622.	            const thTitle = document.createElement('div');
5623.	            thTitle.className = 'th-title';
5624.	            thTitle.textContent = column.name;
5625.	 
5626.	            if (currentSort.column === column.id) {
5627.	                thTitle.classList.add(`sort-${currentSort.direction}`);
5628.	                const sortIndicator = document.createElement('span');
5629.	                sortIndicator.className = 'sort-indicator';
5630.	                thTitle.appendChild(sortIndicator);
5631.	            }
5632.	 
5633.	            const filterControls = document.createElement('div');
5634.	            filterControls.className = 'filter-controls';
5635.	 
5636.	            const sortBtn = document.createElement('button');
5637.	            sortBtn.className = 'sort-btn';
5638.	            sortBtn.innerHTML = '↕';
5639.	            sortBtn.title = 'Сортировка';
5640.	            sortBtn.onclick = (e) => {
5641.	                e.stopPropagation();
5642.	                handleSort(column.id);
5643.	            };
5644.	 
5645.	            const filterBtn = document.createElement('button');
5646.	            filterBtn.className = 'filter-btn';
5647.	            filterBtn.innerHTML = '⌕';
5648.	            filterBtn.title = 'Фильтр';
5649.	 
5650.	            if (currentFilters[column.id]) {
5651.	                filterBtn.classList.add('filtered');
5652.	            }
5653.	 
5654.	            filterBtn.onclick = (e) => {
5655.	                e.stopPropagation();
5656.	                toggleFilter(column.id, filterBtn, th);
5657.	            };
5658.	 
5659.	            filterControls.appendChild(sortBtn);
5660.	            filterControls.appendChild(filterBtn);
5661.	 
5662.	            thMain.appendChild(thTitle);
5663.	            thMain.appendChild(filterControls);
5664.	            thContent.appendChild(thMain);
5665.	            th.appendChild(thContent);
5666.	 
5667.	            if (currentUser && currentUser.role === 'admin' && (type === 'custom' || column.editable)) {
5668.	                th.classList.add('editable-header');
5669.	                th.style.cursor = 'pointer';
5670.	                th.addEventListener('click', (e) => {
5671.	                    if (!e.target.closest('.filter-controls')) {
5672.	                        e.stopPropagation();
5673.	                        openEditHeaderModal(th);
5674.	                    }
5675.	                });
5676.	            }
5677.	 
5678.	            return th;
5679.	        }
5680.	
5681.	        // ПОЛНОСТЬЮ ПЕРЕРАБОТАННАЯ ФУНКЦИЯ СОЗДАНИЯ ЯЧЕЙКИ ДАННЫХ
5682.	        function createDataCell(rowData, column, type) {
5683.	            const td = document.createElement('td');
5684.	 
5685.	            const isDateColumn = dateValidationColumns[column.id];
5686.	 
5687.	            td.dataset.columnId = column.id;
5688.	            td.dataset.rowId = rowData.id;
5689.	 
5690.	            if (type === 'custom') {
5691.	                td.dataset.columnName = column.name;
5692.	            }
5693.	 
5694.	            let value = '';
5695.	            if (type === 'basic') {
5696.	                switch(column.id) {
5697.	                    case 'id': value = rowData.displayId || rowData.id; break;
5698.	                    case 'name': value = rowData.name || ''; break;
5699.	                    case 'date': value = rowData.date || ''; break;
5700.	                    case 'status': value = rowData.status || ''; break;
5701.	                }
5702.	            } else {
5703.	                value = rowData.customData && rowData.customData[column.id]
5704.	                    ? rowData.customData[column.id]
5705.	                    : '';
5706.	            }
5707.	 
5708.	            const cellContent = document.createElement('div');
5709.	            cellContent.className = 'cell-content';
5710.	 
5711.	            const cellText = document.createElement('div');
5712.	            cellText.className = 'cell-text';
5713.	            cellText.textContent = value;
5714.	 
5715.	            const fileIcons = document.createElement('div');
5716.	            fileIcons.className = 'file-icons';
5717.	 
5718.	            if (rowData.attachments && rowData.attachments[column.id]) {
5719.	                addFileIconsToCell(fileIcons, rowData.attachments[column.id], rowData.id, column.id);
5720.	            }
5721.	 
5722.	            cellContent.appendChild(cellText);
5723.	            cellContent.appendChild(fileIcons);
5724.	            td.appendChild(cellContent);
5725.	 
5726.	            // Обработчики событий для ячейки
5727.	            if (currentUser && currentUser.role === 'admin') {
5728.	                if (isDateColumn) {
5729.	                    // Для ячеек с датами - специальная обработка
5730.	                    td.classList.add('date-cell');
5731.	 
5732.	                    td.addEventListener('dblclick', (e) => {
5733.	                        if (!e.target.closest('.file-icons')) {
5734.	                            openDateInput(td, value);
5735.	                        }
5736.	                    });
5737.	 
5738.	                    td.addEventListener('click', (e) => {
5739.	                        if (!e.target.closest('.file-icons') && !e.target.closest('.date-input-overlay')) {
5740.	                            openDatePicker(td, value);
5741.	                        }
5742.	                    });
5743.	 
5744.	                    if (value && isValidDate(value)) {
5745.	                        const today = new Date();
5746.	                        today.setHours(0, 0, 0, 0);
5747.	                        const cellDate = parseDate(value);
5748.	                        const timeDiff = cellDate.getTime() - today.getTime();
5749.	                        const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
5750.	 
5751.	                        if (daysDiff < 0) {
5752.	                            td.classList.add('date-cell-danger');
5753.	                        } else if (daysDiff <= 30) {
5754.	                            td.classList.add('date-cell-warning');
5755.	                        } else {
5756.	                            td.classList.remove('date-cell-warning', 'date-cell-danger');
5757.	                        }
5758.	                    }
5759.	                } else {
5760.	                    // Для обычных текстовых ячеек - новый алгоритм
5761.	                    let clickTimer = null;
5762.	                    let isEditing = false;
5763.	 
5764.	                    // Одинарный клик - редактирование текста
5765.	                    td.addEventListener('click', (e) => {
5766.	                        if (e.target.closest('.file-icons') || isEditing) return;
5767.	 
5768.	                        if (clickTimer) {
5769.	                            clearTimeout(clickTimer);
5770.	                            clickTimer = null;
5771.	                            return;
5772.	                        }
5773.	 
5774.	                        clickTimer = setTimeout(() => {
5775.	                            // Одинарный клик - редактирование текста
5776.	                            startTextEditing(td, rowData, column, type, value);
5777.	                            isEditing = true;
5778.	                            clickTimer = null;
5779.	                        }, 300);
5780.	                    });
5781.	 
5782.	                    // Двойной клик - открытие модального окна для файлов
5783.	                    td.addEventListener('dblclick', (e) => {
5784.	                        if (e.target.closest('.file-icons') || isEditing) return;
5785.	 
5786.	                        if (clickTimer) {
5787.	                            clearTimeout(clickTimer);
5788.	                            clickTimer = null;
5789.	                        }
5790.	 
5791.	                        // Двойной клик - открытие модального окна для файлов
5792.	                        openFileManagementModal(rowData.id, column.id);
5793.	                    });
5794.	 
5795.	                    // Добавляем визуальный курсор для указания возможности редактирования
5796.	                    td.style.cursor = 'text';
5797.	                }
5798.	            }
5799.	 
5800.	            return td;
5801.	        }
5802.	
5803.	        // НОВАЯ ФУНКЦИЯ ДЛЯ РЕДАКТИРОВАНИЯ ТЕКСТА
5804.	        function startTextEditing(cell, rowData, column, type, currentValue) {
5805.	            const originalContent = cell.innerHTML;
5806.	 
5807.	            // Создаем input для редактирования
5808.	            const input = document.createElement('input');
5809.	            input.type = 'text';
5810.	            input.value = currentValue || '';
5811.	            input.style.width = '100%';
5812.	            input.style.height = '100%';
5813.	            input.style.border = '2px solid var(--accent-color)';
5814.	            input.style.background = 'var(--bg-primary)';
5815.	            input.style.color = 'var(--text-primary)';
5816.	            input.style.padding = '4px';
5817.	            input.style.borderRadius = '4px';
5818.	            input.style.outline = 'none';
5819.	            input.className = 'cell-input';
5820.	 
5821.	            // Заменяем содержимое ячейки на input
5822.	            cell.innerHTML = '';
5823.	            cell.appendChild(input);
5824.	            input.focus();
5825.	            input.select();
5826.	 
5827.	            // Функция сохранения
5828.	            const saveChanges = () => {
5829.	                const newValue = input.value.trim();
5830.	 
5831.	                if (type === 'basic') {
5832.	                    switch(column.id) {
5833.	                        case 'name': rowData.name = newValue; break;
5834.	                        case 'status': rowData.status = newValue; break;
5835.	                        default:
5836.	                            if (column.editable) {
5837.	                                rowData[column.id] = newValue;
5838.	                            }
5839.	                    }
5840.	                } else {
5841.	                    if (!rowData.customData) rowData.customData = {};
5842.	                    rowData.customData[column.id] = newValue;
5843.	                }
5844.	 
5845.	                const currentTab = tabs.find(tab => tab.id === currentTabId);
5846.	                if (currentTab) {
5847.	                    currentTab.data = JSON.parse(JSON.stringify(tableData));
5848.	                }
5849.	 
5850.	                storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5851.	                autoSyncChanges();
5852.	 
5853.	                // Восстанавливаем ячейку с новым значением
5854.	                renderTable();
5855.	            };
5856.	 
5857.	            // Обработчики для input
5858.	            input.addEventListener('keydown', function(e) {
5859.	                if (e.key === 'Enter') {
5860.	                    saveChanges();
5861.	                } else if (e.key === 'Escape') {
5862.	                    // Отмена редактирования - восстанавливаем оригинальное содержимое
5863.	                    cell.innerHTML = originalContent;
5864.	                }
5865.	            });
5866.	 
5867.	            input.addEventListener('blur', function() {
5868.	                setTimeout(() => {
5869.	                    if (document.activeElement !== input) {
5870.	                        saveChanges();
5871.	                    }
5872.	                }, 100);
5873.	            });
5874.	        }
5875.	
5876.	        function addFileIconsToCell(container, files, rowId, columnId) {
5877.	            files.forEach((file, index) => {
5878.	                const fileIcon = document.createElement('div');
5879.	                fileIcon.className = 'file-icon-small';
5880.	 
5881.	                let icon = '📄';
5882.	                if (file.type.startsWith('image/')) {
5883.	                    icon = '🖼';
5884.	                } else if (file.type.includes('pdf')) {
5885.	                    icon = '📕';
5886.	                } else if (file.type.includes('word') || file.type.includes('document')) {
5887.	                    icon = '📝';
5888.	                } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) {
5889.	                    icon = '📊';
5890.	                } else if (file.type.includes('text')) {
5891.	                    icon = '📃';
5892.	                }
5893.	 
5894.	                fileIcon.innerHTML = icon;
5895.	                fileIcon.title = file.name;
5896.	 
5897.	                fileIcon.addEventListener('click', (e) => {
5898.	                    e.stopPropagation();
5899.	                    if (currentUser && currentUser.role === 'admin') {
5900.	                        openFileManagementModal(rowId, columnId);
5901.	                    } else {
5902.	                        openFilePreview(file, rowId, columnId, index);
5903.	                    }
5904.	                });
5905.	 
5906.	                container.appendChild(fileIcon);
5907.	            });
5908.	        }
5909.	
5910.	        // ОБНОВЛЕННАЯ ФУНКЦИЯ УДАЛЕНИЯ СТРОКИ
5911.	        function deleteRow(rowId) {
5912.	            if (!confirm('Вы уверены, что хотите удалить эту строку?')) {
5913.	                return;
5914.	            }
5915.	 
5916.	            tableData = tableData.filter(row => row.id !== rowId);
5917.	 
5918.	            tableData.forEach((row, index) => {
5919.	                row.displayId = index + 1;
5920.	            });
5921.	 
5922.	            selectedRows.delete(rowId);
5923.	 
5924.	            const currentTab = tabs.find(tab => tab.id === currentTabId);
5925.	            if (currentTab) {
5926.	                currentTab.data = JSON.parse(JSON.stringify(tableData));
5927.	            }
5928.	 
5929.	            storageManager.saveToLocalStorage(tableData, users, appSettings, customButtons, customColumns, basicColumns, dateValidationColumns, tabs);
5930.	            autoSyncChanges();
5931.	 
5932.	            renderTable();
5933.	        }
5934.	
5935.	        // ОБНОВЛЕННАЯ ФУНКЦИЯ ПРИМЕНЕНИЯ ФИЛЬТРОВ
5936.	        function applyFilters(data) {
5937.	            if (Object.keys(currentFilters).length === 0) return data;
5938.	 
5939.	            return data.filter(row => {
5940.	                return Object.entries(currentFilters).every(([filterType, filterValue]) => {
5941.	                    if (filterType === 'selectedRows') {
5942.	                        return filterValue.includes(row.id);
5943.	                    } else {
5944.	                        let value;
5945.	 
5946.	                        if (customColumns.find(col => col.id === filterType)) {
5947.	                            value = row.customData && row.customData[filterType] ? row.customData[filterType] : '';
5948.	                        } else {
5949.	                            switch(filterType) {
5950.	                                case 'id': value = row.id.toString(); break;
5951.	                                case 'name': value = row.name || ''; break;
5952.	                                case 'date': value = row.date || ''; break;
5953.	                                case 'status': value = row.status || ''; break;
5954.	                                default: value = '';
5955.	                            }
5956.	                        }
5957.	 
5958.	                        return filterValue.includes(value);
5959.	                    }
5960.	                });
5961.	            });
5962.	        }
5963.	    </script>
5964.	</body>
5965.	</html>
